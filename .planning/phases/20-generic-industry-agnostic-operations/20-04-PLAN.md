---
phase: 20-generic-industry-agnostic-operations
plan: 04
type: execute
wave: 2
depends_on: ["20-01"]
files_modified: [src/features/export/business-plan-view.tsx, src/features/export/pdf/BusinessPlanDocument.tsx, src/features/sections/operations/normalize.test.ts, src/features/sections/operations/compute.test.ts]
autonomous: true
---

<objective>
Update web and PDF export for the new Operations model, and add tests for normalization and computation functions.

Purpose: Export renders the generic Operations data (workforce, capacity, costItems, operationalMetrics) instead of the old event-specific fields. Tests verify migration correctness and cost calculation accuracy.
Output: Updated export files + test files for normalize and compute functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-generic-industry-agnostic-operations/20-CONTEXT.md
@.planning/phases/20-generic-industry-agnostic-operations/20-01-SUMMARY.md

@src/features/export/business-plan-view.tsx
@src/features/export/pdf/BusinessPlanDocument.tsx
@src/features/sections/operations/normalize.ts
@src/features/sections/operations/compute.ts
@src/features/sections/product-service/normalize.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update web and PDF export for new Operations model</name>
  <files>src/features/export/business-plan-view.tsx, src/features/export/pdf/BusinessPlanDocument.tsx</files>
  <action>
  **Web export (`business-plan-view.tsx`):**

  1. Import `normalizeOperations` from `@/features/sections/operations/normalize`
  2. Import `computeOperationsCosts` from `@/features/sections/operations/compute`
  3. Import new types: `Operations, WorkforceMember, CostItem, OperationalMetric` from `@/types`
  4. Remove old `CrewMember` import if present
  5. Remove the inline `defaultOperations` constant (which has old CostBreakdown fields)
  6. At the point where operations data is used, normalize it: `const ops = normalizeOperations(operationsRaw);`
  7. Compute costs: `const costSummary = computeOperationsCosts(ops);`

  Replace the Operations section rendering:

  **Workforce table** (was "crew" table):
  - Header: Role / Rate/Hour / Count
  - Rows from `ops.workforce`
  - Only show if `ops.workforce.length > 0`

  **Capacity stats** (replaces old maxBookings cards):
  - Show: Output Unit, Planned/Month, Max/Day, Max/Week, Max/Month, Utilization Rate
  - Use `ops.capacity`
  - Only show capacity block if `ops.capacity.plannedOutputPerMonth > 0`

  **Cost Summary** (NEW — old export didn't show costs):
  - Show 4 stat cards: Variable Costs/mo, Fixed Costs/mo, Workforce/mo, Total Operations/mo
  - From `costSummary`
  - Only show if `costSummary.monthlyOperationsTotal > 0`

  **Cost Items table** (NEW):
  - Show all costItems in a table: Category / Type / Rate / Driver / Monthly
  - Group or just list all items
  - Only show if `ops.costItems.length > 0`

  **Operational Metrics** (NEW):
  - Show as cards or table: Name / Value (unit) / Target (unit)
  - Only show if `ops.operationalMetrics.length > 0`

  **Equipment + Safety** — keep same pattern (bullet list, numbered list).

  **PDF export (`BusinessPlanDocument.tsx`):**

  Same changes as web export but using react-pdf components (View, Text, etc.):

  1. Import `normalizeOperations` and `computeOperationsCosts`
  2. Import new types
  3. Remove old defaultOperations
  4. Normalize operations data at usage point
  5. Render: Workforce table, Capacity stats, Cost summary, Cost items, Operational metrics, Equipment, Safety protocols

  Follow existing PDF patterns (Table/Row/Cell components used elsewhere in the file). Match styling of other PDF sections.

  **Remove all event-specific references:** No "maxBookingsPerDay", no "travelRadius", no "hoursPerEvent", no "CostBreakdown" in either export file.
  </action>
  <verify>`npx vite build 2>&1 | tail -5` — build succeeds</verify>
  <done>
  - Web export renders: workforce, capacity, cost summary, cost items, operational metrics, equipment, safety
  - PDF export renders same structure
  - Old event-specific rendering removed
  - normalizeOperations called at read boundary in both exports
  - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for normalizeOperations and computeOperationsCosts</name>
  <files>src/features/sections/operations/normalize.test.ts, src/features/sections/operations/compute.test.ts</files>
  <action>
  Follow the pattern from `src/features/sections/product-service/normalize.test.ts`.

  **`normalize.test.ts`:**

  ```ts
  import { describe, it, expect } from 'vitest';
  import { normalizeOperations } from './normalize';

  describe('normalizeOperations', () => {
    it('returns default for null/undefined/empty input', () => { ... });

    it('passes through new format data', () => {
      // Input with workforce, costItems, operationalMetrics
      // Verify output matches input
    });

    it('migrates legacy crew to workforce', () => {
      // Input with old crew[]: { role, hourlyRate, count }
      // Verify output workforce[]: { role, ratePerHour: hourlyRate, count }
    });

    it('migrates legacy capacity fields', () => {
      // Input with old capacity: { maxBookingsPerDay, maxBookingsPerWeek, maxBookingsPerMonth }
      // Verify output capacity has outputUnitLabel: 'bookings', new field names
    });

    it('migrates legacy costBreakdown variable costs to costItems', () => {
      // Input with old costBreakdown: { suppliesPerChild: 5, participantsPerEvent: 20, museumTicketPrice: 10, ticketsPerEvent: 20 }
      // Verify output has variable CostItems for Supplies, Venue / Tickets
    });

    it('migrates legacy costBreakdown fixed costs to costItems', () => {
      // Input with old costBreakdown: { ownerSalary: 4000, crmSoftware: 50, storageRent: 200 }
      // Verify output has fixed CostItems with monthly driverType
    });

    it('migrates legacy customExpenses to costItems', () => {
      // Input with customExpenses: [{ name: 'Custom', amount: 100, type: 'per-event' }]
      // Verify output maps to variable costItem
    });

    it('preserves equipment and safetyProtocols', () => { ... });

    it('adds empty operationalMetrics for legacy data', () => { ... });
  });
  ```

  **`compute.test.ts`:**

  ```ts
  import { describe, it, expect } from 'vitest';
  import { computeOperationsCosts } from './compute';
  import type { Operations } from '@/types';

  describe('computeOperationsCosts', () => {
    it('returns zeros for empty operations', () => {
      const ops: Operations = {
        workforce: [],
        capacity: { outputUnitLabel: '', plannedOutputPerMonth: 0, maxOutputPerDay: 0, maxOutputPerWeek: 0, maxOutputPerMonth: 0, utilizationRate: 0 },
        costItems: [],
        equipment: [],
        safetyProtocols: [],
        operationalMetrics: [],
      };
      const result = computeOperationsCosts(ops);
      expect(result.variableMonthlyTotal).toBe(0);
      expect(result.fixedMonthlyTotal).toBe(0);
      expect(result.monthlyOperationsTotal).toBe(0);
      expect(result.variableCostPerOutput).toBe(0);
    });

    it('sums variable costs correctly', () => {
      // 2 variable items, verify sum = rate1 * qty1 + rate2 * qty2
    });

    it('sums fixed costs with monthly normalization', () => {
      // monthly item + quarterly item + yearly item
      // quarterly should be divided by 3, yearly by 12
    });

    it('computes workforce monthly total', () => {
      // 2 workers, verify = ratePerHour * count * 160 for each
    });

    it('computes variableCostPerOutput correctly', () => {
      // With plannedOutputPerMonth = 100 and variableMonthlyTotal = 500
      // variableCostPerOutput should be 5
    });

    it('returns 0 variableCostPerOutput when plannedOutputPerMonth is 0', () => { ... });
  });
  ```

  Run tests: `npx vitest run` — all tests should pass (old tests + new ones).
  </action>
  <verify>
  1. `npx vitest run 2>&1 | tail -10` — all tests pass
  2. `npm run lint 2>&1 | tail -10` — no lint errors
  3. `npx vite build 2>&1 | tail -5` — build succeeds
  </verify>
  <done>
  - normalize.test.ts: 8+ tests covering null input, new format passthrough, legacy crew/capacity/costBreakdown/customExpenses migration
  - compute.test.ts: 6+ tests covering empty ops, variable sums, fixed normalization, workforce total, variableCostPerOutput
  - All tests pass alongside existing test suite (65+ existing)
  - Full build, lint, test verification passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vite build` succeeds
- [ ] `npx vitest run` — all tests pass (existing + new)
- [ ] `npm run lint` — no errors
- [ ] Web export renders new Operations structure
- [ ] PDF export renders new Operations structure
- [ ] No event-specific terminology in export files
- [ ] normalizeOperations tests cover legacy migration
- [ ] computeOperationsCosts tests cover all calculation paths
</verification>

<success_criteria>

- Export (web + PDF) uses generic Operations structure
- Cost data now visible in exports (was omitted before)
- Operational metrics now visible in exports
- normalizeOperations fully tested for backward compat
- computeOperationsCosts fully tested for accuracy
- All tests pass, lint clean, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/20-generic-industry-agnostic-operations/20-04-SUMMARY.md`
</output>
