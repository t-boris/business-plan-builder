---
phase: 20-generic-industry-agnostic-operations
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified: [src/features/sections/operations/index.tsx]
autonomous: true
---

<objective>
Rewrite the Operations section editor with a tabbed/sectioned UI using the new generic data model.

Purpose: Replace the 603-line event-specific Operations editor with a universal, industry-agnostic editor organized into collapsible sections: Team, Capacity, Variable Costs, Fixed Costs, Equipment, Safety, Operational Metrics.
Output: Fully rewritten operations/index.tsx with no event-specific terminology.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-generic-industry-agnostic-operations/20-CONTEXT.md
@.planning/phases/20-generic-industry-agnostic-operations/20-01-SUMMARY.md

@src/features/sections/operations/index.tsx
@src/features/sections/operations/normalize.ts
@src/features/sections/operations/compute.ts
@src/features/sections/product-service/index.tsx
@src/components/ai-field-trigger.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite operations/index.tsx with tabbed/sectioned generic editor</name>
  <files>src/features/sections/operations/index.tsx</files>
  <action>
  Completely rewrite the Operations section editor. Remove ALL old event-specific code. Use the new types from Plan 01.

  **Imports:**
  - Import `Operations, WorkforceMember, CostItem, CostDriverType, OperationalMetric` from `@/types`
  - Import `normalizeOperations` from `./normalize`
  - Import `computeOperationsCosts` from `./compute`
  - Import `AiFieldTrigger` from `@/components/ai-field-trigger`
  - Import `Collapsible, CollapsibleTrigger, CollapsibleContent` from `@/components/ui/collapsible`
  - Keep existing imports for `useSection`, `useAiSuggestion`, `AiActionBar`, `AiSuggestionPreview`, `PageHeader`, `EmptyState`, `Input`, `Textarea`, `Button`, `Card`, `Select`, `Tooltip`, icons

  **Normalization on mount** (same pattern as product-service):
  ```tsx
  const [normalized, setNormalized] = useState(false);
  useEffect(() => {
    if (!isLoading && !normalized) {
      const norm = normalizeOperations(rawData);
      if (JSON.stringify(norm) !== JSON.stringify(rawData)) {
        updateData(() => norm);
      }
      setNormalized(true);
    }
  }, [isLoading, normalized, rawData, updateData]);
  ```

  **Section structure** (collapsible sections, all open by default):

  1. **Summary stat cards row** (4 cards):
     - Variable Costs/mo → `summary.variableMonthlyTotal`
     - Fixed Costs/mo → `summary.fixedMonthlyTotal`
     - Team Costs/mo → `summary.workforceMonthlyTotal`
     - Total Operations/mo → `summary.monthlyOperationsTotal`
     Use `computeOperationsCosts(data)` for all values. Format with `$` and comma separators.

  2. **Team section** (collapsible):
     - Table: Role (Input), Count (number Input), Rate/Hour (number Input with $ prefix)
     - Add/remove workforce members
     - Empty state when no team members

  3. **Capacity section** (collapsible):
     - Output Unit Label (Input, placeholder "units / bookings / orders")
     - Planned Output/Month (number Input)
     - Max Output: Per Day, Per Week, Per Month (3 number Inputs in grid)
     - Utilization Rate (number Input with % suffix, 0-100)
     - If `variableCostPerOutput > 0`, show a derived stat: "Variable Cost per {outputUnitLabel || 'unit'}: $X.XX"

  4. **Variable Costs section** (collapsible):
     - List of CostItems where `type === 'variable'`
     - Each item: Category (Input), Rate (number Input $), Driver Type (Select with options: per-unit, per-order, per-service-hour, per-machine-hour, monthly, quarterly, yearly), Driver Qty/Month (number Input)
     - Computed: Monthly = rate × driverQuantityPerMonth (shown as read-only)
     - Add/remove variable cost items
     - Subtotal row

  5. **Fixed Costs section** (collapsible):
     - Same layout as Variable Costs but for `type === 'fixed'`
     - Monthly normalization shown for quarterly/yearly items
     - Add/remove fixed cost items
     - Subtotal row

  6. **Equipment section** (collapsible):
     - Free text string list (add/remove), same as current

  7. **Safety Protocols section** (collapsible):
     - Numbered list of strings (add/remove), same as current

  8. **Operational Metrics section** (collapsible):
     - Table/cards: Name (Input), Unit (Input, placeholder "%, units, hours"), Value (number Input), Target (number Input)
     - Add/remove metrics
     - Empty state suggesting examples: "e.g., Yield Rate, Scrap Rate, OEE, Utilization"

  **Helper functions:**
  - `addWorkforceMember()` — pushes `{ role: '', count: 1, ratePerHour: 0 }`
  - `removeWorkforceMember(index)` — splices
  - `updateWorkforceMember(index, field, value)` — updates in-place
  - `addCostItem(type: 'variable' | 'fixed')` — pushes `{ category: '', type, rate: 0, driverType: 'monthly', driverQuantityPerMonth: 1 }`
  - `removeCostItem(index)` — splices from full costItems array (compute real index)
  - `updateCostItem(index, field, value)` — updates
  - `addMetric()` — pushes `{ name: '', unit: '', value: 0, target: 0 }`
  - `removeMetric(index)` — splices
  - `updateMetric(index, field, value)` — updates

  All updates use `updateData((prev) => ({ ...prev, ... }))` pattern.

  **Driver Type Select** — use the existing Select component:
  ```tsx
  const DRIVER_TYPE_OPTIONS: { value: CostDriverType; label: string }[] = [
    { value: 'per-unit', label: 'Per Unit' },
    { value: 'per-order', label: 'Per Order' },
    { value: 'per-service-hour', label: 'Per Service Hour' },
    { value: 'per-machine-hour', label: 'Per Machine Hour' },
    { value: 'monthly', label: 'Monthly' },
    { value: 'quarterly', label: 'Quarterly' },
    { value: 'yearly', label: 'Yearly' },
  ];
  ```

  **Collapsible sections** — use `Collapsible` from shadcn with default open:
  ```tsx
  <Collapsible defaultOpen>
    <CollapsibleTrigger asChild>
      <button className="flex items-center gap-2 ...">
        <ChevronDown className="size-4 transition-transform" />
        <span>Section Title</span>
      </button>
    </CollapsibleTrigger>
    <CollapsibleContent>
      ...
    </CollapsibleContent>
  </Collapsible>
  ```

  If Collapsible from shadcn is not available, check what's in `src/components/ui/`. If not present, use a simple `details/summary` HTML pattern or a `useState`-based toggle instead. Do NOT add new shadcn components.

  **No conditional business-type rendering.** Every business sees the exact same form. No `if (businessType === 'manufacturing')`. No event-specific labels.

  **AI integration:**
  - Keep existing `useAiSuggestion<Operations>('operations')` pattern
  - Keep `AiActionBar` for whole-tab AI
  - Keep `AiSuggestionPreview` overlay
  - Keep `canEdit` / `isPreview` guards
  </action>
  <verify>`npx vite build 2>&1 | tail -5` — build succeeds</verify>
  <done>
  - Operations editor fully rewritten with generic model
  - 8 collapsible sections: Summary, Team, Capacity, Variable Costs, Fixed Costs, Equipment, Safety, Operational Metrics
  - No event-specific terminology anywhere
  - No business-type conditional rendering
  - Normalization on mount for backward compat
  - Live computed cost summaries
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AiFieldTrigger into Operations textarea fields</name>
  <files>src/features/sections/operations/index.tsx</files>
  <action>
  Following the Phase 19 pattern, add `AiFieldTrigger` to eligible text fields in the Operations editor. Only add to Textarea fields that benefit from AI generation (descriptions, narratives), NOT to short Inputs (names, numbers).

  Currently the new Operations model doesn't have rich-text fields. But if there's a description/narrative Textarea added to any section (e.g., an operational overview), add the trigger there.

  If no Textarea fields exist (the new model is mostly numbers and short inputs), skip this and note in the summary that Operations has no eligible AI field triggers — which is correct since its data is primarily quantitative.

  Also verify the whole-tab AI still works: AiActionBar + useAiSuggestion should continue to function for generating the full Operations section.
  </action>
  <verify>`npx vite build 2>&1 | tail -5` — build succeeds</verify>
  <done>
  - AiFieldTrigger added to any Textarea fields (or documented that none exist)
  - Whole-tab AI (AiActionBar) still functional
  - Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vite build` succeeds without errors
- [ ] Operations editor shows all 8 sections
- [ ] No event-specific terminology in the editor
- [ ] No business-type conditional renders
- [ ] Normalization fires on mount for legacy data
- [ ] Cost summaries compute correctly from costItems
- [ ] AI action bar works (Generate/Improve/Expand)
</verification>

<success_criteria>

- Operations editor is fully industry-agnostic
- All data entry uses generic fields (workforce, capacity, costItems, operationalMetrics)
- Live cost summaries derived from costItems
- Backward compat via normalizeOperations on mount
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-generic-industry-agnostic-operations/20-02-SUMMARY.md`
</output>
