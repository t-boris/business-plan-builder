---
phase: 16-ai-backend-proxy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [functions/package.json, functions/tsconfig.json, functions/src/index.ts, firebase.json, .firebaserc]
autonomous: true
---

<objective>
Create Firebase Functions project with 3 proxy endpoints for AI APIs (Gemini generate, Gemini structured, Perplexity search). Include auth verification, per-user rate limiting, and request timeouts.

Purpose: Move AI API keys server-side so they are never exposed in the client bundle.
Output: functions/ directory with working proxy endpoints, firebase.json updated with functions config.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/lib/ai/gemini-client.ts
@src/lib/ai/perplexity-client.ts
@firebase.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Firebase Functions project</name>
  <files>functions/package.json, functions/tsconfig.json, functions/.gitignore</files>
  <action>
Create the `functions/` directory with a minimal TypeScript setup:

1. Create `functions/package.json`:
```json
{
  "name": "my-business-planning-functions",
  "private": true,
  "type": "module",
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch"
  },
  "engines": {
    "node": "20"
  },
  "main": "lib/index.js",
  "dependencies": {
    "firebase-admin": "^13.0.0",
    "firebase-functions": "^6.0.0",
    "@google/genai": "^1.40.0"
  },
  "devDependencies": {
    "typescript": "~5.9.0"
  }
}
```

2. Create `functions/tsconfig.json`:
```json
{
  "compilerOptions": {
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "target": "ES2022",
    "outDir": "lib",
    "rootDir": "src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "declaration": true,
    "sourceMap": true
  },
  "include": ["src/**/*"]
}
```

3. Create `functions/.gitignore`:
```
lib/
node_modules/
```

4. Run `cd functions && npm install` to install dependencies.

5. Update root `.gitignore` to include `functions/lib/`.

6. Update `firebase.json` to add functions config:
```json
{
  "hosting": { ... },
  "firestore": { ... },
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "runtime": "nodejs20"
    }
  ],
  "emulators": {
    "firestore": { "port": 8080 },
    "functions": { "port": 5001 },
    "ui": { "enabled": true }
  }
}
```

7. Update the root `emulator` npm script to include functions:
```
"emulator": "firebase emulators:start --only firestore,functions --import=./emulator-data --export-on-exit=./emulator-data"
```
  </action>
  <verify>cd functions && npm run build succeeds with no errors. firebase.json is valid JSON.</verify>
  <done>Firebase Functions project initialized with TypeScript, deps installed, firebase.json updated.</done>
</task>

<task type="auto">
  <name>Task 2: Create proxy endpoints with auth and rate limiting</name>
  <files>functions/src/index.ts</files>
  <action>
Create `functions/src/index.ts` with 3 Cloud Functions (v2 onRequest):

**Shared middleware:**

1. **Auth verification**: Extract `Authorization: Bearer <token>` header, verify with `admin.auth().verifyIdToken(token)`. Return 401 if missing/invalid.

2. **Rate limiting**: Simple in-memory Map keyed by UID. Allow 30 requests per minute per user. Return 429 if exceeded. Reset counts every 60 seconds using setInterval.

3. **CORS**: Allow the Firebase Hosting origin and localhost:5173 for dev. Use `cors: true` in onRequest options or handle manually.

4. **Request timeout**: Set `timeoutSeconds: 120` in function options (Gemini can be slow).

**Endpoints:**

**POST /aiGeminiGenerate**
- Body: `{ prompt: string, systemInstruction: string }`
- Calls Gemini `generateContent` with free-text config (same params as current gemini-client.ts)
- Returns: `{ text: string }`

**POST /aiGeminiStructured**
- Body: `{ prompt: string, systemInstruction: string, jsonSchema: object }`
- Calls Gemini `generateContent` with JSON response config
- Returns: `{ data: object }` (the parsed JSON)

**POST /aiPerplexitySearch**
- Body: `{ query: string }`
- Calls Perplexity API via fetch (same as current perplexity-client.ts)
- Returns: `{ content: string, citations: string[] }`

**Secrets management:**
- Use `defineSecret` from `firebase-functions/params` for `GEMINI_API_KEY` and `PERPLEXITY_API_KEY`
- Or read from `process.env` and set via `firebase functions:secrets:set` later
- For local dev, create `functions/.secret.local` with the keys (add to .gitignore)

**Error handling:**
- Catch Gemini 429 errors → return 429 to client
- Catch all other errors → return 500 with sanitized error message
- Log errors using console.error (Cloud Functions logging)

Notes:
- Use Firebase Functions v2 (`firebase-functions/v2/https`) for better cold start and secrets support
- The `@google/genai` package is the same one used in the frontend — same API
- For Perplexity, use native `fetch` (available in Node 20)
  </action>
  <verify>cd functions && npm run build succeeds. The file exports 3 functions.</verify>
  <done>3 proxy endpoints created with auth verification, rate limiting, and proper error handling.</done>
</task>

<task type="auto">
  <name>Task 3: Create local secrets file and verify with emulator</name>
  <files>functions/.secret.local</files>
  <action>
1. Create `functions/.secret.local` with placeholder structure:
```
GEMINI_API_KEY=your-key-here
PERPLEXITY_API_KEY=your-key-here
```

2. Add `functions/.secret.local` to root `.gitignore` and `functions/.gitignore`.

3. Check if the user has a `.env` file with the actual keys. If so, read the VITE_GEMINI_API_KEY and VITE_PERPLEXITY_API_KEY values and use them to populate `.secret.local` (without the VITE_ prefix).

4. Verify the functions build: `cd functions && npm run build`

5. Do NOT start the emulator (it would block) — just verify the build passes.
  </action>
  <verify>functions/.secret.local exists (in .gitignore). cd functions && npm run build passes.</verify>
  <done>Local secrets configured. Functions build successfully.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] functions/ directory exists with package.json, tsconfig.json, src/index.ts
- [ ] `cd functions && npm run build` passes
- [ ] firebase.json includes functions config and functions emulator
- [ ] 3 proxy endpoints exported (aiGeminiGenerate, aiGeminiStructured, aiPerplexitySearch)
- [ ] Auth verification in place
- [ ] Rate limiting in place
- [ ] .secret.local in .gitignore
</verification>

<success_criteria>

- Firebase Functions project created and building
- 3 proxy endpoints for Gemini (generate + structured) and Perplexity (search)
- Auth token verification on all endpoints
- Per-user rate limiting (30 req/min)
- firebase.json updated with functions + emulator config
- Secrets management configured for local dev
</success_criteria>

<output>
After completion, create `.planning/phases/16-ai-backend-proxy/16-01-SUMMARY.md`
</output>
