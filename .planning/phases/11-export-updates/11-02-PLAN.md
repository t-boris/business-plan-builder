---
phase: 11-export-updates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/features/export/index.tsx, src/features/export/pdf/BusinessPlanDocument.tsx, src/features/export/pdf/CoverPage.tsx, src/features/export/pdf/generatePdf.ts]
autonomous: true
---

<objective>
Fix PDF export for generic multi-business platform.

Purpose: The PDF export hardcodes all 9 sections, uses Fun Box-specific metrics, and lacks business identity. It needs dynamic sections, dynamic KPIs from evaluated values, and the business name/currency throughout.
Output: A PDF export that generates a professional document for any business type.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/features/export/index.tsx
@src/features/export/pdf/BusinessPlanDocument.tsx
@src/features/export/pdf/CoverPage.tsx
@src/features/export/pdf/generatePdf.ts
@src/features/export/pdf/pdfStyles.ts
@src/features/export/pdf/SectionPage.tsx
@src/store/business-atoms.ts
@src/store/derived-atoms.ts
@src/lib/constants.ts
@src/types/business.ts
@src/types/plan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dynamic PDF document with business-aware sections and cover page</name>
  <files>src/features/export/pdf/BusinessPlanDocument.tsx, src/features/export/pdf/CoverPage.tsx, src/features/export/pdf/generatePdf.ts</files>
  <action>
  **1. Update GeneratePdfParams in generatePdf.ts:**

  Add business-aware fields to the params:
  ```typescript
  export interface GeneratePdfParams {
    sections: {
      execSummary: ExecutiveSummary;
      marketAnalysis: MarketAnalysis;
      productService: ProductService;
      marketingStrategy: MarketingStrategy;
      operations: Operations;
      financials: FinancialProjections;
      risks: RisksDueDiligence;
      kpis: KpisMetrics;
      launchPlan: LaunchPlan;
    };
    enabledSections: string[];  // NEW: which sections to render
    scenarioMetrics: Record<string, { label: string; value: number; unit: string }>;  // NEW: dynamic KVs instead of hardcoded
    scenarioName: string;
    chartImage: string | null;
    businessName: string;       // NEW
    currencyCode: string;       // NEW
  }
  ```

  Update `generateBusinessPlanPdf` to pass new fields through to `BusinessPlanDocument`:
  ```typescript
  const doc = BusinessPlanDocument({
    ...params.sections,
    enabledSections: params.enabledSections,
    scenarioName: params.scenarioName,
    scenarioMetrics: params.scenarioMetrics,
    chartImage: params.chartImage,
    businessName: params.businessName,
    currencyCode: params.currencyCode,
  });
  ```

  **2. Update CoverPage.tsx:**

  Change the cover page to accept dynamic KPI metrics instead of hardcoded ones:

  ```typescript
  interface CoverPageProps {
    scenarioName: string;
    date: string;
    businessName: string;
    currencyCode: string;
    topMetrics: Array<{ label: string; value: string }>;  // Pre-formatted
  }
  ```

  Replace hardcoded metric cards with dynamic rendering:
  ```tsx
  <Text style={styles.coverTitle}>{businessName || 'Business Plan'}</Text>
  <View style={styles.coverAccentLine} />
  <Text style={styles.coverSubtitle}>Business Plan</Text>
  <Text style={styles.coverDate}>Generated {date}</Text>
  <Text style={styles.coverScenario}>Based on: {scenarioName}</Text>

  <View style={styles.coverMetricsRow}>
    {topMetrics.map((metric, i) => (
      <View key={i} style={styles.coverMetricCard}>
        <Text style={styles.coverMetricLabel}>{metric.label}</Text>
        <Text style={styles.coverMetricValue}>{metric.value}</Text>
      </View>
    ))}
  </View>
  ```

  Remove the local `formatCurrency` function (formatting will be done by the caller).

  **3. Update BusinessPlanDocument.tsx:**

  Add `enabledSections`, `businessName`, and `currencyCode` to `BusinessPlanDocumentProps`:

  ```typescript
  export interface BusinessPlanDocumentProps {
    execSummary: ExecutiveSummary | null;
    marketAnalysis: MarketAnalysis | null;
    productService: ProductService | null;
    marketingStrategy: MarketingStrategy | null;
    operations: Operations | null;
    financials: FinancialProjections | null;
    risks: RisksDueDiligence | null;
    kpis: KpisMetrics | null;
    launchPlan: LaunchPlan | null;
    enabledSections: string[];
    scenarioName: string;
    scenarioMetrics: Record<string, { label: string; value: number; unit: string }>;
    chartImage: string | null;
    businessName: string;
    currencyCode: string;
  }
  ```

  **Dynamic section numbering and conditional rendering:**

  Import `SECTION_SLUGS` from `@/lib/constants`. Create a filtered list:
  ```typescript
  const enabledSlugs = SECTION_SLUGS.filter((s) => enabledSections.includes(s));

  function getSectionNumber(slug: string): number {
    return enabledSlugs.indexOf(slug as any) + 1;
  }
  ```

  Wrap each `<SectionPage>` block in a conditional:
  ```tsx
  {enabledSlugs.includes('executive-summary') && (
    <SectionPage number={getSectionNumber('executive-summary')} title="Executive Summary">
      {/* ... */}
    </SectionPage>
  )}
  ```

  Apply to all 9 section pages.

  **Dynamic cover page KPIs:**

  Build `topMetrics` from `scenarioMetrics` for CoverPage (top 4 by unit priority — currency first, then percent):
  ```typescript
  const unitPriority: Record<string, number> = {
    currency: 0, percent: 1, ratio: 2, count: 3, months: 4, days: 5, hours: 6,
  };

  const topMetrics = Object.values(scenarioMetrics)
    .sort((a, b) => (unitPriority[a.unit] ?? 99) - (unitPriority[b.unit] ?? 99))
    .slice(0, 4)
    .map((m) => ({
      label: m.label,
      value: m.unit === 'currency'
        ? formatCurrency(m.value, currencyCode)
        : m.unit === 'percent'
          ? `${(m.value * 100).toFixed(1)}%`
          : String(Math.round(m.value)),
    }));
  ```

  Pass `topMetrics`, `businessName`, and `currencyCode` to CoverPage.

  **Dynamic KPI cards in Financial Projections section:**

  Replace the hardcoded 4-card grid (Monthly Revenue, Monthly Profit, etc.) with dynamic cards from `scenarioMetrics`:
  ```tsx
  <SubsectionTitle>{`Key Metrics (${scenarioName})`}</SubsectionTitle>
  <View style={styles.statCardRow}>
    {topMetrics.map((m, i) => (
      <StatCard key={i} label={m.label} value={m.value} />
    ))}
  </View>
  ```

  **Update formatCurrency in BusinessPlanDocument.tsx:**

  Accept currency code:
  ```typescript
  function formatCurrency(value: number, currency = 'USD'): string {
    try {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency, maximumFractionDigits: 0 }).format(value);
    } catch {
      return '$' + Math.round(value).toLocaleString('en-US');
    }
  }
  ```

  Pass `currencyCode` to all `formatCurrency` calls.

  **Remove legacy hardcoded patterns:**

  - Delete the old `scenarioMetrics` destructuring that used `monthlyRevenue`, `monthlyProfit`, etc.
  - Keep `sumCosts` and the Monthly P&L table for Financial Projections — this is valid section data. But make it conditional on `financials.months.length > 0`.
  - Keep Unit Economics conditional on non-zero values.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify BusinessPlanDocument accepts enabledSections and only renders matching section pages. Verify CoverPage renders dynamic metrics. Verify currency is propagated.</verify>
  <done>PDF document renders only enabled sections with dynamic numbering. Cover page shows business name and dynamic KPIs. Currency from business profile. Legacy hardcoded metric lookups removed from PDF.</done>
</task>

<task type="auto">
  <name>Task 2: Update Export page to pass business-aware data</name>
  <files>src/features/export/index.tsx</files>
  <action>
  Update the Export page (`src/features/export/index.tsx`) to supply business-aware data to the PDF generator:

  **1. Import business atoms:**

  ```typescript
  import { activeBusinessAtom, businessVariablesAtom } from '@/store/business-atoms';
  ```

  Read business data:
  ```typescript
  const business = useAtomValue(activeBusinessAtom);
  const definitions = useAtomValue(businessVariablesAtom);
  ```

  **2. Remove hardcoded metric lookups:**

  Delete the hardcoded lines:
  ```typescript
  // DELETE:
  const monthlyRevenue = evaluated['monthly_revenue'] ?? 0;
  const monthlyProfit = evaluated['monthly_profit'] ?? 0;
  const profitMargin = evaluated['profit_margin'] ?? 0;
  const monthlyBookings = evaluated['monthly_bookings'] ?? 0;
  const annualRevenue = evaluated['annual_revenue'] ?? 0;
  ```

  **3. Build dynamic scenarioMetrics for PDF:**

  Build a metrics record from computed evaluated variables:
  ```typescript
  import type { VariableUnit } from '@/types';

  const scenarioMetrics = useMemo(() => {
    if (!definitions) return {};
    const metrics: Record<string, { label: string; value: number; unit: string }> = {};
    for (const [id, def] of Object.entries(definitions)) {
      if (def.type === 'computed') {
        metrics[id] = { label: def.label, value: evaluated[id] ?? 0, unit: def.unit };
      }
    }
    return metrics;
  }, [definitions, evaluated]);
  ```

  **4. Derive business identity:**

  ```typescript
  const businessName = business?.profile.name ?? 'Business Plan';
  const currencyCode = business?.profile.currency ?? 'USD';
  const enabledSections = business?.enabledSections ?? SECTION_SLUGS;
  ```

  Import `SECTION_SLUGS` from `@/lib/constants`.

  **5. Update handleDownloadPdf:**

  Pass new fields to `generateBusinessPlanPdf`:
  ```typescript
  const blob = await generateBusinessPlanPdf({
    sections: {
      execSummary,
      marketAnalysis,
      productService,
      marketingStrategy,
      operations,
      financials,
      risks,
      kpis,
      launchPlan,
    },
    enabledSections,
    scenarioMetrics,
    scenarioName,
    chartImage,
    businessName,
    currencyCode,
  });
  ```

  **6. Update PDF filename:**

  Use business name in the filename:
  ```typescript
  const sanitizedName = businessName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  saveAs(blob, `${sanitizedName}-business-plan.pdf`);
  ```

  **7. Update the export info text:**

  Replace the hardcoded `"The PDF includes all 9 sections..."` text:
  ```tsx
  <p className="text-xs text-center text-muted-foreground">
    The PDF includes all enabled sections, financial charts, and scenario metrics.
  </p>
  ```

  Run `npm run build` to verify production build succeeds.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run build`. Verify Export page passes business name, currency, and enabled sections to PDF generator. Verify PDF filename includes business name. Verify no hardcoded metric lookups remain.</verify>
  <done>Export page passes dynamic business-aware data to PDF generator. PDF filename includes business name. No hardcoded metrics. Build passes.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] CoverPage shows business name as title
- [ ] CoverPage renders dynamic KPIs from evaluated variables (not hardcoded)
- [ ] BusinessPlanDocument only renders sections in enabledSections
- [ ] Section numbering in PDF is dynamic
- [ ] Currency from business profile used in all PDF formatCurrency calls
- [ ] Export page passes enabledSections, scenarioMetrics, businessName, currencyCode
- [ ] PDF filename includes business name
- [ ] No hardcoded `monthly_revenue` / `monthly_profit` lookups remain in export files
</verification>

<success_criteria>

- PDF export adapts to any business's enabled sections
- Cover page shows business name and dynamic KPIs
- Financial metrics in PDF are dynamic, not hardcoded
- Business identity (name, currency) reflected in PDF
- PDF filename personalized with business name
- Full TypeScript compilation and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-export-updates/11-02-SUMMARY.md`
</output>
