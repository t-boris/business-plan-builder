---
phase: 11-export-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/features/export/business-plan-view.tsx]
autonomous: true
---

<objective>
Make the business plan web view dynamic and business-aware.

Purpose: The read-only business plan view currently hardcodes all 9 sections, uses Fun Box-specific metric names, and lacks business identity. It needs to render only enabled sections, display dynamic KPIs from evaluated variables, and show the business name/currency.
Output: A generic business plan view that adapts to any business type's enabled sections and variable set.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/features/export/business-plan-view.tsx
@src/store/business-atoms.ts
@src/store/derived-atoms.ts
@src/lib/constants.ts
@src/types/business.ts
@src/types/plan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dynamic sections, business identity, and currency</name>
  <files>src/features/export/business-plan-view.tsx</files>
  <action>
  Update the BusinessPlanView component to be business-aware:

  **1. Import business atoms and filter sections:**

  Import `activeBusinessAtom` from `@/store/business-atoms`. Read business object:
  ```typescript
  const business = useAtomValue(activeBusinessAtom);
  ```

  Create a filtered/ordered list of enabled section slugs:
  ```typescript
  const enabledSections = useMemo(() => {
    if (!business) return SECTION_SLUGS;
    return SECTION_SLUGS.filter((slug) => business.enabledSections.includes(slug));
  }, [business]);
  ```

  **2. Update header with business name:**

  Replace the hardcoded `<h1>Business Plan</h1>` header with the business name:
  ```tsx
  <h1 className="text-3xl font-bold tracking-tight mb-1">
    {business?.profile.name || 'Business Plan'}
  </h1>
  <p className="text-sm text-muted-foreground">Business Plan</p>
  ```

  **3. Dynamic Table of Contents:**

  Replace the hardcoded `SECTION_SLUGS.map()` in the Table of Contents with `enabledSections.map()`:
  ```tsx
  <ol className="list-decimal list-inside space-y-1 text-sm">
    {enabledSections.map((slug, i) => (
      <li key={slug}>
        <a href={`#section-${i + 1}`} className="text-blue-600 hover:underline">
          {SECTION_LABELS[slug]}
        </a>
      </li>
    ))}
  </ol>
  ```

  **4. Conditional section rendering:**

  Each of the 9 section blocks currently renders unconditionally. Wrap each in an enabled check and use dynamic numbering:

  Create a helper to get the section number:
  ```typescript
  function getSectionNumber(slug: SectionSlug): number {
    return enabledSections.indexOf(slug) + 1;
  }
  ```

  For each section, wrap in a conditional:
  ```tsx
  {enabledSections.includes('executive-summary') && (
    <>
      <SectionHeader number={getSectionNumber('executive-summary')} title="Executive Summary" id={`section-${getSectionNumber('executive-summary')}`} />
      {/* ... section content ... */}
    </>
  )}
  ```

  Apply this pattern to all 9 section blocks. Important: only call `useSection` for sections that might render — but since hooks can't be conditional, keep all 9 `useSection` calls at the top. The conditional rendering just hides sections that aren't enabled.

  **5. Currency from business profile:**

  Update `formatCurrency` to accept a currency code:
  ```typescript
  function formatCurrency(value: number, currency = 'USD'): string {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency, maximumFractionDigits: 0 }).format(value);
  }
  ```

  Read currency from business profile:
  ```typescript
  const currencyCode = business?.profile.currency ?? 'USD';
  ```

  Pass `currencyCode` to all `formatCurrency` calls throughout the component.

  **6. Update footer with business name:**

  Replace the footer to show business name:
  ```tsx
  <p className="text-xs text-muted-foreground">
    {business?.profile.name || 'Business Plan'} | Generated on {currentDate} | Scenario: {scenarioName}
  </p>
  ```

  The `Annual Revenue Projection` line in the footer will be updated in Task 2 to use dynamic values.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify that sections are conditionally rendered. Verify business name appears in header and footer. Verify currency code is passed to formatCurrency.</verify>
  <done>Business plan view shows only enabled sections with dynamic numbering. Business name in header/footer. Currency from business profile. Table of contents reflects enabled sections only.</done>
</task>

<task type="auto">
  <name>Task 2: Dynamic KPI cards and financial chart from evaluated values</name>
  <files>src/features/export/business-plan-view.tsx</files>
  <action>
  Replace hardcoded metric lookups with dynamic evaluated values:

  **1. Remove hardcoded metric lookups:**

  Delete the hardcoded lines at the top of the component:
  ```typescript
  // DELETE THESE:
  const monthlyRevenue = evaluated['monthly_revenue'] ?? 0;
  const monthlyProfit = evaluated['monthly_profit'] ?? 0;
  const profitMargin = evaluated['profit_margin'] ?? 0;
  const monthlyBookings = evaluated['monthly_bookings'] ?? 0;
  const annualRevenue = evaluated['annual_revenue'] ?? 0;
  ```

  **2. Dynamic KPI cards in Financial Projections section:**

  Replace the hardcoded 4-card grid (Monthly Revenue, Monthly Profit, Profit Margin, Monthly Bookings) with dynamic cards from evaluated values, using the same priority-sorting pattern as the dashboard (Phase 10):

  ```typescript
  import type { VariableUnit } from '@/types';

  const unitPriority: Record<VariableUnit, number> = {
    currency: 0, percent: 1, ratio: 2, count: 3, months: 4, days: 5, hours: 6,
  };

  const computedVariables = useMemo(() => {
    if (!definitions) return [];
    return Object.values(definitions)
      .filter((v) => v.type === 'computed')
      .sort((a, b) => (unitPriority[a.unit] ?? 99) - (unitPriority[b.unit] ?? 99));
  }, [definitions]);

  const primaryKpis = computedVariables.slice(0, 4);
  ```

  Render KPI cards dynamically:
  ```tsx
  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
    {primaryKpis.map((v) => (
      <div key={v.id} className="border rounded-lg p-3 text-center">
        <p className="text-xs text-muted-foreground">{v.label}</p>
        <p className="text-lg font-bold">
          {v.unit === 'currency'
            ? formatCurrency(evaluated[v.id] ?? 0, currencyCode)
            : v.unit === 'percent'
              ? `${((evaluated[v.id] ?? 0) * 100).toFixed(1)}%`
              : String(Math.round(evaluated[v.id] ?? 0))}
        </p>
      </div>
    ))}
  </div>
  ```

  **3. Dynamic financial chart:**

  Replace the hardcoded `financials.months` chart (which uses Fun Box-specific `sumCosts` and `MonthlyCosts`) with a dynamic chart from evaluated currency variables, same approach as dashboard Phase 10:

  ```typescript
  // Get currency variables for chart series (up to 3)
  const allVariables = useMemo(() => {
    if (!definitions) return [];
    return Object.values(definitions);
  }, [definitions]);

  const chartVariables = useMemo(() => {
    return allVariables
      .filter((v) => v.unit === 'currency')
      .slice(0, 3);
  }, [allVariables]);

  function getSemanticColor(label: string): string {
    const lower = label.toLowerCase();
    if (/revenue|income|sales/.test(lower)) return '#22c55e';
    if (/cost|expense|spend/.test(lower)) return '#f97316';
    if (/profit|net|margin/.test(lower)) return '#3b82f6';
    return '#64748b';
  }

  // Build 12-month flat projection data
  const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const dynamicChartData = useMemo(() => {
    return MONTHS.map((month) => {
      const point: Record<string, string | number> = { month };
      chartVariables.forEach((v) => {
        point[v.label] = evaluated[v.id] ?? 0;
      });
      return point;
    });
  }, [chartVariables, evaluated]);
  ```

  Replace the existing chart rendering:
  ```tsx
  {chartVariables.length > 0 && (
    <div ref={chartContainerRef}>
      <h3 className="text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-2">
        12-Month Financial Projection
      </h3>
      <div className="h-[300px] w-full">
        <ResponsiveContainer width="100%" height="100%">
          <AreaChart data={dynamicChartData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="month" tick={{ fontSize: 12 }} />
            <YAxis tickFormatter={(v: number) => formatCurrency(v, currencyCode)} />
            <Tooltip formatter={(value) => formatCurrency(Number(value), currencyCode)} labelStyle={{ fontWeight: 600 }} />
            <Legend />
            {chartVariables.map((v) => (
              <Area
                key={v.id}
                type="monotone"
                dataKey={v.label}
                stroke={getSemanticColor(v.label)}
                fill={getSemanticColor(v.label)}
                fillOpacity={0.15}
                strokeWidth={2}
                isAnimationActive={!chartAnimationDisabled}
              />
            ))}
          </AreaChart>
        </ResponsiveContainer>
      </div>
    </div>
  )}
  ```

  **4. Remove legacy `sumCosts` and hardcoded chart data:**

  Delete the `sumCosts` function and the `chartData` variable that used `financials.months`. Also delete the `MonthlyCosts` import if no longer used.

  Keep the Monthly P&L table that renders `financials.months` — this is still valid section data that users might fill in. But make it conditional: only show if `financials.months.length > 0`.

  **5. Keep the Unit Economics section conditional:**

  The Unit Economics subsection within Financial Projections should only render if any values are non-zero:
  ```tsx
  {(financials.unitEconomics.avgCheck > 0 || financials.unitEconomics.costPerEvent > 0) && (
    <div>
      <h3>Unit Economics</h3>
      {/* ... existing unit economics grid ... */}
    </div>
  )}
  ```

  **6. Update footer:**

  Replace the hardcoded `Annual Revenue Projection` line. Find the first evaluated currency variable or just remove it:
  ```tsx
  {/* Remove the hardcoded annualRevenue line from footer */}
  ```

  **7. Remove unused imports:**

  Clean up imports that are no longer needed after removing hardcoded patterns (like `MonthlyCosts` if fully unused, `sumCosts`, etc.).

  Run `npm run build` to verify production build succeeds.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run build`. Verify KPI cards show dynamic evaluated variables sorted by unit priority. Verify chart shows dynamic currency variables with semantic colors. Verify legacy sumCosts removed. Verify P&L table still renders when months data exists.</verify>
  <done>Business plan view uses dynamic KPIs from evaluated values. Chart shows dynamic currency variables. Legacy hardcoded metric lookups removed. Unit economics and P&L table conditional. Build passes.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] Only enabled sections render (disabled sections hidden)
- [ ] Section numbering is dynamic (based on enabled position)
- [ ] Table of contents reflects only enabled sections
- [ ] Business name shows in header and footer
- [ ] Currency from business profile used in all formatCurrency calls
- [ ] KPI cards show dynamic evaluated values (not hardcoded metric names)
- [ ] Chart shows dynamic currency variables with semantic colors
- [ ] Chart hidden when no currency variables exist
- [ ] P&L table still renders when financials.months has data
- [ ] No hardcoded `monthly_revenue` / `monthly_profit` / `monthly_bookings` lookups remain
</verification>

<success_criteria>

- Business plan view adapts to any business's enabled sections
- Financial metrics are dynamic, not hardcoded
- Business identity (name, currency) reflected throughout
- Existing section renderers preserved (they display whatever data was entered)
- Full TypeScript compilation and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-export-updates/11-01-SUMMARY.md`
</output>
