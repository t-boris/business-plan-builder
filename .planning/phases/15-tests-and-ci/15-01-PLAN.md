---
phase: 15-tests-and-ci
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [vitest.config.ts, package.json, src/test/setup.ts]
autonomous: true
---

<objective>
Set up Vitest test infrastructure: install deps, create config, add npm scripts, write first tests for formula-engine (pure logic).

Purpose: Establish test foundation and prove it works with the highest-value pure unit tests.
Output: Vitest config, test setup, formula-engine tests passing, npm test/verify scripts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@package.json
@vite.config.ts
@tsconfig.json
@tsconfig.app.json
@src/lib/formula-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies and create config</name>
  <files>package.json, vitest.config.ts, src/test/setup.ts</files>
  <action>
1. Install dev dependencies:
   ```
   npm install -D vitest jsdom @testing-library/react @testing-library/user-event @testing-library/jest-dom
   ```

2. Create `vitest.config.ts` at project root:
   - Import and extend from vite.config.ts using `mergeConfig` or `defineConfig` with same alias/define
   - Set `test.environment: 'jsdom'`
   - Set `test.globals: true` (auto-import describe/it/expect)
   - Set `test.setupFiles: ['./src/test/setup.ts']`
   - Mirror the `@` alias: `resolve.alias: { '@': path.resolve(__dirname, './src') }`
   - Mirror `define: { __APP_VERSION__: JSON.stringify('test') }`
   - Set `test.include: ['src/**/*.test.ts', 'src/**/*.test.tsx']`

3. Create `src/test/setup.ts`:
   - Import `@testing-library/jest-dom` for DOM matchers
   - Add any global test setup (minimal for now)

4. Add scripts to package.json:
   ```json
   "test": "vitest",
   "test:run": "vitest run",
   "test:watch": "vitest --watch",
   "verify": "eslint . && vitest run && tsc -b && vite build"
   ```

5. Verify with `npx vitest run` — should pass with 0 tests found (no test files yet).
  </action>
  <verify>npx vitest run exits with 0 errors. npm run verify runs all steps (lint, test, typecheck, build).</verify>
  <done>Vitest configured. npm run test, test:run, test:watch, verify all work.</done>
</task>

<task type="auto">
  <name>Task 2: Write formula-engine unit tests</name>
  <files>src/lib/__tests__/formula-engine.test.ts</files>
  <action>
Create `src/lib/__tests__/formula-engine.test.ts` testing all 3 exported functions from formula-engine.ts.

Read formula-engine.ts first to understand the exact interfaces: VariableDefinition type (import from @/types), getEvaluationOrder, evaluateVariables, validateFormula.

**getEvaluationOrder tests:**
- Returns empty array for input-only variables
- Returns computed variables in correct dependency order (A depends on B → B first)
- Handles diamond dependency (A→C, B→C, D→A+B)
- Throws on circular dependency

**evaluateVariables tests:**
- Input variables passed through with their values
- Computed variable evaluated from formula (e.g., `revenue * 12` with revenue=100 → 1200)
- Multi-level chain (A=input, B=A*2, C=B+10)
- Bad formula returns 0 gracefully (does not throw)
- Empty variables returns empty record
- Percent unit variables (stored as decimal) evaluated correctly

**validateFormula tests:**
- Valid formula returns { valid: true }
- Formula referencing unknown variable returns { valid: false, error: ... }
- Syntax error returns { valid: false, error: ... }
- Empty formula — test whatever the current behavior is

Use `describe`/`it`/`expect` from Vitest globals. Create minimal VariableDefinition fixtures inline in the test file.
  </action>
  <verify>npx vitest run src/lib/__tests__/formula-engine.test.ts — all tests pass</verify>
  <done>Formula engine has comprehensive unit tests covering all 3 functions. All tests pass.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` passes all tests
- [ ] `npm run verify` passes (lint + test + typecheck + build)
- [ ] Formula engine tests cover: evaluation order, variable evaluation, formula validation
</verification>

<success_criteria>

- Vitest configured and running
- npm scripts: test, test:run, test:watch, verify
- Formula engine has unit tests covering all 3 exported functions
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-tests-and-ci/15-01-SUMMARY.md`
</output>
