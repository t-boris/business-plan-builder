---
phase: 15-tests-and-ci
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/__tests__/sync-status.test.ts, src/lib/__tests__/retry.test.ts, src/lib/__tests__/logger.test.ts]
autonomous: true
---

<objective>
Write unit tests for the new v2.0 infrastructure: sync-status helpers, retry utility, and logger module.

Purpose: Lock down the infrastructure code from Phase 13-14 with tests before building on it further.
Output: Tests for sync-status, retry, and logger modules.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/lib/sync-status.ts
@src/lib/retry.ts
@src/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test sync-status helpers</name>
  <files>src/lib/__tests__/sync-status.test.ts</files>
  <action>
Read src/lib/sync-status.ts first. Write tests for `getSyncSummary`:

- Empty array returns 'idle'
- All 'idle' entries returns 'idle'
- Mix of 'idle' and 'saved' returns 'saved'
- Any 'saving' entry returns 'saving'
- Any 'error' entry returns 'error' (even if others are 'saving')
- 'offline' takes priority over 'saving' but not 'error'
- Single entry of each type
  </action>
  <verify>npx vitest run src/lib/__tests__/sync-status.test.ts passes</verify>
  <done>getSyncSummary has comprehensive tests for all priority combinations.</done>
</task>

<task type="auto">
  <name>Task 2: Test retry utility</name>
  <files>src/lib/__tests__/retry.test.ts</files>
  <action>
Read src/lib/retry.ts first. Write tests for `withRetry`:

- Succeeds on first try — returns result, no retries
- Fails once then succeeds — returns result after retry
- Fails all retries — throws the last error
- Respects maxRetries option
- Uses exponential backoff (mock timers with vi.useFakeTimers if needed, or just verify call count)
- Successful function called exactly once

Mock the logger to avoid console output in tests: `vi.mock('@/lib/logger')`.
Use `vi.fn()` for the async function under test.
  </action>
  <verify>npx vitest run src/lib/__tests__/retry.test.ts passes</verify>
  <done>Retry utility tests cover success, single retry, all retries exhausted.</done>
</task>

<task type="auto">
  <name>Task 3: Test logger module</name>
  <files>src/lib/__tests__/logger.test.ts</files>
  <action>
Read src/lib/logger.ts first. Write tests for `createLogger`:

- Creates logger with domain prefix
- `log.info('event')` calls console with correct structure
- `log.error('event', { key: 'value' })` includes data
- Event name is domain-prefixed: `createLogger('test').info('foo')` → event is `test.foo`
- All 4 levels work (debug, info, warn, error)

Spy on console methods with `vi.spyOn(console, 'info')` etc.
  </action>
  <verify>npx vitest run src/lib/__tests__/logger.test.ts passes</verify>
  <done>Logger tests verify structured output and domain prefixing.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` passes all tests (including formula-engine from 15-01)
- [ ] sync-status, retry, logger all have passing tests
</verification>

<success_criteria>

- Infrastructure modules from Phases 13-14 have test coverage
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-tests-and-ci/15-02-SUMMARY.md`
</output>
