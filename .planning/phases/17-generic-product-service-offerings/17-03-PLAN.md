---
phase: 17-generic-product-service-offerings
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/features/sections/product-service/index.tsx
autonomous: true
---

<objective>
Rewrite the Product & Service section UI from tier-based packages to a generic Offering model with overview, neutral offering cards, and add-on catalog with multi-select linking.

Purpose: Core UI change — removes all Starter/Popular/Premium tier concepts, replaces with descriptive offering cards.
Output: Fully functional Product & Service editor using new Offering/AddOn types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/17-generic-product-service-offerings/17-01-SUMMARY.md

@src/features/sections/product-service/index.tsx
@src/features/sections/product-service/normalize.ts
@src/types/plan.ts
@src/components/empty-state.tsx
@src/components/page-header.tsx
@src/components/ai-action-bar.tsx
@src/components/ai-suggestion-preview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite product-service component with offering model</name>
  <files>src/features/sections/product-service/index.tsx</files>
  <action>
**Complete rewrite** of the ProductService component. Remove ALL tier-related code:
- Delete `tierStyles` array (Star/Sparkles/Crown icons, border colors, Starter/Popular/Premium labels)
- Delete `PACKAGE_FIELDS` config (no longer needed — offerings don't have duration/maxParticipants)
- Delete `ADDON_SUGGESTIONS` config (replaced by add-on catalog)
- Remove imports: `Star`, `Crown`, `Sparkles`, `Clock`, `Users` from lucide-react (if no longer used)
- Remove `activeBusinessAtom` import and `businessType` derivation (no longer needed for field visibility)

**New component structure:**

1. **Data loading with normalization:**
   ```typescript
   import { normalizeProductService } from './normalize';

   const defaultProductService: ProductServiceType = { offerings: [], addOns: [], overview: '' };

   // In component:
   const { data: rawData, updateData, isLoading, canEdit } = useSection<ProductServiceType>(
     'product-service',
     defaultProductService
   );
   // Normalize legacy data on first load
   const [normalized, setNormalized] = useState(false);
   useEffect(() => {
     if (!isLoading && !normalized) {
       const norm = normalizeProductService(rawData);
       // Only update if normalization changed something (legacy data detected)
       if (JSON.stringify(norm) !== JSON.stringify(rawData)) {
         updateData(() => norm);
       }
       setNormalized(true);
     }
   }, [isLoading, normalized, rawData, updateData]);
   ```

2. **Overview block** (top of section, before offerings):
   - `<Textarea>` for `overview` field
   - Label: "Overview" — general description of the product/service line
   - Placeholder: "Describe your product or service line..."
   - Full width, 3-4 rows
   - Respects `canEdit` and `isPreview`

3. **Offerings list** (neutral cards, NO tiers):
   - Header: "Offerings" with "Add Offering" button
   - Each offering rendered as a `card-elevated rounded-lg` (no colored top border, no tier icon)
   - Card content:
     - **Name**: `<Input>` at top, `text-base font-semibold` (same pattern as before but no tier label)
     - **Price row**: `$` prefix + price input + optional `priceLabel` input (side by side). If price is null, show "On request" badge.
     - **Description**: `<Textarea>` rows={4}, the main content area
     - **Linked Add-ons**: Show which add-ons are linked (as small chips/badges). Click to open multi-select. Details in Task 2.
     - **Delete button**: Group-hover reveal pattern (same as current)
   - Empty state: `<EmptyState icon={PackageIcon} title="No offerings yet" description="Use AI Generate to create offerings, or add them manually." />`
   - "Add Offering" creates: `{ id: crypto.randomUUID(), name: '', description: '', price: 0, addOnIds: [] }`

4. **Add-on catalog** (below offerings):
   - Header: "Add-ons" with "Add Add-on" button
   - Each add-on as a row in a `card-elevated rounded-lg divide-y` list (similar to current but with description):
     - Name input (flex-1)
     - Description input (flex-1, smaller, optional — placeholder "Optional description")
     - Price input with $ prefix (w-[120px])
     - PriceLabel input (w-[100px], placeholder "e.g. per unit")
     - Delete button (group-hover)
   - Empty state with `Gift` icon
   - "Add Add-on" creates: `{ id: crypto.randomUUID(), name: '', price: 0 }`

5. **Helper functions** — update all CRUD helpers:
   - `addOffering()`, `removeOffering(index)`, `updateOffering(index, field, value)`
   - `addAddOn()`, `removeAddOn(index)`, `updateAddOn(index, field, value)`
   - Remove old `addPackage`, `removePackage`, `updatePackage`, `addPackageInclude`, etc.

6. **Preserve AI flow**: Keep `useAiSuggestion`, `AiActionBar`, `AiSuggestionPreview`, `handleAccept` — these work on the section data generically. The AI will return the new format after Plan 04 updates the schema.

**Styling guidelines:**
- Use existing design tokens: `card-elevated`, `text-muted-foreground`, `text-sm font-semibold uppercase tracking-wide` for section headers
- No colored borders, no tier icons, no implied ranking between offerings
- Clean, neutral cards with consistent spacing
- Grid: `grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4` for offering cards (same as current)

**Image placeholder**: Leave a `{/* Image upload — added in Plan 05 */}` comment in each offering card where the image will go. Don't implement image upload yet.
  </action>
  <verify>npm run build — build passes (AI schema mismatch warnings are OK, fixed in Plan 04)</verify>
  <done>Product & Service section renders with overview, neutral offering cards (no tiers), and add-on catalog. All CRUD operations work.</done>
</task>

<task type="auto">
  <name>Task 2: Add-on multi-select linking for offerings</name>
  <files>src/features/sections/product-service/index.tsx</files>
  <action>
Within each offering card, implement add-on linking via `addOnIds`:

1. **Display linked add-ons** as small badges/chips below the description:
   - Map `offering.addOnIds` to add-on names from `displayData.addOns`
   - Show as inline chips: `<span className="inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs">{addOn.name}</span>`
   - If no add-ons linked, show subtle text: "No add-ons linked"

2. **Add-on selector** — use a simple popover or inline checkbox list:
   - Button: "Link Add-ons" (or a small `Plus` icon next to the add-on chips)
   - On click: show a dropdown/popover with checkboxes for each available add-on from `displayData.addOns`
   - Each checkbox: `<label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={offering.addOnIds.includes(addOn.id)} /> {addOn.name} — ${addOn.price}</label>`
   - On toggle: update `offering.addOnIds` array (add/remove the add-on id)
   - If no add-ons exist yet, show: "Create add-ons first in the catalog below"

   For the popover, use the existing `Popover` component from shadcn (`@/components/ui/popover`) if available. If not available, use a simple conditional render with a button toggle (show/hide a bordered div below the chips). Check what UI primitives exist:
   ```
   ls src/components/ui/
   ```
   Prefer using existing components over adding new shadcn primitives.

3. **Sync handling**: When an add-on is deleted from the catalog, also remove its id from all offerings' `addOnIds` arrays. Add this cleanup to the `removeAddOn` function.

4. **Read-only mode**: In `isPreview` or `!canEdit`, don't show the "Link Add-ons" button. Only show the linked add-on chips.
  </action>
  <verify>npm run build passes. Manual check: adding an add-on to the catalog, then linking it to an offering via the selector, works correctly.</verify>
  <done>Each offering card shows linked add-ons as chips. Multi-select popover/checkbox list allows linking/unlinking. Removing an add-on cleans up all references.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` passes
- [ ] `npm run lint` passes (or only pre-existing warnings)
- [ ] No tier terminology remains (no Starter/Popular/Premium text, no Star/Sparkles/Crown icons used as tier indicators)
- [ ] Overview, Offerings, Add-ons sections all render correctly
- [ ] CRUD operations work: add/remove/edit offerings, add/remove/edit add-ons
- [ ] Add-on linking works: select/deselect add-ons per offering
</verification>

<success_criteria>
- Zero tier-related UI (no colored borders by position, no tier icons, no tier labels)
- Overview textarea editable
- Offering cards show: name, price (with optional priceLabel), description, linked add-ons
- Add-on catalog shows: name, description, price, priceLabel
- Multi-select linking between offerings and add-ons functional
- AI preview/accept/reject flow preserved
- Normalization runs on legacy data automatically
</success_criteria>

<output>
After completion, create `.planning/phases/17-generic-product-service-offerings/17-03-SUMMARY.md`
</output>
