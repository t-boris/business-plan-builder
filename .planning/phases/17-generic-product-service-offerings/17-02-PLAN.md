---
phase: 17-generic-product-service-offerings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/firebase.ts
  - src/hooks/use-image-upload.ts
  - storage.rules
  - firebase.json
autonomous: true
---

<objective>
Set up Firebase Storage for offering image uploads and create a reusable image upload hook.

Purpose: Enable image upload capability for offering cards (used by Plan 05).
Output: Firebase Storage initialized, storage security rules, useImageUpload hook with upload/delete/progress.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/firebase.ts
@firebase.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Firebase Storage and create upload hook</name>
  <files>src/lib/firebase.ts, src/hooks/use-image-upload.ts</files>
  <action>
**In `src/lib/firebase.ts`:**

Add Firebase Storage initialization:
```typescript
import { getStorage, connectStorageEmulator } from 'firebase/storage';
```

After the existing `db` export, add:
```typescript
export const storage = getStorage(app);
```

In the emulator connection block (if it exists), add storage emulator connection:
```typescript
if (import.meta.env.DEV && location.hostname === 'localhost') {
  connectStorageEmulator(storage, 'localhost', 9199);
}
```

**Create `src/hooks/use-image-upload.ts`:**

Export a hook `useImageUpload()` that returns:
```typescript
interface UseImageUploadReturn {
  upload: (file: File, path: string) => Promise<{ url: string; storagePath: string }>;
  remove: (storagePath: string) => Promise<void>;
  isUploading: boolean;
  progress: number; // 0-100
  error: string | null;
}
```

Implementation:
- `upload(file, path)`:
  1. Validate file type: only `image/jpeg`, `image/png`, `image/webp`. Reject others with descriptive error.
  2. Validate file size: max 5MB. Reject with descriptive error.
  3. Create storage ref at `path` (caller provides full path like `offerings/{businessId}/{offeringId}/{filename}`)
  4. Use `uploadBytesResumable` to upload with progress tracking
  5. On complete: get download URL via `getDownloadURL`, return `{ url, storagePath: path }`
  6. Set `isUploading` and `progress` state during upload
  7. On error: set `error` state with user-friendly message
- `remove(storagePath)`:
  1. Create ref from storagePath
  2. Call `deleteObject`
  3. On error: set `error` state (don't throw — caller handles gracefully)
- Use React `useState` for isUploading, progress, error
- Reset error before each new operation
- Import storage from `@/lib/firebase`

Do NOT use `firebase/storage` directly — import from the initialized instance in firebase.ts.
  </action>
  <verify>npx tsc --noEmit — no errors from firebase.ts or use-image-upload.ts</verify>
  <done>Firebase Storage initialized. useImageUpload hook with upload/delete/progress/validation created.</done>
</task>

<task type="auto">
  <name>Task 2: Storage security rules and emulator config</name>
  <files>storage.rules, firebase.json</files>
  <action>
**Create `storage.rules`:**

```rules
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Offering images: authenticated users can read/write under offerings/
    match /offerings/{businessId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/(jpeg|png|webp)');
    }

    // Deny everything else by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
```

**Update `firebase.json`:**

Add the storage configuration. The file likely has `hosting`, `firestore`, and `emulators` sections. Add:
1. Top-level: `"storage": { "rules": "storage.rules" }`
2. In `emulators` section: `"storage": { "port": 9199 }` (standard storage emulator port)

Do NOT modify existing sections — only add the storage entries.
  </action>
  <verify>cat storage.rules && cat firebase.json | grep -A2 storage — rules file exists, firebase.json has storage config</verify>
  <done>Storage security rules enforce auth + file type/size limits. Emulator configured on port 9199.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes for firebase.ts and use-image-upload.ts
- [ ] storage.rules exists with auth + content type + size rules
- [ ] firebase.json includes storage section and emulator port
</verification>

<success_criteria>
- Firebase Storage initialized in firebase.ts
- useImageUpload hook handles upload with progress, delete, validation (type + size)
- Storage rules restrict to authenticated users, images only, 5MB max
- Emulator config present
</success_criteria>

<output>
After completion, create `.planning/phases/17-generic-product-service-offerings/17-02-SUMMARY.md`
</output>
