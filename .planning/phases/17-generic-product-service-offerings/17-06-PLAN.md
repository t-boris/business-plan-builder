---
phase: 17-generic-product-service-offerings
plan: 06
type: execute
wave: 3
depends_on: ["17-03", "17-04"]
files_modified:
  - src/features/export/business-plan-view.tsx
  - src/features/export/pdf/BusinessPlanDocument.tsx
autonomous: true
---

<objective>
Update web export and PDF export to render the new Offering-based product-service model, including offering images where available.

Purpose: Export must be consistent with the editor — showing offerings, descriptions, linked add-ons, and images.
Output: Updated business-plan-view.tsx and BusinessPlanDocument.tsx for new data model.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/17-generic-product-service-offerings/17-01-SUMMARY.md
@.planning/phases/17-generic-product-service-offerings/17-03-SUMMARY.md

@src/features/export/business-plan-view.tsx
@src/features/export/pdf/BusinessPlanDocument.tsx
@src/types/plan.ts
@src/features/sections/product-service/normalize.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update web export (business-plan-view.tsx)</name>
  <files>src/features/export/business-plan-view.tsx</files>
  <action>
Find the product-service rendering section in business-plan-view.tsx. It currently renders `productService.packages` with package name, price, duration|maxParticipants, description, and includes as bullet list.

**Replace with Offering-based rendering:**

1. **Import normalization:** Add `import { normalizeProductService } from '@/features/sections/product-service/normalize';` at the top.

2. **Normalize data:** Where productService data is used, normalize it first:
   ```typescript
   const normalizedPS = productService ? normalizeProductService(productService) : null;
   ```

3. **Overview** (if present):
   - Render `normalizedPS.overview` as a paragraph before the offerings grid, if non-empty.

4. **Offerings grid** (replace packages grid):
   - Keep the 3-column grid layout
   - Each offering card:
     - Image (if `offering.image?.url`): `<img src={offering.image.url} alt={offering.image.alt || offering.name} className="w-full h-24 object-cover rounded-t-lg" />`
     - If no image: no placeholder needed in export (skip the image area)
     - Name: `<h4 className="font-semibold text-sm">{offering.name}</h4>`
     - Price: `<p className="text-lg font-bold text-primary">{offering.price !== null ? formatCurrency(offering.price, currencyCode) : 'On request'}</p>`
     - Price label (if present): `<span className="text-xs text-muted-foreground">{offering.priceLabel}</span>` next to price
     - Description: `<p className="text-xs mt-2">{offering.description}</p>`
     - Linked add-ons (if any): Resolve `offering.addOnIds` against `normalizedPS.addOns`, show as comma-separated names with prices: `<p className="text-xs text-muted-foreground mt-1">Add-ons: {linkedNames}</p>`

5. **Add-ons section** (replace old add-ons rendering):
   - Keep the existing pattern of showing add-ons as a list
   - Each add-on: name, description (if present), price with priceLabel
   - Format: `{name}{description ? ` — ${description}` : ''} — ${formatCurrency(price, currencyCode)}{priceLabel ? ` ${priceLabel}` : ''}`

Remove all references to `pkg.duration`, `pkg.maxParticipants`, `pkg.includes` (these were Package fields).
  </action>
  <verify>npm run build — passes. No TypeScript errors in business-plan-view.tsx.</verify>
  <done>Web export renders offerings with images, descriptions, prices, linked add-ons. No Package/tier references remain.</done>
</task>

<task type="auto">
  <name>Task 2: Update PDF export (BusinessPlanDocument.tsx)</name>
  <files>src/features/export/pdf/BusinessPlanDocument.tsx</files>
  <action>
Find the product-service rendering section in BusinessPlanDocument.tsx. It renders packages as `infoCard` views with name, price, duration|maxParticipants, description, includes as BulletList.

**Replace with Offering-based rendering:**

1. **Import normalization:** Add `import { normalizeProductService } from '@/features/sections/product-service/normalize';`

2. **Normalize data:** Where productService data is used:
   ```typescript
   const normalizedPS = productService ? normalizeProductService(productService) : null;
   ```

3. **Overview** (if present):
   - Render as a `<Text style={styles.bodyText}>{normalizedPS.overview}</Text>` before offerings

4. **Offerings** (replace packages):
   - Each offering as an `infoCard` View:
     - Image (if `offering.image?.url`): Use `<Image src={offering.image.url} style={{ width: '100%', height: 60, objectFit: 'cover', borderRadius: 4, marginBottom: 4 }} />` — @react-pdf/renderer supports `Image` component with `src` prop for URLs
     - If no image: skip (no empty box)
     - Name + Price row: keep existing layout pattern (name left, price right)
     - Price label: small text next to price if present
     - Description: `<Text style={styles.bodyText}>{offering.description}</Text>`
     - Linked add-ons: resolve addOnIds, show as text: "Add-ons: name1, name2"
   - Remove `<BulletList items={pkg.includes} />` (no longer applicable)
   - Remove duration/maxParticipants text line

5. **Add-ons section:**
   - Render each add-on with: name, description (if present), price with priceLabel
   - Keep existing text formatting pattern

**IMPORTANT for @react-pdf/renderer Image:**
- The `Image` component requires the import: `import { Image } from '@react-pdf/renderer'` — check if it's already imported (likely `View`, `Text`, `Document`, `Page` are imported, may need to add `Image`)
- If the offering has no image, do NOT render an `<Image>` component with undefined src — it will crash the PDF
- Guard with: `{offering.image?.url && <Image src={offering.image.url} ... />}`

Remove all references to old Package fields (duration, maxParticipants, includes).
  </action>
  <verify>npm run build — passes. No TypeScript errors in BusinessPlanDocument.tsx.</verify>
  <done>PDF export renders offerings with images, descriptions, prices, linked add-ons. No Package/tier references remain.</done>
</task>

<task type="auto">
  <name>Task 3: Final build and lint verification</name>
  <files>(none — verification only)</files>
  <action>
Run the full verification suite:

1. `npm run lint` — fix any lint errors in modified files
2. `npm run build` — ensure clean production build
3. `npx vitest run` — run all existing tests plus the new normalization tests from Plan 01

Check for any remaining references to old types:
- `grep -r "Package" src/types/` — should not find old Package interface
- `grep -r "pkg\.duration\|pkg\.maxParticipants\|pkg\.includes" src/` — should find zero matches
- `grep -r "Starter\|Popular\|Premium" src/features/sections/product-service/` — should find zero matches
- `grep -r "tierStyles\|PACKAGE_FIELDS\|ADDON_SUGGESTIONS" src/` — should find zero matches

Fix any issues found.
  </action>
  <verify>npm run lint && npm run build && npx vitest run — all pass with zero errors</verify>
  <done>Full project builds cleanly. All tests pass. No legacy Package/tier references remain in source code.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] `npx vitest run` — all tests pass
- [ ] No old Package type references in source (except normalization function which handles legacy data)
- [ ] No tier terminology in source (Starter/Popular/Premium)
- [ ] Web export renders offerings correctly
- [ ] PDF export renders offerings with images
</verification>

<success_criteria>
- Web export shows: overview, offering cards (image, name, price, description, linked add-ons), add-on catalog
- PDF export shows: same structure adapted for @react-pdf/renderer
- Export handles missing images gracefully (no broken image placeholders)
- Export handles null prices ("On request")
- Full build, lint, and test suite pass
- Zero references to old Package/tier concepts in non-normalization code
</success_criteria>

<output>
After completion, create `.planning/phases/17-generic-product-service-offerings/17-06-SUMMARY.md`
</output>
