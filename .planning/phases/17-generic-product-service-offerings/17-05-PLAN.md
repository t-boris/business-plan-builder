---
phase: 17-generic-product-service-offerings
plan: 05
type: execute
wave: 3
depends_on: ["17-02", "17-03"]
files_modified:
  - src/features/sections/product-service/index.tsx
autonomous: true
---

<objective>
Add image upload/preview/replace/remove capability to each offering card using the Firebase Storage hook from Plan 02.

Purpose: Allow users to visually represent their products/services with images.
Output: Each offering card has optional image upload with preview, replace, and remove functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/17-generic-product-service-offerings/17-02-SUMMARY.md
@.planning/phases/17-generic-product-service-offerings/17-03-SUMMARY.md

@src/features/sections/product-service/index.tsx
@src/hooks/use-image-upload.ts
@src/types/plan.ts
@src/store/business-atoms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image upload UI to offering cards</name>
  <files>src/features/sections/product-service/index.tsx</files>
  <action>
Import `useImageUpload` from `@/hooks/use-image-upload` and `activeBusinessAtom` from `@/store/business-atoms`.

In the ProductService component, add:
```typescript
const { upload, remove, isUploading, progress, error: uploadError } = useImageUpload();
const business = useAtomValue(activeBusinessAtom);
```

For each offering card, add an image section at the top of the card (before the name input):

**When offering has an image (`offering.image?.url`):**
- Show the image as a preview: `<img src={offering.image.url} alt={offering.image.alt || offering.name} className="w-full h-32 object-cover rounded-t-lg" />`
- Overlay on hover (when `canEdit && !isPreview`):
  - "Replace" button (triggers file picker)
  - "Remove" button (calls `remove(offering.image.storagePath)` then clears the image field)

**When offering has NO image:**
- Show a subtle placeholder area: `<div className="w-full h-24 bg-muted/50 rounded-t-lg flex items-center justify-center">`
  - If `canEdit && !isPreview`: Show upload button with `<ImagePlus>` icon (from lucide-react) and text "Add image"
  - If readonly: Show nothing (hide the placeholder entirely)

**Upload flow:**
1. Click "Add image" or "Replace" → open a hidden `<input type="file" accept="image/jpeg,image/png,image/webp" />` via ref
2. On file selected:
   - Call `upload(file, \`offerings/${business?.id}/${offering.id}/${file.name}\`)`
   - Show upload progress (small progress bar or spinner overlaying the image area)
   - On success: update offering with `image: { url, storagePath, alt: offering.name }`
   - On error: show error message below the image area (use `uploadError` state)
3. The `updateOffering` function already handles field updates — use it for the `image` field

**Remove flow:**
1. Click "Remove" → call `remove(offering.image.storagePath)` if storagePath exists
2. Clear the image field: `updateOffering(index, 'image', undefined)`
3. Handle errors gracefully (show error, don't crash)

**During upload:**
- Show a progress indicator (small bar or percentage) over the image area
- Disable other image actions (no double-upload)

**Important:** The image is stored in Firebase Storage and only the metadata (`url`, `storagePath`, `alt`) is saved to Firestore as part of the offering object. Never store base64 in Firestore.

**Lucide imports to add:** `ImagePlus`, `X` (if not already imported) for the upload and remove buttons.
  </action>
  <verify>npm run build — passes. npm run lint — passes or only pre-existing warnings.</verify>
  <done>Each offering card has image upload/preview/replace/remove. Upload shows progress. Errors displayed. Read-only mode hides upload controls.</done>
</task>

<task type="auto">
  <name>Task 2: Handle image cleanup on offering deletion</name>
  <files>src/features/sections/product-service/index.tsx</files>
  <action>
Update the `removeOffering` function to also delete the offering's image from Firebase Storage:

```typescript
function removeOffering(index: number) {
  const offering = displayData.offerings[index];
  // Clean up image from Storage if it exists
  if (offering?.image?.storagePath) {
    remove(offering.image.storagePath).catch(() => {
      // Best-effort cleanup — don't block deletion
    });
  }
  updateData((prev) => ({
    ...prev,
    offerings: prev.offerings.filter((_, i) => i !== index),
  }));
}
```

Also handle the edge case where AI-generated data replaces existing data:
- In `handleAccept` (AI accept flow), when replacing data, the old offerings' images remain in Storage. This is acceptable for now (orphaned images) — don't add complex cleanup logic. Just note with a comment: `// Note: replaced offerings may leave orphaned images in Storage`.

Verify that the upload error state is properly displayed and dismissible:
- Show `uploadError` as a small red text below the image area
- Auto-clear error after 5 seconds or on next action
  </action>
  <verify>npm run build — passes. Manual: delete an offering with image → image should be removed from storage (best-effort).</verify>
  <done>Offering deletion cleans up associated Storage image. Error handling is graceful with auto-dismiss.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` passes
- [ ] `npm run lint` passes
- [ ] Image upload works (file picker → progress → preview)
- [ ] Image replace works (new file replaces old)
- [ ] Image remove works (clears preview, deletes from storage)
- [ ] Offering deletion cleans up image
- [ ] Read-only mode hides all upload controls
- [ ] Upload errors displayed with auto-dismiss
</verification>

<success_criteria>
- Image upload/preview/replace/remove functional per offering
- File validation (jpeg/png/webp, 5MB max) enforced
- Upload progress shown during upload
- Storage cleanup on offering deletion
- No image controls visible in read-only mode
- Errors handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/17-generic-product-service-offerings/17-05-SUMMARY.md`
</output>
