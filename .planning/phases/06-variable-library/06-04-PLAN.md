---
phase: 06-variable-library
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-03"]
files_modified:
  - src/features/scenarios/variable-editor.tsx
  - src/features/scenarios/index.tsx
autonomous: true
---

<objective>
Create the Variable Editor component and integrate it into the Scenarios page.

Purpose: Users see their business's variables organized by category, can edit input values and see computed results update live, and can add/remove/customize variables. This is the core variable management experience described in the CONTEXT.md vision.

Output: VariableEditor component displaying categorized variables with inline editing, live formula evaluation, and variable customization. Integrated as a new tab on the Scenarios page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/06-variable-library/06-RESEARCH.md
@.planning/phases/06-variable-library/06-CONTEXT.md
@.planning/phases/06-variable-library/06-01-SUMMARY.md
@.planning/phases/06-variable-library/06-03-SUMMARY.md

@src/features/scenarios/index.tsx
@src/features/scenarios/scenario-controls.tsx
@src/hooks/use-business-variables.ts
@src/lib/formula-engine.ts
@src/lib/variable-templates/types.ts
@src/types/business.ts
@src/components/ui/card.tsx
@src/components/ui/input.tsx
@src/components/ui/button.tsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create VariableEditor component</name>
  <files>
    src/features/scenarios/variable-editor.tsx
  </files>
  <action>
    Create `src/features/scenarios/variable-editor.tsx` exporting a `VariableEditor` component.

    **Data flow:**
    - Read variables from `useBusinessVariables()` hook (loaded from Firestore)
    - Compute all values using `evaluateVariables()` from formula-engine.ts
    - Display variables grouped by category
    - Input variable changes call `updateVariableValue()` → triggers re-evaluation

    **Layout structure:**

    ```
    <div className="space-y-4">
      {/* For each category with variables: */}
      <Card>
        <CardHeader>
          <h3 className="text-sm font-semibold">{categoryLabel}</h3>
        </CardHeader>
        <CardContent className="space-y-3">
          {/* For each variable in this category: */}
          {/* Input variable: editable number field */}
          {/* Computed variable: read-only display with formula tooltip */}
        </CardContent>
      </Card>
    </div>
    ```

    **Variable display:**

    *Input variables (type === "input"):*
    - Label (text-xs font-medium text-muted-foreground)
    - Editable number input (`<Input type="number">` from shadcn)
    - Currency prefix ("$") if unit === "currency"
    - Percent suffix ("%") if unit === "percent" — display value * 100, store as decimal
    - Description as title attribute or small text below
    - On change: call `updateVariableValue(variable.id, newValue)` — for percent, divide by 100 before saving

    *Computed variables (type === "computed"):*
    - Label (text-xs font-medium text-muted-foreground)
    - Read-only value display (not an input — just formatted text)
    - Currency: format with $ and commas (use `Intl.NumberFormat`)
    - Percent: multiply by 100 and show with % suffix
    - Count: format with commas
    - Small formula indicator (e.g., "fx" badge or calculator icon from lucide) — hover to see formula text
    - Value comes from `evaluatedValues[variable.id]` (computed by evaluateVariables)

    **Category ordering:**
    - Use VARIABLE_CATEGORIES from `@/lib/variable-templates/types.ts` (if it exists) or hardcode the order: revenue (1), costs (2), unitEconomics (3), growth (4), operations (5)
    - Only show categories that have variables
    - Within each category, maintain the array order from the template

    **Formatting helper (inline in component):**
    ```
    function formatValue(value: number, unit: VariableUnit): string {
      if (unit === "currency") return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(value);
      if (unit === "percent") return `${(value * 100).toFixed(1)}%`;
      if (unit === "ratio") return value.toFixed(2);
      return new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 }).format(value);
    }
    ```

    **Empty state:**
    If variables is null or empty (not loaded yet or business has no variables):
    ```
    <div className="text-center text-muted-foreground py-8">
      <p>No variables configured for this business.</p>
    </div>
    ```

    **Error handling:**
    - If evaluateVariables throws (circular dependency), show an error alert at the top
    - Wrap evaluation in try/catch, display error message, still show input variables as editable

    **Add/Remove controls (simple version):**
    - At the bottom, a "Manage Variables" collapsible section (or just a simple button)
    - For now, implement a simple "Remove" button (small X icon) next to each variable — only visible on hover
    - On remove: call `removeVariable(variable.id)` from the hook
    - Adding new variables: Add a simple "Add Variable" button at the bottom that opens a small inline form with: id (text), label (text), type (select: input/computed), category (select), unit (select), and optionally formula + dependsOn for computed. On submit, call `addVariable(newVar)`.
    - Keep the add form simple — it's a power-user feature. Most users will use the template defaults.

    **Do NOT:**
    - Replace or modify the existing ScenarioControls or ScenarioDashboard — those stay unchanged until Phase 7
    - Import or use any scenario atoms — variables are fully independent from the hardcoded scenario system
    - Over-engineer the add/remove UI — simple inline forms are fine
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. VariableEditor exports correctly.</verify>
  <done>
    - VariableEditor displays variables grouped by category
    - Input variables are editable with correct formatting (currency prefix, percent display)
    - Computed variables show live-evaluated values (read-only)
    - Values update reactively when inputs change
    - Remove button works for individual variables
    - Add Variable form works for new variables
    - Empty state handled
    - Formula evaluation errors handled gracefully
    - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate VariableEditor into Scenarios page</name>
  <files>
    src/features/scenarios/index.tsx
  </files>
  <action>
    Modify the Scenarios page (`src/features/scenarios/index.tsx`) to add a "Variables" tab alongside the existing "Editor" and "Compare" tabs.

    **Current Tabs structure:**
    ```
    <Tabs defaultValue="editor">
      <TabsList>
        <TabsTrigger value="editor">Editor</TabsTrigger>
        <TabsTrigger value="compare">Compare</TabsTrigger>
      </TabsList>
      <TabsContent value="editor">...</TabsContent>
      <TabsContent value="compare">...</TabsContent>
    </Tabs>
    ```

    **Updated Tabs structure:**
    ```
    <Tabs defaultValue="editor">
      <TabsList>
        <TabsTrigger value="editor">Editor</TabsTrigger>
        <TabsTrigger value="variables">Variables</TabsTrigger>
        <TabsTrigger value="compare">Compare</TabsTrigger>
      </TabsList>
      <TabsContent value="editor">
        {/* Existing two-column layout unchanged */}
      </TabsContent>
      <TabsContent value="variables">
        <VariableEditor />
      </TabsContent>
      <TabsContent value="compare">
        {/* Existing ScenarioComparison unchanged */}
      </TabsContent>
    </Tabs>
    ```

    **Import:**
    - Add `import { VariableEditor } from './variable-editor';`

    **No other changes to this file.** The existing Editor tab (with hardcoded ScenarioControls + ScenarioDashboard) remains unchanged until Phase 7 replaces it.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. The "Variables" tab appears between "Editor" and "Compare".</verify>
  <done>
    - Variables tab added to Scenarios page
    - VariableEditor renders in the Variables tab
    - Existing Editor and Compare tabs unchanged
    - No TypeScript errors
    - No regressions in existing scenario functionality
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` succeeds
- [ ] VariableEditor displays categorized variables
- [ ] Input variable editing works with correct formatting
- [ ] Computed variables evaluate and display in real-time
- [ ] Variables tab visible on Scenarios page
- [ ] Existing Editor and Compare tabs work unchanged
- [ ] Add/Remove variable functions work
- [ ] No regressions in existing build
</verification>

<success_criteria>
- Variable Editor shows business-specific variables (e.g., MRR, churn for SaaS)
- Variables grouped by category (Revenue, Costs, Unit Economics, Growth, Operations)
- Input variables editable with live computed value updates
- Currency formatted with $, percentages shown as %, counts with commas
- Add/Remove variable functionality works
- Seamlessly integrated as a tab on the Scenarios page
- Existing scenario functionality preserved
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-variable-library/06-04-SUMMARY.md`
</output>
