---
phase: 06-variable-library
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/formula-engine.ts
  - src/lib/variable-templates/types.ts
autonomous: true
---

<objective>
Create the formula evaluation engine and variable template type infrastructure.

Purpose: Provide the computation layer that evaluates variable formulas with dependency resolution. This is the core of the financial modeling engine — change an input, all computed variables auto-update in the correct order.

Output: formula-engine.ts with safe expression evaluation (expr-eval), topological sort for dependency resolution, and cycle detection. types.ts with variable category constants and VariableDefinition factory helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/06-variable-library/06-RESEARCH.md
@.planning/phases/06-variable-library/06-CONTEXT.md

@src/types/business.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Install expr-eval and create formula-engine.ts</name>
  <files>
    package.json
    src/lib/formula-engine.ts
  </files>
  <action>
    **1. Install expr-eval:**
    Run `npm install expr-eval` and `npm install -D @types/expr-eval`

    **2. Create `src/lib/formula-engine.ts`** with three exported functions:

    **`getEvaluationOrder(variables: Record<string, VariableDefinition>): string[]`**
    - Filter to computed variables only (type === "computed")
    - Build in-degree map: for each computed variable, count how many of its `dependsOn` entries are also computed variables
    - Build adjacency list: for each computed dependency, track which variables depend on it
    - Kahn's algorithm (BFS): start with computed variables that have in-degree 0, process queue, decrement in-degrees, add newly zero-degree nodes
    - If result length !== computed variable count, throw Error with message listing the variable IDs involved in the cycle
    - Return ordered array of variable IDs

    **`evaluateVariables(variables: Record<string, VariableDefinition>): Record<string, number>`**
    - Import `Parser` from `expr-eval`
    - Create parser instance (module-level singleton for reuse)
    - Call `getEvaluationOrder()` to get sorted computed variable IDs
    - Build initial scope: `Record<string, number>` from all input variables' `.value` field
    - Iterate computed variables in order: parse and evaluate each formula using `parser.evaluate(formula, scope)`, store result in scope
    - Wrap each evaluation in try/catch — on error, log warning and set value to 0 (graceful degradation)
    - Return the complete scope (all variable values, both input and computed)

    **`validateFormula(formula: string, availableVariables: string[]): { valid: boolean; error?: string }`**
    - Try parsing with `parser.parse(formula)`
    - If parse succeeds, check that all variable references in the formula exist in `availableVariables` by evaluating with a scope where all available variables are set to 1
    - Return `{ valid: true }` or `{ valid: false, error: "..." }`
    - Use this for UI validation when users edit formulas

    **Important implementation details:**
    - Create `const parser = new Parser()` at module level (singleton, reuse across calls)
    - expr-eval supports ternary: `a > 0 ? b / a : 0` — use this pattern for division guards
    - All percent variables are stored as decimals (0.30 not 30) — formulas use decimal values
    - Import `VariableDefinition` from `@/types/business`
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. The module exports getEvaluationOrder, evaluateVariables, validateFormula.</verify>
  <done>
    - formula-engine.ts compiles without errors
    - expr-eval installed in package.json dependencies
    - @types/expr-eval installed in devDependencies
    - Three functions exported: getEvaluationOrder, evaluateVariables, validateFormula
    - Topological sort handles cycles with clear error
    - Formula evaluation handles errors gracefully (returns 0)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create variable category constants and factory helpers</name>
  <files>
    src/lib/variable-templates/types.ts
  </files>
  <action>
    Create `src/lib/variable-templates/types.ts` with:

    **1. Variable category constants:**
    ```
    export const VARIABLE_CATEGORIES = {
      revenue: { label: "Revenue", order: 1 },
      costs: { label: "Costs", order: 2 },
      unitEconomics: { label: "Unit Economics", order: 3 },
      growth: { label: "Growth", order: 4 },
      operations: { label: "Operations", order: 5 },
    } as const;

    export type VariableCategory = keyof typeof VARIABLE_CATEGORIES;
    ```

    **2. Factory functions for creating VariableDefinition objects:**

    `inputVar(id, label, category, unit, defaultValue, description, opts?)` — returns a VariableDefinition with:
    - type: "input"
    - value: defaultValue
    - defaultValue: defaultValue
    - All other fields from params
    - opts can include: min, max, step
    - dependsOn and dependents should NOT be set (they're undefined for input vars)

    `computedVar(id, label, category, unit, formula, dependsOn, description)` — returns a VariableDefinition with:
    - type: "computed"
    - value: 0 (computed at runtime)
    - defaultValue: 0
    - formula: formula string
    - dependsOn: array of variable IDs
    - dependents should NOT be set (derive when needed, per RESEARCH.md anti-pattern guidance)

    **3. Helper to convert VariableDefinition[] to Record<string, VariableDefinition>:**

    `toVariableRecord(variables: VariableDefinition[]): Record<string, VariableDefinition>`
    - Reduces array to Record using variable.id as key
    - Used by template files to produce the format expected by BusinessTemplate.defaultVariables

    Import `VariableDefinition`, `VariableUnit` from `@/types/business`.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. The module exports VARIABLE_CATEGORIES, VariableCategory, inputVar, computedVar, toVariableRecord.</verify>
  <done>
    - types.ts compiles without errors
    - 5 variable categories defined with labels and order
    - VariableCategory type exported
    - inputVar and computedVar factory functions work correctly
    - toVariableRecord converts arrays to records
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` succeeds
- [ ] `npm install` succeeds (expr-eval installed)
- [ ] formula-engine.ts exports 3 functions
- [ ] types.ts exports categories, type, and 3 helpers
- [ ] No regressions in existing build
</verification>

<success_criteria>
- expr-eval installed and importable
- Formula engine evaluates simple expressions correctly
- Topological sort resolves dependencies in correct order
- Circular dependency detection works
- Factory helpers produce valid VariableDefinition objects
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-variable-library/06-01-SUMMARY.md`
</output>
