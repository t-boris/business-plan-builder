---
phase: 02-business-crud
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03", "02-04"]
files_modified: [src/app/router.tsx, src/app/providers.tsx]
autonomous: true
---

<objective>
Wire everything together: update the router to add business list and create routes, update providers to load businesses on auth and initialize the active business. This is the integration plan that makes all Phase 2 features work as a cohesive whole.

Purpose: Without router and provider integration, the new pages aren't accessible and businesses don't load on app start. This plan connects all the pieces built in Plans 02-04.

Output: Modified `src/app/router.tsx`, modified `src/app/providers.tsx`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-business-crud/02-CONTEXT.md
@.planning/phases/02-business-crud/02-01-SUMMARY.md
@.planning/phases/02-business-crud/02-02-SUMMARY.md
@.planning/phases/02-business-crud/02-03-SUMMARY.md
@.planning/phases/02-business-crud/02-04-SUMMARY.md

@src/app/router.tsx
@src/app/providers.tsx
@src/features/businesses/index.tsx
@src/features/businesses/create-business.tsx
@src/store/business-atoms.ts
@src/hooks/use-businesses.ts
@src/store/auth-atoms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update providers to load businesses on authentication</name>
  <files>src/app/providers.tsx</files>
  <action>
Modify `src/app/providers.tsx` to add a BusinessLoader component that loads the user's businesses from Firestore after authentication.

**Add a new `BusinessLoader` component** (similar pattern to the existing `ScenarioSync` component):

```typescript
function BusinessLoader() {
  const authStatus = useAtomValue(authStatusAtom);
  const { loadBusinesses } = useBusinesses();
  const loadedRef = useRef(false);

  useEffect(() => {
    if (authStatus !== "authenticated" || loadedRef.current) return;
    loadedRef.current = true;
    loadBusinesses();
  }, [authStatus, loadBusinesses]);

  return null;
}
```

**Place it in the Providers tree:**

```tsx
export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <JotaiProvider>
      <AuthListener>
        <BusinessLoader />
        <ScenarioSync />
        <BrowserRouter>
          {children}
        </BrowserRouter>
      </AuthListener>
    </JotaiProvider>
  );
}
```

`BusinessLoader` goes BEFORE `ScenarioSync` because eventually (Phase 3) scenario loading will depend on active business. For now they're independent.

**New imports:**
- `useBusinesses` from `@/hooks/use-businesses`

**IMPORTANT:**
- Keep ALL existing code in providers.tsx unchanged (AuthListener, ScenarioSync, Providers structure)
- Only ADD the BusinessLoader component and its import
- BusinessLoader must be inside AuthListener (needs auth context) and inside JotaiProvider (needs atoms)
- The useBusinesses hook handles loadBusinesses errors internally (silent catch)
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>BusinessLoader component added to providers. Loads businesses from Firestore on authentication. Placed before ScenarioSync in the component tree.</done>
</task>

<task type="auto">
  <name>Task 2: Update router with business list and create routes</name>
  <files>src/app/router.tsx</files>
  <action>
Modify `src/app/router.tsx` to add routes for the business list and create business pages.

**New routes to add:**

```tsx
import { BusinessList } from "@/features/businesses";
import { CreateBusiness } from "@/features/businesses/create-business";
```

**Route structure update:**

The business list becomes the home page. The existing Dashboard moves to a named route. Keep all existing section routes working.

```tsx
<Routes>
  {/* Business management routes (no sidebar layout) */}
  <Route path="/businesses" element={<BusinessListLayout />}>
    <Route index element={<BusinessList />} />
    <Route path="new" element={<CreateBusiness />} />
  </Route>

  {/* Business plan routes (with sidebar layout) */}
  <Route element={<DashboardLayout />}>
    <Route index element={<Dashboard />} />
    <Route path="executive-summary" element={<ExecutiveSummary />} />
    <Route path="market-analysis" element={<MarketAnalysis />} />
    <Route path="product-service" element={<ProductService />} />
    <Route path="marketing-strategy" element={<MarketingStrategy />} />
    <Route path="operations" element={<Operations />} />
    <Route path="financial-projections" element={<FinancialProjections />} />
    <Route path="risks-due-diligence" element={<RisksDueDiligence />} />
    <Route path="kpis-metrics" element={<KpisMetrics />} />
    <Route path="launch-plan" element={<LaunchPlan />} />
    <Route path="scenarios" element={<Scenarios />} />
    <Route path="export" element={<Export />} />
  </Route>
</Routes>
```

**BusinessListLayout** — a simple layout for business list/create pages that does NOT include the sidebar (these pages are outside business context):

```tsx
function BusinessListLayout() {
  return (
    <div className="min-h-svh bg-background">
      <div className="mx-auto max-w-5xl p-6">
        <Outlet />
      </div>
    </div>
  );
}
```

Define this inline in router.tsx (small enough to not warrant its own file).

**Route logic:**

The app currently shows LoginPage for unauthenticated users and all routes for authenticated users. Keep this auth guard. When authenticated:

- `/businesses` → Business list
- `/businesses/new` → Create business
- `/` → Dashboard (existing, now only when a business is active)
- All existing section routes remain unchanged

**Navigation flow:**
1. User logs in → authenticated → BusinessLoader loads businesses
2. If user navigates to `/businesses` → sees business list
3. User clicks a business card → `switchBusiness()` sets active → navigates to `/` (dashboard)
4. From sidebar: user can navigate sections as before
5. Sidebar "All Businesses" link → `/businesses`
6. Sidebar "New Business" link → `/businesses/new`

**Auto-redirect to business list when no active business:**

Add logic in AppRoutes: if authenticated and on `/` (root) and no active business → redirect to `/businesses`:

```tsx
import { Navigate } from "react-router";
import { useAtomValue } from "jotai";
import { activeBusinessIdAtom, businessesLoadedAtom } from "@/store/business-atoms";

export function AppRoutes() {
  const status = useAtomValue(authStatusAtom);
  const activeBusinessId = useAtomValue(activeBusinessIdAtom);
  const businessesLoaded = useAtomValue(businessesLoadedAtom);

  if (status === "loading") return <LoadingScreen />;
  if (status !== "authenticated") return <LoginPage />;

  return (
    <Routes>
      {/* Business management */}
      <Route path="/businesses" element={<BusinessListLayout />}>
        <Route index element={<BusinessList />} />
        <Route path="new" element={<CreateBusiness />} />
      </Route>

      {/* Business plan (sidebar layout) — redirect to /businesses if no active business */}
      <Route element={
        !businessesLoaded ? <LoadingScreen /> :
        !activeBusinessId ? <Navigate to="/businesses" replace /> :
        <DashboardLayout />
      }>
        <Route index element={<Dashboard />} />
        {/* ...all existing section routes unchanged... */}
      </Route>
    </Routes>
  );
}
```

**NOTE on `element` prop logic:** The Route element prop can accept a conditional. When `!businessesLoaded`, show loading. When `!activeBusinessId`, redirect to businesses list. Otherwise show DashboardLayout. This ensures users always pick a business before seeing sections.

**IMPORTANT:**
- Keep ALL existing route definitions (all 11 section routes)
- Keep LoginPage logic for unauthenticated users
- Keep LoadingScreen for loading state
- Add new imports: BusinessList, CreateBusiness, Navigate, Outlet, business atoms
- The Outlet import may already exist — check before adding duplicate
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>Router includes /businesses and /businesses/new routes. Auto-redirects to /businesses when no active business. All existing section routes preserved. BusinessListLayout provides clean layout for business pages.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `src/app/providers.tsx` includes BusinessLoader component
- [ ] `src/app/router.tsx` has /businesses and /businesses/new routes
- [ ] Existing section routes unchanged
- [ ] Auto-redirect to /businesses when no active business
- [ ] BusinessListLayout provides clean layout without sidebar
- [ ] Loading screen shown while businesses load
- [ ] No modifications to any files other than router.tsx and providers.tsx
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Businesses load automatically on authentication
- Business list accessible at /businesses
- Create business accessible at /businesses/new
- Dashboard and sections require active business (redirect otherwise)
- All existing routes continue to work
- Full navigation flow works: login → businesses → select → dashboard → sections
</success_criteria>

<output>
After completion, create `.planning/phases/02-business-crud/02-05-SUMMARY.md`
</output>
