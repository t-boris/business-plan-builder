---
phase: 02-business-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/store/business-atoms.ts, src/hooks/use-businesses.ts, src/lib/business-templates.ts]
autonomous: true
---

<objective>
Create the business state management foundation: Jotai atoms for active business and business list, a hook encapsulating all business operations (load, create, delete, switch), and client-side template definitions for the create flow UI.

Purpose: This is the foundation that every other Phase 2 plan depends on. Without atoms and the hook, no UI component can interact with businesses.

Output: `src/store/business-atoms.ts`, `src/hooks/use-businesses.ts`, `src/lib/business-templates.ts`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-business-crud/02-CONTEXT.md
@.planning/phases/01-firestore-data-model/01-01-SUMMARY.md
@.planning/phases/01-firestore-data-model/01-02-SUMMARY.md

@src/types/business.ts
@src/lib/business-firestore.ts
@src/store/auth-atoms.ts
@src/store/plan-atoms.ts
@src/hooks/use-auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create business state atoms</name>
  <files>src/store/business-atoms.ts</files>
  <action>
Create `src/store/business-atoms.ts` with Jotai atoms for multi-business state management.

Follow existing atom conventions: `Atom` suffix, camelCase, named exports.

**Atoms to create:**

```typescript
// The list of businesses the current user has access to
export const businessListAtom = atom<Business[]>([]);

// Whether business list has been loaded from Firestore
export const businessesLoadedAtom = atom(false);

// Active business ID (persisted to localStorage for session continuity)
// On init, read from localStorage. On change, write to localStorage.
export const activeBusinessIdAtom = atom<string | null>(null);

// Derived: the active Business object from the list
export const activeBusinessAtom = atom<Business | null>((get) => {
  const id = get(activeBusinessIdAtom);
  const list = get(businessListAtom);
  if (!id) return null;
  return list.find((b) => b.id === id) ?? null;
});

// Derived: loading state (not yet loaded)
export const businessesLoadingAtom = atom((get) => !get(businessesLoadedAtom));
```

**localStorage key:** `"active-business-id"` — Read on atom init is NOT done here (atoms are pure). The hook handles localStorage read/write.

**Conventions:**
- Import `atom` from `jotai`
- Import `Business` type from `@/types`
- Named exports only, no default export
- Follow existing pattern from `auth-atoms.ts` and `plan-atoms.ts`
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>All business atoms defined, exported, and compile. activeBusinessAtom derives from list + ID. businessesLoadingAtom derives from loaded flag.</done>
</task>

<task type="auto">
  <name>Task 2: Create business operations hook and template definitions</name>
  <files>src/hooks/use-businesses.ts, src/lib/business-templates.ts</files>
  <action>
**Part A: Create `src/lib/business-templates.ts`**

Client-side template definitions for the create business UI. These define what the template picker shows — NOT Firestore template documents (those come in Phase 6).

```typescript
import type { BusinessType } from "@/types";

export interface BusinessTypeTemplate {
  type: BusinessType;
  name: string;        // Display name: "SaaS / Software"
  icon: string;        // Lucide icon name: "Cloud", "Store", etc.
  description: string; // Short description for picker card
  defaultSections: string[];  // Section keys this type starts with
}

export const BUSINESS_TYPE_TEMPLATES: BusinessTypeTemplate[] = [
  {
    type: "saas",
    name: "SaaS / Software",
    icon: "Cloud",
    description: "Software-as-a-service, subscription-based products, digital platforms",
    defaultSections: ["executive-summary", "market-analysis", "product-service", "marketing-strategy", "operations", "financial-projections", "risks-due-diligence", "kpis-metrics", "launch-plan"],
  },
  {
    type: "service",
    name: "Service / Consulting",
    icon: "Users",
    description: "Professional services, consulting, freelance, agency businesses",
    defaultSections: ["executive-summary", "market-analysis", "product-service", "marketing-strategy", "operations", "financial-projections", "risks-due-diligence"],
  },
  {
    type: "retail",
    name: "Retail / E-commerce",
    icon: "ShoppingBag",
    description: "Physical or online stores, product-based businesses",
    defaultSections: ["executive-summary", "market-analysis", "product-service", "marketing-strategy", "operations", "financial-projections", "risks-due-diligence", "kpis-metrics"],
  },
  {
    type: "restaurant",
    name: "Restaurant / Food",
    icon: "UtensilsCrossed",
    description: "Restaurants, cafes, food trucks, catering, food delivery",
    defaultSections: ["executive-summary", "market-analysis", "product-service", "marketing-strategy", "operations", "financial-projections", "risks-due-diligence"],
  },
  {
    type: "event",
    name: "Event / Entertainment",
    icon: "PartyPopper",
    description: "Events, entertainment venues, experiences, recreation",
    defaultSections: ["executive-summary", "market-analysis", "product-service", "marketing-strategy", "operations", "financial-projections", "risks-due-diligence", "launch-plan"],
  },
  {
    type: "manufacturing",
    name: "Manufacturing",
    icon: "Factory",
    description: "Production, manufacturing, hardware, physical products at scale",
    defaultSections: ["executive-summary", "market-analysis", "product-service", "marketing-strategy", "operations", "financial-projections", "risks-due-diligence", "kpis-metrics"],
  },
  {
    type: "custom",
    name: "Custom",
    icon: "Sparkles",
    description: "Start from scratch with a blank business plan",
    defaultSections: ["executive-summary", "market-analysis", "product-service", "marketing-strategy", "operations", "financial-projections"],
  },
];
```

**Part B: Create `src/hooks/use-businesses.ts`**

Hook that encapsulates all business CRUD operations and state management. Follow existing hook conventions (camelCase, named export, returns object).

```typescript
export function useBusinesses() {
  // State access
  const businesses = useAtomValue(businessListAtom);
  const activeBusiness = useAtomValue(activeBusinessAtom);
  const isLoading = useAtomValue(businessesLoadingAtom);
  const setBusinessList = useSetAtom(businessListAtom);
  const setActiveBusinessId = useSetAtom(activeBusinessIdAtom);
  const setBusinessesLoaded = useSetAtom(businessesLoadedAtom);
  const { user } = useAuth();

  // Load businesses for current user from Firestore
  async function loadBusinesses() {
    if (!user) return;
    try {
      const list = await getUserBusinesses(user.uid);
      setBusinessList(list);

      // Restore active business from localStorage
      const storedId = localStorage.getItem("active-business-id");
      if (storedId && list.some((b) => b.id === storedId)) {
        setActiveBusinessId(storedId);
      } else if (list.length > 0) {
        setActiveBusinessId(list[0].id);
      }
    } catch { /* silent — app works without businesses loaded */ }
    finally { setBusinessesLoaded(true); }
  }

  // Switch active business
  function switchBusiness(businessId: string) {
    setActiveBusinessId(businessId);
    localStorage.setItem("active-business-id", businessId);
  }

  // Create a new business
  async function createNewBusiness(
    name: string,
    type: BusinessType,
    description: string
  ): Promise<string> {
    if (!user) throw new Error("Not authenticated");

    const now = new Date().toISOString();
    const template = BUSINESS_TYPE_TEMPLATES.find((t) => t.type === type);

    const businessId = await createBusiness({
      ownerId: user.uid,
      templateId: "",        // No Firestore template yet — filled in Phase 6
      templateVersion: 0,
      roles: { [user.uid]: "owner" },
      enabledSections: template?.defaultSections ?? [],
      profile: {
        name,
        type,
        industry: "",
        location: "",
        description,
        currency: "USD",
      },
      createdAt: now,
      updatedAt: now,
    });

    // Refresh list and switch to new business
    const updatedList = await getUserBusinesses(user.uid);
    setBusinessList(updatedList);
    switchBusiness(businessId);

    return businessId;
  }

  // Delete a business
  async function removeBusiness(businessId: string) {
    await deleteBusiness(businessId);
    // Remove from local list
    setBusinessList((prev) => prev.filter((b) => b.id !== businessId));
    // If deleted the active business, switch to first remaining
    const remaining = businesses.filter((b) => b.id !== businessId);
    if (remaining.length > 0) {
      switchBusiness(remaining[0].id);
    } else {
      setActiveBusinessId(null);
      localStorage.removeItem("active-business-id");
    }
  }

  return {
    businesses,
    activeBusiness,
    isLoading,
    loadBusinesses,
    switchBusiness,
    createNewBusiness,
    removeBusiness,
  };
}
```

**Imports to use:**
- `useAtomValue`, `useSetAtom` from `jotai`
- `useAuth` from `@/hooks/use-auth`
- Business atoms from `@/store/business-atoms`
- `getUserBusinesses`, `createBusiness`, `deleteBusiness` from `@/lib/business-firestore`
- `BUSINESS_TYPE_TEMPLATES` from `@/lib/business-templates`
- `BusinessType` type from `@/types`

**IMPORTANT:**
- Do NOT modify any existing files
- Named exports only
- Follow error handling pattern from existing hooks (silent catch at persistence boundaries)
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>useBusinesses hook exports loadBusinesses, switchBusiness, createNewBusiness, removeBusiness. Template definitions cover all 7 business types. All compile cleanly.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `src/store/business-atoms.ts` exports all atoms
- [ ] `src/hooks/use-businesses.ts` exports useBusinesses hook
- [ ] `src/lib/business-templates.ts` exports BUSINESS_TYPE_TEMPLATES
- [ ] Hook uses functions from `business-firestore.ts` (Phase 1 service layer)
- [ ] localStorage used for active business persistence
- [ ] No modifications to existing files
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Business state atoms provide: list, active ID, active business object, loading state
- Hook provides: load, switch, create, delete operations
- Template definitions cover all 7 BusinessType values
</success_criteria>

<output>
After completion, create `.planning/phases/02-business-crud/02-01-SUMMARY.md`
</output>
