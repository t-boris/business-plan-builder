# 22-01: JSON Import/Export for Business Plans

---
wave: 1
autonomous: true
---

## Objective

Add JSON export/import capabilities to the business switcher dropdown menu. Three actions:
1. **Export Business Data** — Download complete business snapshot as JSON
2. **Export JSON Schema** — Download a JSON Schema document describing the export format
3. **Import Business Data** — Upload a JSON file to overwrite current business data

## Execution Context

@src/lib/business-firestore.ts — Firestore CRUD functions (getSectionData, getBusinessVariables, listScenarioData, saveSectionData, saveBusinessVariables, saveScenarioData, updateBusiness)
@src/components/app-sidebar.tsx — Business switcher dropdown (DropdownMenu pattern)
@src/types/plan.ts — All 10 section type interfaces
@src/types/business.ts — Business, BusinessProfile, VariableDefinition types
@src/types/scenario.ts — DynamicScenario type
@src/lib/constants.ts — SECTION_SLUGS array (10 slugs)

## Context

The business switcher dropdown at the top of the sidebar currently shows: list of businesses, "New Business", "All Businesses". We add a separator and three new actions: Export Data, Export Schema, Import Data.

Data lives in:
- `businesses/{id}` — profile, enabledSections, roles
- `businesses/{id}/sections/{slug}` — raw section data (10 sections)
- `businesses/{id}/scenarios/{id}` — DynamicScenario documents
- `businesses/{id}/state/variables` — { definitions: Record<string, VariableDefinition> }

Export reads all of these via existing functions. Import writes back using existing save functions.

## Tasks

### Task 1: Create export/import utility — `src/lib/business-json.ts`

Create a new utility file with three functions:

**1a. `exportBusinessData(businessId: string): Promise<BusinessExportBundle>`**

Reads all data from Firestore and returns a typed bundle:

```typescript
interface BusinessExportBundle {
  version: '1.0';
  exportedAt: string;              // ISO timestamp
  profile: BusinessProfile;
  enabledSections: string[];
  sections: Record<string, unknown>; // slug -> raw section data
  variables: Record<string, VariableDefinition> | null;
  scenarios: DynamicScenario[];
}
```

Implementation:
1. `getBusiness(businessId)` — get profile + enabledSections
2. `Promise.all(SECTION_SLUGS.map(slug => getSectionData(businessId, slug)))` — all sections
3. `getBusinessVariables(businessId)` — variables
4. `listScenarioData(businessId)` — scenarios
5. Build and return the bundle

**1b. `downloadJson(data: unknown, filename: string): void`**

Helper that converts data to JSON string, creates a Blob, triggers browser download via temporary `<a>` element with `URL.createObjectURL`.

**1c. `generateExportSchema(): object`**

Returns a static JSON Schema (draft-07) object describing the `BusinessExportBundle` format. Covers:
- Root properties (version, exportedAt, profile, enabledSections, sections, variables, scenarios)
- BusinessProfile shape
- Section shapes (simplified — key fields per section type as described in plan.ts)
- VariableDefinition shape
- DynamicScenario shape (metadata + values + v2 fields)

This is a hand-crafted schema — TypeScript types aren't available at runtime.

**1d. `importBusinessData(businessId: string, bundle: BusinessExportBundle): Promise<void>`**

Validates the bundle format (checks `version`, `profile`, `sections` exist), then writes:
1. `updateBusiness(businessId, { profile: bundle.profile, enabledSections: bundle.enabledSections })` — update profile
2. `Promise.all(entries.map(([slug, data]) => saveSectionData(businessId, slug, data)))` — write all sections
3. If `bundle.variables`: `saveBusinessVariables(businessId, bundle.variables)` — write variables
4. For each scenario in `bundle.scenarios`: `saveScenarioData(businessId, scenario)` — write scenarios

Does NOT delete existing scenarios not in the bundle (additive for scenarios to avoid data loss). Sections and profile are overwritten (merge: true in saveSectionData handles this).

**1e. `validateExportBundle(data: unknown): data is BusinessExportBundle`**

Type guard that checks:
- `data` is object
- `data.version` is string
- `data.profile` is object with required BusinessProfile fields (name, type)
- `data.sections` is object
- Returns true if valid

### Task 2: Add UI to business switcher dropdown — `src/components/app-sidebar.tsx`

Add three menu items to the business switcher `DropdownMenuContent`, after the existing "All Businesses" item:

1. Add a `<DropdownMenuSeparator />`
2. **Export Data** — `<DropdownMenuItem>` with `Download` icon, calls `exportBusinessData()` then `downloadJson()`
3. **Export Schema** — `<DropdownMenuItem>` with `FileJson` icon (from lucide-react), calls `generateExportSchema()` then `downloadJson()`
4. **Import Data** — `<DropdownMenuItem>` that triggers a hidden `<input type="file" accept=".json">`. On file select, reads file via `FileReader`, parses JSON, validates with `validateExportBundle`, confirms with `window.confirm("This will overwrite all data...")`, calls `importBusinessData()`, then navigates to dashboard to force re-mount.

State needed in the component:
- `const fileInputRef = useRef<HTMLInputElement>(null)` for the hidden file input
- `const [importing, setImporting] = useState(false)` for loading state

Import the utility functions from `@/lib/business-json`.
Import `FileJson, Upload` from `lucide-react`.

Only show export/import items when `activeBusiness` exists and `userRole === 'owner'` (only owners can export/import).

### Task 3: Export `BusinessExportBundle` type from `src/types/index.ts`

Add the `BusinessExportBundle` interface to `src/lib/business-json.ts` (where it's used) and re-export it from the utility file. No changes to types/ needed since this is a utility type, not a Firestore document type.

## Verification

```bash
npx vite build        # builds successfully
npx vitest run        # all existing tests pass
npm run lint          # no new errors
```

Manual:
- Click business switcher dropdown → see Export Data, Export Schema, Import items
- Export Data → downloads `{business-name}-export.json` with complete data
- Export Schema → downloads `business-plan-schema.json` with JSON Schema
- Import → file picker opens, select valid JSON, confirm dialog, data overwrites, page refreshes
- Import invalid JSON → error alert, no data changed
- Non-owner users → export/import items not shown

## Success Criteria

- [ ] Complete business data exported as JSON (profile, 10 sections, variables, scenarios)
- [ ] JSON Schema document exported describing the full data structure
- [ ] Import overwrites current business data reliably
- [ ] UI accessible from business switcher dropdown
- [ ] Owner-only access control
- [ ] Build passes, all tests pass

## Output

New files:
- `src/lib/business-json.ts` — export/import utility functions

Modified files:
- `src/components/app-sidebar.tsx` — dropdown menu items + file input
