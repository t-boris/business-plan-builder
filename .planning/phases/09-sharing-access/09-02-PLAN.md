---
phase: 09-sharing-access
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified: [src/app/router.tsx, src/features/sharing/accept-invite.tsx, src/features/sharing/share-dialog.tsx, src/components/app-sidebar.tsx, src/app/layout.tsx]
autonomous: true
---

<objective>
Build the accept-invite flow and share dialog UI.

Purpose: Users can open `/invite/:inviteId` links, sign in, and instantly join a business. Business owners can generate share links with role selection, see who has access, and revoke access — Google Docs style.
Output: AcceptInvite page, /invite route, ShareDialog component integrated into sidebar/layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-sharing-access/09-RESEARCH.md
@.planning/phases/09-sharing-access/09-CONTEXT.md
@.planning/phases/09-sharing-access/09-01-SUMMARY.md

@src/app/router.tsx
@src/app/layout.tsx
@src/components/app-sidebar.tsx
@src/lib/business-firestore.ts
@src/types/business.ts
@src/hooks/use-businesses.ts
@src/hooks/use-auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AcceptInvite page and /invite route</name>
  <files>src/features/sharing/accept-invite.tsx, src/app/router.tsx</files>
  <action>
  **Create `src/features/sharing/accept-invite.tsx`:**

  A standalone page (no sidebar layout) that handles the invite acceptance flow:

  ```typescript
  import { useEffect, useState } from "react";
  import { useParams, useNavigate, Link } from "react-router";
  import { useAtomValue } from "jotai";
  import { authStatusAtom } from "@/store/auth-atoms";
  import { getInvite, acceptInvite, getBusiness } from "@/lib/business-firestore";
  import { useAuth } from "@/hooks/use-auth";
  import { Button } from "@/components/ui/button";
  import { Card, CardContent, CardHeader } from "@/components/ui/card";
  import { Loader2 } from "lucide-react";
  import type { BusinessInvite, Business } from "@/types";
  ```

  Component flow:
  1. Read `inviteId` from URL params
  2. Fetch invite doc via `getInvite(inviteId)`
  3. If invite is null or status !== "active" → show "Invalid or expired invite" message
  4. Fetch the business doc via `getBusiness(invite.businessId)` to show business name
  5. If user is not authenticated → show business name + "Sign in to join" + sign-in button (Google)
  6. If user is authenticated:
     - Check if user already has a role on this business (check business.roles[uid]) → if yes, redirect to `/business/${businessId}`
     - Otherwise, show business name, role being granted, and "Join Business" button
  7. On "Join Business" click → call `acceptInvite(inviteId, businessId, role, uid)` → navigate to `/business/${businessId}`

  State: `status: 'loading' | 'invalid' | 'ready' | 'already-member' | 'accepting' | 'error'`

  UI structure (centered card, no sidebar):
  ```tsx
  <div className="flex min-h-svh items-center justify-center bg-background">
    <Card className="w-full max-w-md">
      <CardHeader>
        <h1 className="text-xl font-semibold">Join {businessName}</h1>
        <p className="text-sm text-muted-foreground">
          You've been invited as {role === 'editor' ? 'an editor' : 'a viewer'}
        </p>
      </CardHeader>
      <CardContent>
        {/* Sign in button or Join button based on auth status */}
      </CardContent>
    </Card>
  </div>
  ```

  Need to add `getBusiness` to business-firestore.ts if it doesn't exist — a simple `getDoc` wrapper:
  ```typescript
  export async function getBusiness(businessId: string): Promise<Business | null> {
    const snap = await getDoc(doc(db, "businesses", businessId));
    if (!snap.exists()) return null;
    return { id: snap.id, ...snap.data() } as Business;
  }
  ```

  **Update `src/app/router.tsx`:**

  1. Import `AcceptInvite` from `@/features/sharing/accept-invite`
  2. Add the invite route BEFORE the catch-all redirect:
     ```tsx
     {/* Invite acceptance (no sidebar layout) */}
     <Route path="/invite/:inviteId" element={<AcceptInvite />} />

     {/* Catch-all: redirect to root */}
     <Route path="*" element={<Navigate to="/" replace />} />
     ```

  The invite URL survives the auth flow because `LoginPage` is rendered as a conditional element (not a redirect). When the user signs in, `status` changes to `authenticated`, the Routes render, and `/invite/:inviteId` matches.
  </action>
  <verify>Run `npx tsc --noEmit`. Navigate to `/invite/test-id` mentally — should show invalid invite (no such doc). Verify AcceptInvite component exists with all status states.</verify>
  <done>AcceptInvite page handles full flow: loading → invalid/ready → sign-in/join → navigate to business. Route added before catch-all. getBusiness helper added if needed.</done>
</task>

<task type="auto">
  <name>Task 2: Create ShareDialog and integrate into layout</name>
  <files>src/features/sharing/share-dialog.tsx, src/components/app-sidebar.tsx, src/app/layout.tsx</files>
  <action>
  **Create `src/features/sharing/share-dialog.tsx`:**

  Google Docs-style share dialog with:
  - Role picker (editor/viewer) + "Create Link" button
  - Active invites list showing role and copy-link button for each
  - Current members list showing email, role, and remove button (owner only)
  - Revoke button for each invite link

  ```typescript
  import { useState, useEffect, useCallback } from "react";
  import { useAtomValue } from "jotai";
  import { activeBusinessAtom } from "@/store/business-atoms";
  import { useAuth } from "@/hooks/use-auth";
  import {
    createInvite,
    listBusinessInvites,
    revokeInvite,
    removeBusinessRole,
  } from "@/lib/business-firestore";
  import type { BusinessInvite, BusinessRole } from "@/types";
  import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
  } from "@/components/ui/dialog";
  import { Button } from "@/components/ui/button";
  import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
  } from "@/components/ui/select";
  import { Share2, Copy, Check, Trash2, Link as LinkIcon } from "lucide-react";
  ```

  Component structure:
  ```tsx
  export function ShareDialog({ children }: { children?: React.ReactNode }) {
    const business = useAtomValue(activeBusinessAtom);
    const { user } = useAuth();
    const [invites, setInvites] = useState<BusinessInvite[]>([]);
    const [role, setRole] = useState<BusinessRole>("editor");
    const [copied, setCopied] = useState<string | null>(null);
    const [open, setOpen] = useState(false);

    // Check if current user is owner
    const isOwner = business && user
      ? business.roles[user.uid] === "owner"
      : false;
  ```

  Sections inside the dialog:
  1. **Create invite link** (owner only):
     - Role dropdown (editor/viewer) + "Create Link" button
     - On click: `createInvite(businessId, role, uid)` → refresh invites list

  2. **Active invite links** (owner only):
     - List each active invite with role badge, copy-link button, revoke button
     - Copy builds URL: `${window.location.origin}/invite/${invite.id}`
     - Revoke calls `revokeInvite(invite.id)` → refresh list

  3. **People with access**:
     - Iterate `Object.entries(business.roles)` → show email/uid, role badge
     - Owner can remove non-owner members via `removeBusinessRole(businessId, uid)`
     - Owner role shows "(You)" label, cannot be removed

  Load invites via `listBusinessInvites(businessId)` when dialog opens.

  Copy-to-clipboard with `navigator.clipboard.writeText()` + brief "Copied!" feedback using `copied` state with setTimeout.

  **Update `src/components/app-sidebar.tsx`:**

  Add a Share button in the Tools section of the sidebar, visible only to owners:

  1. Import `ShareDialog` from `@/features/sharing/share-dialog`
  2. Import `Share2` from `lucide-react`
  3. After the existing tools section items, add a Share menu item that wraps `ShareDialog`:
     ```tsx
     <SidebarMenuItem>
       <ShareDialog>
         <SidebarMenuButton tooltip="Share">
           <Share2 />
           <span>Share</span>
         </SidebarMenuButton>
       </ShareDialog>
     </SidebarMenuItem>
     ```

  The ShareDialog uses `DialogTrigger asChild` around its children prop, so the SidebarMenuButton becomes the trigger.

  To conditionally show only for owners, the sidebar needs the user's role. Read it from `activeBusiness.roles[user.uid]`:
  ```tsx
  const userRole = activeBusiness && user ? activeBusiness.roles[user.uid] : null;
  ```

  Only render the Share menu item when `userRole === "owner"`.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify ShareDialog is imported in app-sidebar.tsx. Verify share button only shows for owners. Verify copy URL format is correct.</verify>
  <done>ShareDialog provides full sharing management: create links with role, copy URLs, revoke links, view/remove members. Integrated into sidebar for owners only.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] `/invite/:inviteId` route exists in router before catch-all
- [ ] AcceptInvite handles: loading, invalid, ready (signed out), ready (signed in), already-member, accepting, error
- [ ] ShareDialog creates invite links with role selection
- [ ] ShareDialog copies invite URLs to clipboard
- [ ] ShareDialog lists active invites with revoke option
- [ ] ShareDialog shows current members with role and remove option
- [ ] Share button only visible to business owners in sidebar
</verification>

<success_criteria>

- Invite acceptance flow works end-to-end (open link → sign in → join → see business)
- Share dialog provides Google Docs-style sharing UX
- Owner-only access to sharing controls
- URL preserved through auth flow (no special return-URL handling needed)
- Full TypeScript compilation and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-sharing-access/09-02-SUMMARY.md`
</output>
