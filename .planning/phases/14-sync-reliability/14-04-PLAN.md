---
phase: 14-sync-reliability
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified: [src/hooks/use-business-variables.ts, src/hooks/use-businesses.ts, src/components/business-header-bar.tsx, src/app/layout.tsx]
autonomous: true
---

<objective>
Refactor useBusinessVariables and useBusinesses with sync status, add debounce to variable updates, mount SyncStatusIndicator in layout, and remove the old local-only "Saved" indicator.

Purpose: Complete sync visibility by instrumenting remaining hooks and showing the global sync indicator.
Output: All Firestore-writing hooks report sync status. Global indicator visible in app layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/14-sync-reliability/14-01-SUMMARY.md
@src/hooks/use-business-variables.ts
@src/hooks/use-businesses.ts
@src/components/business-header-bar.tsx
@src/lib/sync-status.ts
@src/store/sync-atoms.ts
@src/lib/retry.ts
@src/lib/logger.ts
@src/components/sync-status-indicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor useBusinessVariables with sync status and debounce</name>
  <files>src/hooks/use-business-variables.ts</files>
  <action>
Refactor useBusinessVariables:

1. **Import**: `createLogger`, `withRetry`, `updateSyncAtom`.
2. **Add logger**: `const log = createLogger('variables')`.
3. **Use sync atoms**: `const setSyncStatus = useSetAtom(updateSyncAtom)`.

4. **Replace all `.catch(console.error)` with sync-aware saves**. Create a shared save helper inside the hook:
   ```typescript
   const persistVariables = useCallback(async (vars: Record<string, VariableDefinition>) => {
     if (!businessId) return;
     setSyncStatus({ domain: 'variables', state: 'saving' });
     try {
       await withRetry(() => saveBusinessVariables(businessId, vars));
       setSyncStatus({ domain: 'variables', state: 'saved', lastSaved: Date.now() });
       log.info('saved', { businessId });
     } catch (err) {
       const message = err instanceof Error ? err.message : 'Variable save failed';
       setSyncStatus({ domain: 'variables', state: 'error', error: message });
       log.error('save.failed', { businessId, error: message });
     }
   }, [businessId, setSyncStatus]);
   ```

5. **Add debounce to updateVariableValue**: Currently every slider change fires an immediate Firestore write. Add a 500ms debounce (same pattern as useSection) so rapid value changes are batched into a single write.

6. **Use `persistVariables` in all mutation functions** (saveVariables, updateVariableValue, addVariable, removeVariable, updateVariableDefinition) instead of inline `.catch(console.error)`.

7. **Replace silent catch in loadVariables** with `log.warn('load.failed', ...)`.
  </action>
  <verify>grep -c "console.error" src/hooks/use-business-variables.ts returns 0. npx tsc -b 2>&1 | grep "use-business-variables" returns no errors.</verify>
  <done>All variable saves report sync status. Rapid value changes are debounced. No console.error calls remain.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor useBusinesses with sync status and logging</name>
  <files>src/hooks/use-businesses.ts</files>
  <action>
Refactor useBusinesses:

1. **Import**: `createLogger`, `updateSyncAtom`.
2. **Add logger**: `const log = createLogger('business')`.
3. **Use sync atoms**: `const setSyncStatus = useSetAtom(updateSyncAtom)`.

4. **updateProfile**: Replace `.catch(console.error)` with:
   ```
   setSyncStatus({ domain: 'profile', state: 'saving' });
   updateBusiness(activeBusiness.id, { profile: updatedProfile })
     .then(() => {
       setSyncStatus({ domain: 'profile', state: 'saved', lastSaved: Date.now() });
       log.info('profile.saved', { businessId: activeBusiness.id });
     })
     .catch((err) => {
       const message = err instanceof Error ? err.message : 'Profile save failed';
       setSyncStatus({ domain: 'profile', state: 'error', error: message });
       log.error('profile.save.failed', { businessId: activeBusiness.id, error: message });
     });
   ```

5. **toggleSection**: Same pattern — replace `.catch(console.error)` with sync-status-aware error handling.

6. **loadBusinesses**: Replace silent `catch {}` with `log.warn('load.failed', ...)`.
  </action>
  <verify>grep -c "console.error" src/hooks/use-businesses.ts returns 0</verify>
  <done>Profile/section saves report sync status. No console.error calls remain.</done>
</task>

<task type="auto">
  <name>Task 3: Mount SyncStatusIndicator and clean up old pattern</name>
  <files>src/components/business-header-bar.tsx, src/app/layout.tsx</files>
  <action>
1. **Mount SyncStatusIndicator**: Find the main layout component that wraps the business context pages (look for the component that contains the sidebar and main content area). Import and mount `<SyncStatusIndicator />` in the header/toolbar area, near where the existing "Saved" text appears. If there's a `BusinessContextLayout` or similar layout wrapper, place it there.

2. **Remove old local "Saved" indicator from BusinessHeaderBar**: The existing `showSaved` state, `saveTimerRef`, and the `<span>Saved</span>` JSX are now superseded by the global SyncStatusIndicator. Remove this local pattern. The `BusinessHeaderBar` still handles debouncing `updateProfile` calls — that stays. Just remove the local saved-state display logic.

3. **Verify the layout**: Make sure the SyncStatusIndicator is visible but unobtrusive. It should be in the same area as the old "Saved" text was.

Find the correct layout file by examining the router to see which component wraps the business-scoped pages.
  </action>
  <verify>npx vite build succeeds. grep "showSaved" src/components/business-header-bar.tsx returns no matches (removed).</verify>
  <done>Global SyncStatusIndicator mounted in layout. Old local "Saved" pattern removed from BusinessHeaderBar.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vite build` succeeds
- [ ] No `console.error` calls remain in use-business-variables.ts or use-businesses.ts
- [ ] SyncStatusIndicator visible in app layout
- [ ] Old "Saved" indicator removed from BusinessHeaderBar
- [ ] All Firestore-writing hooks report to sync atoms
</verification>

<success_criteria>

- All 4 Firestore-writing hooks (useSection, useScenarioSync, useBusinessVariables, useBusinesses) report sync status
- SyncStatusIndicator mounted and visible
- Variable value changes debounced
- No raw console.error calls in hook files
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-sync-reliability/14-04-SUMMARY.md`
</output>
