---
phase: 18-advanced-scenario-engine
plan: 07
type: execute
wave: 4
depends_on: ["18-04", "18-05"]
files_modified:
  - src/features/export/index.tsx
  - src/features/export/pdf/BusinessPlanDocument.tsx
autonomous: true
---

<objective>
Add scenario pack to the export: base plan + scenarios appendix with comparison table + decision summary.

Purpose: Exported business plan should include the scenario analysis, not just the active scenario's numbers.
Output: Updated web and PDF exports with multi-scenario appendix section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-advanced-scenario-engine/18-04-PLAN.md
@.planning/phases/18-advanced-scenario-engine/18-05-PLAN.md

@src/features/export/index.tsx
@src/features/export/pdf/BusinessPlanDocument.tsx
@src/features/scenarios/scenario-comparison.tsx
@src/types/scenario.ts
@src/store/scenario-atoms.ts
@src/lib/business-firestore.ts
@src/lib/formula-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scenario appendix to web export</name>
  <files>src/features/export/index.tsx</files>
  <action>
Read `src/features/export/index.tsx`. It currently exports the business plan with the active scenario's metrics.

Add a "Scenario Analysis" appendix section AFTER all the regular business plan sections:

1. **Load all scenarios on mount** (not just active): Call `listScenarioData(businessId)` to get all scenarios.

2. **Evaluate each scenario** using the formula engine (same pattern as ScenarioComparison):
   ```typescript
   function evaluateScenario(scenario: DynamicScenario, variables: Record<string, VariableDefinition>): Record<string, number> {
     const merged = { ...Object.fromEntries(Object.entries(variables).map(([k, v]) => [k, v.value])), ...scenario.values };
     return evaluateVariables(variables, merged);
   }
   ```

3. **Render "Scenario Analysis" section** in the web export view:
   - Section header: "Scenario Analysis"
   - **Active scenario summary:** Name, status badge, horizon, assumptions (if any)
   - **Comparison table:** All non-archived scenarios as columns. Rows = key computed variables (filter to currency/percent/count units). Show values with unit formatting.
   - **Recommendation** (if 2+ scenarios): Show which scenario has highest profit-related metric, with a brief "Based on financial metrics, {name} appears strongest" text.

4. **Pass scenario data to PDF generator:** Add `scenarioPack` to the data passed to `generateBusinessPlanPdf`:
   ```typescript
   interface ScenarioPack {
     active: { name: string; status: string; horizon: number; assumptions: ScenarioAssumption[] };
     scenarios: Array<{ name: string; status: string; metrics: Record<string, { label: string; value: number; unit: string }> }>;
   }
   ```

Filter out archived scenarios from the comparison (show only draft and active).
  </action>
  <verify>npm run build — passes. Web export shows scenario appendix.</verify>
  <done>Web export includes scenario analysis appendix with comparison table and active scenario summary.</done>
</task>

<task type="auto">
  <name>Task 2: Add scenario appendix to PDF export</name>
  <files>src/features/export/pdf/BusinessPlanDocument.tsx</files>
  <action>
Read `src/features/export/pdf/BusinessPlanDocument.tsx`. Add a "Scenario Analysis" page/section to the PDF document.

Add the `scenarioPack` prop to the document component (same interface as web export).

Render after all regular sections (before the back cover if one exists):

1. **Section title:** "Scenario Analysis" with the standard section header styling

2. **Active scenario block:**
   - Name + status badge text
   - Horizon: "{N} months"
   - Assumptions list (if any): bullet points with label: value

3. **Comparison table** (using @react-pdf/renderer Table pattern):
   - First column: metric label
   - One column per scenario (name in header)
   - Cells: formatted values (currency with $, percent with %, count plain)
   - Highlight the best value in each row with bold styling

4. **Recommendation text** at the bottom: simple `<Text>` with the recommendation from the web export logic.

Handle edge cases:
- If only 1 scenario: show active scenario summary without comparison table
- If no assumptions: omit assumptions section
- If scenarioPack is null/undefined: skip the entire Scenario Analysis page

Use existing PDF styles (styles.sectionTitle, styles.bodyText, styles.table patterns from the file).
  </action>
  <verify>npm run build — passes. npm run lint — passes.</verify>
  <done>PDF export includes Scenario Analysis page with comparison table and recommendation.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] Web export shows Scenario Analysis appendix
- [ ] PDF export includes Scenario Analysis page
- [ ] Comparison table formats values correctly
- [ ] Handles single-scenario gracefully (no comparison)
- [ ] Archived scenarios excluded from comparison
</verification>

<success_criteria>
- Both web and PDF exports include Scenario Analysis appendix
- Active scenario summary shows name, status, horizon, assumptions
- Comparison table shows key metrics across all non-archived scenarios
- Best values highlighted in comparison
- Graceful handling of edge cases (1 scenario, no assumptions, no pack data)
</success_criteria>

<output>
After completion, create `.planning/phases/18-advanced-scenario-engine/18-07-SUMMARY.md`
</output>
