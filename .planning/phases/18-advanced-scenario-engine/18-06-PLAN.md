---
phase: 18-advanced-scenario-engine
plan: 06
type: execute
wave: 4
depends_on: ["18-02", "18-04"]
files_modified:
  - src/lib/ai/context-builder.ts
  - src/hooks/use-ai-suggestion.ts
autonomous: true
---

<objective>
Update the AI context builder and suggestion hook to inject active scenario context — assumptions, selected variants, horizon, and status — so AI suggestions are scenario-aware.

Purpose: AI-generated content should reflect the specific scenario being modeled, not just the base business profile.
Output: Enhanced AI context with scenario assumptions, variant info, and effective section data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-advanced-scenario-engine/18-02-PLAN.md
@.planning/phases/18-advanced-scenario-engine/18-04-PLAN.md

@src/lib/ai/context-builder.ts
@src/hooks/use-ai-suggestion.ts
@src/lib/ai/section-prompts.ts
@src/store/scenario-atoms.ts
@src/types/scenario.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend context-builder with scenario context</name>
  <files>src/lib/ai/context-builder.ts</files>
  <action>
Read `src/lib/ai/context-builder.ts`. It currently has `buildScenarioContext(metrics, variableDefinitions)` which formats numeric metrics.

Add a new function `buildScenarioV2Context`:

```typescript
export function buildScenarioV2Context(config: {
  scenarioName: string;
  status: ScenarioStatus;
  horizonMonths: number;
  assumptions: ScenarioAssumption[];
  variantRefs: Record<string, string>;
  variantNames?: Record<string, string>;  // sectionSlug -> variant display name
}): string
```

This function builds an XML-tagged context block:

```xml
<active_scenario>
  <name>{scenarioName}</name>
  <status>{status}</status>
  <horizon>{horizonMonths} months</horizon>

  <assumptions>
    - {label}: {value}
    - {label}: {value}
    ...
  </assumptions>

  <section_variants>
    - Product & Service: using variant "{variantName}"
    - Operations: using base data
    ...
  </section_variants>
</active_scenario>
```

If assumptions is empty, omit the `<assumptions>` block.
If no variants selected, omit the `<section_variants>` block.

Update `buildPrompt` to accept an optional `scenarioV2Context?: string` parameter and include it after the existing `<scenario_metrics>` block:

```typescript
export function buildPrompt(config: {
  // existing params...
  scenarioV2Context?: string;
}): string
```

If `scenarioV2Context` is provided, append it to the prompt. Add an instruction: "Consider the active scenario context, assumptions, and any section variants when generating content."
  </action>
  <verify>npm run build — passes. No TypeScript errors in context-builder.ts.</verify>
  <done>AI context includes scenario name, status, horizon, assumptions, and variant selections.</done>
</task>

<task type="auto">
  <name>Task 2: Update use-ai-suggestion to pass scenario v2 context</name>
  <files>src/hooks/use-ai-suggestion.ts</files>
  <action>
Read `src/hooks/use-ai-suggestion.ts`. It currently calls `buildPrompt` with business profile, section data, and scenario metrics.

Update it to also pass v2 scenario context:

1. Import the new v2 atoms from `@/store/scenario-atoms`:
   - `scenarioAssumptionsAtom`
   - `scenarioVariantRefsAtom`
   - `scenarioStatusAtom`
   - `scenarioHorizonAtom`
   - `scenarioNameAtom` (already imported or available)

2. Import `buildScenarioV2Context` from `@/lib/ai/context-builder`

3. In the suggestion generation flow, read the v2 atom values via `useAtomValue` and build the v2 context:

```typescript
const assumptions = useAtomValue(scenarioAssumptionsAtom);
const variantRefs = useAtomValue(scenarioVariantRefsAtom);
const scenarioStatus = useAtomValue(scenarioStatusAtom);
const horizonMonths = useAtomValue(scenarioHorizonAtom);
const scenarioName = useAtomValue(scenarioNameAtom);

// Build v2 context
const scenarioV2Context = buildScenarioV2Context({
  scenarioName,
  status: scenarioStatus,
  horizonMonths,
  assumptions,
  variantRefs,
});
```

4. Pass `scenarioV2Context` to `buildPrompt`:

```typescript
const prompt = buildPrompt({
  // ...existing params,
  scenarioV2Context,
});
```

This ensures that when AI generates or improves section content, it has full awareness of the active scenario's assumptions and configuration.
  </action>
  <verify>npm run build — passes. npm run lint — passes.</verify>
  <done>AI suggestions receive scenario assumptions, status, horizon, and variant context. Generation is scenario-aware.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] buildScenarioV2Context formats assumptions and variants correctly
- [ ] buildPrompt includes v2 context when provided
- [ ] use-ai-suggestion passes v2 context to prompt builder
</verification>

<success_criteria>
- AI context builder includes scenario v2 data (assumptions, variants, horizon, status)
- use-ai-suggestion reads from v2 atoms and passes context
- Prompt includes instruction to consider scenario context
- No breaking changes to existing AI generation flow
</success_criteria>

<output>
After completion, create `.planning/phases/18-advanced-scenario-engine/18-06-SUMMARY.md`
</output>
