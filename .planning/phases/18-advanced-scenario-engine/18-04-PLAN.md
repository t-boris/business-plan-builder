---
phase: 18-advanced-scenario-engine
plan: 04
type: execute
wave: 3
depends_on: ["18-02", "18-03"]
files_modified:
  - src/features/scenarios/section-variants.tsx
  - src/features/scenarios/index.tsx
autonomous: true
---

<objective>
Implement section variant creation, storage, and selection for product-service, operations, and marketing-strategy sections. Users can snapshot current section data as a named variant and select variants per scenario.

Purpose: Enable scenarios to represent fundamentally different business configurations (e.g. premium vs budget pricing, lean vs full-team operations).
Output: SectionVariants component with snapshot/select/delete functionality, integrated into Variants tab.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-advanced-scenario-engine/18-01-PLAN.md
@.planning/phases/18-advanced-scenario-engine/18-02-PLAN.md
@.planning/phases/18-advanced-scenario-engine/18-03-PLAN.md

@src/types/scenario.ts
@src/types/plan.ts
@src/lib/business-firestore.ts
@src/lib/effective-plan.ts
@src/store/scenario-atoms.ts
@src/hooks/use-section.ts
@src/features/scenarios/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SectionVariants component with snapshot and selection</name>
  <files>src/features/scenarios/section-variants.tsx</files>
  <action>
Create `src/features/scenarios/section-variants.tsx`.

**Supported sections:** `['product-service', 'operations', 'marketing-strategy']` — define as a constant array of `SectionSlug` values with display labels.

**Props:** `canEdit: boolean`

**Data flow:**
- Read `scenarioVariantRefsAtom` from scenario-atoms (active scenario's variant selections)
- Read `activeBusinessIdAtom` from business-atoms for Firestore calls
- For each supported section, call `listSectionVariants(businessId, sectionSlug)` on mount to get available variants (from business-firestore.ts, added in Plan 01)

**UI structure:**

For each supported section, render a card:

1. **Section header:** Section display name (e.g. "Product & Service")

2. **Current selection:**
   - If scenario has a variantRef for this section → show selected variant name with "Clear" button
   - If no variant selected → show "Using base data" label

3. **Variant picker:** Dropdown/select showing all available variants for this section. Selecting one updates `scenarioVariantRefsAtom` by setting `{ ...refs, [sectionSlug]: variantId }`. Clearing removes the key.

4. **"Snapshot current" button** (when canEdit):
   - Prompts for a variant name (use `window.prompt` or inline input)
   - Loads the current section data via the section's Firestore path: `getDoc(doc(db, 'businesses', businessId, 'sections', sectionSlug))`
   - Saves as a new SectionVariant via `saveSectionVariant(businessId, sectionSlug, variant)` where variant has a new UUID, the name, and the section data snapshot
   - Refreshes the variants list

5. **Delete button** per variant (small X icon, when canEdit, with confirmation)

**Read-only mode:** When `!canEdit`, show variant selections but hide snapshot/delete controls.

Use shadcn components: `Card`, `Select`, `Button`, `Badge`.
Import lucide icons: `Camera` (snapshot), `X` (delete/clear), `Layers` (header).
  </action>
  <verify>npm run build — passes. npm run lint — passes.</verify>
  <done>SectionVariants component creates, lists, selects, and deletes section variants. Variant refs update scenario atoms.</done>
</task>

<task type="auto">
  <name>Task 2: Wire SectionVariants into Variants tab</name>
  <files>src/features/scenarios/index.tsx</files>
  <action>
Replace the Variants tab placeholder in index.tsx with the real SectionVariants component:

1. Import `SectionVariants` from `./section-variants`
2. Replace the placeholder div in the Variants TabsContent with `<SectionVariants canEdit={canEdit && !isPreview} />`

Also update `useScenarioSync` to persist v2 fields. Read the current `src/hooks/use-scenario-sync.ts`. It currently builds a `DynamicScenario` object from `scenarioValuesAtom`, `scenarioNameAtom`, and `currentScenarioIdAtom`.

Add the new v2 atoms to the sync:
- Import and watch `scenarioAssumptionsAtom`, `scenarioVariantRefsAtom`, `scenarioSectionOverridesAtom`, `scenarioStatusAtom`, `scenarioHorizonAtom`
- Include them in the DynamicScenario object passed to `saveScenarioData`:
  ```typescript
  const scenario: DynamicScenario = {
    metadata: { ... },
    values,
    assumptions,
    variantRefs,
    sectionOverrides,
    status,
    horizonMonths,
  };
  ```
- Add the new atoms to the useEffect dependency array so changes trigger auto-save

**File to also modify:** `src/hooks/use-scenario-sync.ts`
  </action>
  <verify>npm run build — passes. Variants tab shows SectionVariants component. Scenario sync persists v2 fields.</verify>
  <done>Variants tab functional. All v2 fields auto-save via useScenarioSync.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] Variants tab shows 3 section cards
- [ ] Snapshot creates a variant in Firestore
- [ ] Selecting a variant updates scenarioVariantRefsAtom
- [ ] v2 fields persist to Firestore via sync
</verification>

<success_criteria>
- 3 supported sections shown in Variants tab
- Snapshot current section data as named variant works
- Variant selection updates scenario state and persists
- Delete variant with confirmation works
- Auto-save includes all v2 fields
</success_criteria>

<output>
After completion, create `.planning/phases/18-advanced-scenario-engine/18-04-SUMMARY.md`
</output>
