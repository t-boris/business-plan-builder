---
phase: 18-advanced-scenario-engine
plan: 08
type: execute
wave: 5
depends_on: ["18-01", "18-02"]
files_modified:
  - src/lib/effective-plan.test.ts
  - src/types/scenario.test.ts
autonomous: true
---

<objective>
Write tests for the merge logic (effective-plan.ts) and scenario normalization (normalizeScenario), then run full build/lint/test verification.

Purpose: Ensure the core engine logic is correct and regression-safe. Validate that old scenarios load without migration.
Output: Test files with comprehensive coverage + clean build verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/18-advanced-scenario-engine/18-01-PLAN.md
@.planning/phases/18-advanced-scenario-engine/18-02-PLAN.md

@src/lib/effective-plan.ts
@src/types/scenario.ts
@vitest.config.ts
@src/features/sections/product-service/normalize.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test effective-plan merge logic</name>
  <files>src/lib/effective-plan.test.ts</files>
  <action>
Create `src/lib/effective-plan.test.ts` with Vitest tests for the merge functions.

**Tests for `deepMergeSection`:**

1. "merges flat objects — overlay fields replace base"
   - base: `{ a: 1, b: 2 }`, overlay: `{ b: 3, c: 4 }` → `{ a: 1, b: 3, c: 4 }`

2. "merges nested objects one level deep"
   - base: `{ x: { a: 1, b: 2 } }`, overlay: `{ x: { b: 3 } }` → `{ x: { a: 1, b: 3 } }`

3. "overlay arrays replace base arrays (not concatenate)"
   - base: `{ items: [1, 2, 3] }`, overlay: `{ items: [4, 5] }` → `{ items: [4, 5] }`

4. "skips undefined overlay values"
   - base: `{ a: 1, b: 2 }`, overlay: `{ a: undefined, b: 3 }` → `{ a: 1, b: 3 }`

5. "handles empty overlay (returns base)"
   - base: `{ a: 1 }`, overlay: `{}` → `{ a: 1 }`

**Tests for `computeEffectiveSection`:**

6. "returns base when no variant or overrides"
   - computeEffectiveSection(base, null, null) → base

7. "variant replaces base entirely"
   - computeEffectiveSection(base, variant, null) → variant

8. "overrides merge on top of base"
   - computeEffectiveSection(base, null, overrides) → deepMerge(base, overrides)

9. "overrides merge on top of variant (not base)"
   - computeEffectiveSection(base, variant, overrides) → deepMerge(variant, overrides)

10. "realistic ProductService scenario"
    - base: offerings with prices A
    - variant: offerings with prices B
    - overrides: `{ overview: "New overview" }`
    - Result: variant offerings + new overview

Run with: `npx vitest run src/lib/effective-plan.test.ts`
  </action>
  <verify>npx vitest run src/lib/effective-plan.test.ts — all 10 tests pass</verify>
  <done>10 tests covering deepMergeSection and computeEffectiveSection pass.</done>
</task>

<task type="auto">
  <name>Task 2: Test scenario normalization + full verification</name>
  <files>src/types/scenario.test.ts</files>
  <action>
Create `src/types/scenario.test.ts` with Vitest tests for `normalizeScenario`:

**Tests:**

1. "normalizes null/undefined to empty scenario with defaults"
   - normalizeScenario(null) → has metadata with UUID, values={}, assumptions=[], variantRefs={}, sectionOverrides={}, status='draft', horizonMonths=12

2. "normalizes old v1 scenario (values-only) to v2 with defaults"
   - Input: `{ metadata: {...}, values: { x: 1 } }` (no v2 fields)
   - Output: same metadata, same values, plus assumptions=[], variantRefs={}, sectionOverrides={}, status='draft', horizonMonths=12

3. "passes through complete v2 scenario unchanged"
   - Input: full v2 scenario with all fields populated
   - Output: identical

4. "handles partial v2 (some fields present, others missing)"
   - Input: scenario with assumptions but no variantRefs/status
   - Output: assumptions preserved, missing fields get defaults

5. "preserves existing metadata fields"
   - Verify id, name, description, createdAt, isBaseline are not modified

Run with: `npx vitest run src/types/scenario.test.ts`

**Full verification suite:**

After tests pass, run:
1. `npx vitest run` — all tests (including existing normalize tests, logger tests, etc.)
2. `npm run lint` — fix any lint errors in new/modified files
3. `npm run build` — ensure clean production build

Check for any regressions: existing 50+ tests should still pass.
  </action>
  <verify>npx vitest run — all tests pass (50+ existing + 15 new). npm run lint && npm run build — clean.</verify>
  <done>15 new tests pass. Full test suite green. Build and lint clean.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` — all tests pass
- [ ] `npm run lint` — passes
- [ ] `npm run build` — succeeds
- [ ] No regressions in existing tests
- [ ] New tests cover merge logic edge cases and normalization backward compat
</verification>

<success_criteria>
- 10 effective-plan merge tests covering: flat merge, nested merge, array replacement, undefined handling, variant+override composition
- 5 normalizeScenario tests covering: null input, v1 data, v2 passthrough, partial v2, metadata preservation
- Full build/lint/test suite passes with zero errors
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/18-advanced-scenario-engine/18-08-SUMMARY.md`
</output>
