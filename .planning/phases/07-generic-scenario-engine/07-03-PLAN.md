---
phase: 07-generic-scenario-engine
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: [src/features/scenarios/scenario-controls.tsx, src/features/scenarios/index.tsx, src/features/scenarios/scenario-dashboard.tsx]
autonomous: true
---

<objective>
Replace hardcoded scenario controls and dashboard with dynamic components driven by variable definitions. Merge the Editor and Variables tabs into a single experience where the controls ARE the variables.

Purpose: The scenario UI becomes generic — controls are generated from whatever variables the business has defined, KPI cards show whatever computed values exist. No business-specific hardcoding.
Output: DynamicScenarioControls, DynamicScenarioDashboard, and unified tab layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-generic-scenario-engine/07-RESEARCH.md
@.planning/phases/07-generic-scenario-engine/07-01-SUMMARY.md

@src/features/scenarios/scenario-controls.tsx
@src/features/scenarios/scenario-dashboard.tsx
@src/features/scenarios/index.tsx
@src/features/scenarios/variable-editor.tsx
@src/store/scenario-atoms.ts
@src/store/derived-atoms.ts
@src/store/business-atoms.ts
@src/types/business.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ScenarioControls as DynamicScenarioControls and merge tabs</name>
  <files>src/features/scenarios/scenario-controls.tsx, src/features/scenarios/index.tsx</files>
  <action>
  **In scenario-controls.tsx — Complete rewrite:**

  Keep the existing `SliderInput` and `NumberInput` helper components — they are generic and reusable. Replace the `ScenarioControls` component with `DynamicScenarioControls`.

  `DynamicScenarioControls`:
  - Reads `businessVariablesAtom` from business-atoms.ts using `useAtomValue`.
  - Reads/writes `scenarioValuesAtom` from scenario-atoms.ts using `useAtom`.
  - If definitions are null, render a message "No variables defined. Add variables in the Variables tab."
  - Filter to input variables only: `Object.values(definitions).filter(v => v.type === 'input')`.
  - Group by category using variable's `.category` field. Category display order: revenue, costs, unit_economics, growth, operations (use VARIABLE_CATEGORIES from types/business.ts if available, otherwise hardcode the order array).
  - For each category group, render a Card with CardHeader showing category label and CardContent with the variable inputs.
  - For each input variable, render the appropriate control:
    - `unit === 'currency'`: NumberInput with `prefix="$"`, min=variable.min ?? 0, max=variable.max
    - `unit === 'percent'`: SliderInput with `suffix="%"`, `displayMultiplier=100`, min=variable.min ?? 0, max=variable.max ?? 1, step=variable.step ?? 0.01
    - `unit === 'count'`: SliderInput with integer step, min=variable.min ?? 0, max=variable.max ?? 100, step=variable.step ?? 1
    - Default: NumberInput with min=variable.min, max=variable.max
  - `handleChange(variableId: string, newValue: number)`: `setValues(prev => ({ ...prev, [variableId]: newValue }))`.
  - Use `values[variable.id] ?? variable.value` for the current display value.

  Export both `DynamicScenarioControls` (named export) and keep `SliderInput`/`NumberInput` as unexported helpers (they are private to this module).

  **Category label helper:** Map category IDs to display labels: `{ revenue: 'Revenue', costs: 'Costs', unit_economics: 'Unit Economics', growth: 'Growth', operations: 'Operations' }`. Fall back to capitalizing the category ID for unknown categories.

  **In index.tsx — Merge Editor and Variables tabs:**

  1. Remove `VariableEditor` import.
  2. Replace `ScenarioControls` import with `DynamicScenarioControls` from `./scenario-controls.tsx`.
  3. Change tabs from 3 (Editor, Variables, Compare) to 2 (Editor, Compare):
     - Remove the `variables` TabsTrigger and TabsContent entirely.
     - In the `editor` TabsContent, replace `<ScenarioControls />` with `<DynamicScenarioControls />` in the left column. Keep `<ScenarioDashboard />` in the right column (it will be rewritten in Task 2).
  4. Keep all other page structure (header, ScenarioManager) unchanged.

  **Do NOT** delete `variable-editor.tsx` — it may still be used for advanced variable management (add/remove variables, edit formulas). It just loses its dedicated tab.
  </action>
  <verify>Grep for `DynamicScenarioControls` in scenario-controls.tsx and index.tsx. Verify `scenarioValuesAtom` and `businessVariablesAtom` are imported. Verify the Variables tab is removed from index.tsx (no `value="variables"` in TabsTrigger).</verify>
  <done>Controls are dynamically generated from variable definitions. Only 2 tabs remain (Editor, Compare). Scenario controls read/write scenarioValuesAtom. No hardcoded variable names in controls.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite ScenarioDashboard as DynamicScenarioDashboard</name>
  <files>src/features/scenarios/scenario-dashboard.tsx</files>
  <action>
  **Complete rewrite of scenario-dashboard.tsx:**

  Keep the existing helper functions: `formatCurrency`, `formatPercent`, `StatCard`, `getMarginColor`, `getProfitColor`. They are generic and reusable.

  Replace the `ScenarioDashboard` component with `DynamicScenarioDashboard`:

  1. Reads `businessVariablesAtom` from business-atoms.ts using `useAtomValue`.
  2. Reads `evaluatedValuesAtom` from derived-atoms.ts using `useAtomValue`.
  3. If definitions are null, render "Loading..."

  4. **KPI Cards:** Show ALL computed variables as stat cards. Filter definitions to `type === 'computed'`. For each computed variable:
     - Label: `variable.label`
     - Value: Format using `formatValue(evaluated[variable.id] ?? 0, variable.unit)`. The formatValue helper maps: currency → formatCurrency, percent → formatPercent, count/ratio/other → String(Math.round(value)).
     - Color: Apply semantic coloring for known patterns: if label contains "profit" or "margin" → use getProfitColor/getMarginColor. For "cost" or "spend" → text-amber-600. Otherwise → default text-foreground.

  5. **Revenue Projection Chart:** Keep the 12-month AreaChart but make it data-driven:
     - Look for a "monthly_revenue" or variable with label matching "Monthly Revenue" in evaluatedValuesAtom. If found, use that value as the base monthly revenue.
     - Look for a "monthly_costs" or variable with label matching "Monthly Costs". If found, use as base monthly costs.
     - If neither found, skip the chart section entirely.
     - Use flat projection (no ramp factors — those were Fun Box-specific). Just repeat the monthly values for 12 months with calendar month names Jan-Dec.
     - Keep the same chart styling (green for revenue, orange for costs).

  6. **Grid layout:** Use `grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3` for stat cards (same as current).

  **formatValue helper** (add to this file or reuse from variable-editor.tsx pattern):
  ```
  function formatValue(value: number, unit: VariableUnit): string {
    if (unit === 'currency') return formatCurrency(value);
    if (unit === 'percent') return formatPercent(value);
    if (unit === 'ratio') return value.toFixed(2);
    return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(value);
  }
  ```

  Export `DynamicScenarioDashboard` as the named export (replacing `ScenarioDashboard`). Keep the export name as `ScenarioDashboard` to avoid modifying index.tsx a second time — OR rename and update the import in index.tsx. Preferred: keep the name `ScenarioDashboard` so index.tsx doesn't need changes.

  **IMPORTANT:** Do NOT import from the old individual derived atoms (monthlyBookingsAtom, etc.). Import ONLY from `evaluatedValuesAtom` in derived-atoms.ts and `businessVariablesAtom` in business-atoms.ts.
  </action>
  <verify>Grep for `evaluatedValuesAtom` and `businessVariablesAtom` in scenario-dashboard.tsx. Verify no imports of individual derived atoms (monthlyBookingsAtom, avgCheckAtom, etc.). Verify the component still exports as `ScenarioDashboard`.</verify>
  <done>Dashboard renders computed variables dynamically as KPI cards. Chart uses evaluated revenue/cost values. No hardcoded metric names. Imports only from evaluatedValuesAtom and businessVariablesAtom.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] DynamicScenarioControls renders input variables grouped by category
- [ ] Controls read from scenarioValuesAtom and write via setValues spread
- [ ] ScenarioDashboard renders computed variables as StatCards from evaluatedValuesAtom
- [ ] Only 2 tabs in Scenarios page (Editor, Compare)
- [ ] No imports of old individual scenario atoms or derived atoms in modified files
</verification>

<success_criteria>

- All 3 files rewritten with dynamic variable-driven components
- Scenario controls generated from variable definitions, not hardcoded
- Dashboard KPIs derived from evaluatedValuesAtom
- Tab consolidation: Editor + Compare only
- No business-specific variable names in any component
</success_criteria>

<output>
After completion, create `.planning/phases/07-generic-scenario-engine/07-03-SUMMARY.md`
</output>
