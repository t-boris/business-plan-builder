---
phase: 07-generic-scenario-engine
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified: [src/features/scenarios/scenario-comparison.tsx, src/features/dashboard/index.tsx, src/store/scenario-atoms.ts, src/store/derived-atoms.ts, src/lib/constants.ts, src/types/scenario.ts, src/types/index.ts]
autonomous: true
---

<objective>
Migrate the remaining two consumers (ScenarioComparison, Dashboard) to dynamic atoms, then remove all legacy hardcoded atoms, types, and constants. This is the final plan of Phase 7 — after it completes, no hardcoded scenario code remains.

Purpose: Complete the migration and clean up dead code. The entire scenario engine now runs on dynamic variables from the Phase 6 variable library.
Output: Rewritten ScenarioComparison, updated Dashboard, and clean removal of all legacy scenario code.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-generic-scenario-engine/07-RESEARCH.md
@.planning/phases/07-generic-scenario-engine/07-02-SUMMARY.md
@.planning/phases/07-generic-scenario-engine/07-03-SUMMARY.md

@src/features/scenarios/scenario-comparison.tsx
@src/features/dashboard/index.tsx
@src/store/scenario-atoms.ts
@src/store/derived-atoms.ts
@src/lib/constants.ts
@src/lib/formula-engine.ts
@src/types/scenario.ts
@src/types/index.ts
@src/store/business-atoms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ScenarioComparison and update Dashboard</name>
  <files>src/features/scenarios/scenario-comparison.tsx, src/features/dashboard/index.tsx</files>
  <action>
  **In scenario-comparison.tsx — Complete rewrite for dynamic variables:**

  Keep the reusable helpers: `formatCurrency`, `formatPercent`, `DiffCell`, `WinnerBadge`, `isSignificantDiff`. They work with any numeric values.

  Replace `ScenarioComparison` component:

  1. Reads `businessVariablesAtom` from business-atoms.ts.
  2. Reads `activeBusinessIdAtom` from business-atoms.ts.
  3. Loads scenario list from Firestore: `listScenarioData(businessId)` — now returns `DynamicScenario[]`.
  4. Two scenario selectors (same UI pattern as current).

  5. **Input Variables Table:** Instead of hardcoded `VARIABLE_ROWS`, dynamically build rows from variable definitions:
     - Filter definitions to `type === 'input'`.
     - For each input variable: `{ id: v.id, label: v.label, unit: v.unit, lowerIsBetter: category is 'costs' }`.
     - Value from scenario: `scenario.values[v.id] ?? v.value`.
     - Format based on unit: currency → formatCurrency, percent → formatPercent, count → String.

  6. **Derived Metrics Table:** Instead of hardcoded `METRIC_ROWS`, evaluate each scenario's values and display computed variables:
     - Import `evaluateVariables` from `@/lib/formula-engine.ts`.
     - For each scenario, merge scenario.values into definitions (same pattern as evaluatedValuesAtom), call `evaluateVariables(merged)`.
     - Use `useMemo` for each scenario's evaluation.
     - Filter definitions to `type === 'computed'` for the metrics rows.
     - For each computed variable: `{ id: v.id, label: v.label, unit: v.unit, lowerIsBetter: category is 'costs' }`.
     - Value from evaluated results: `evaluatedA[v.id]` and `evaluatedB[v.id]`.

  7. **Bar Chart:** Build chart data dynamically. Look for computed variables with common labels: find variables where label contains "revenue", "cost", "profit", "spend". Build chartData from those variables. If no recognizable variables found, skip the chart.

  8. Remove all imports of old types: `Scenario`, `ScenarioVariables`, `ComputedMetrics`, `computeDerivedMetrics`. Import `DynamicScenario` from types and `evaluateVariables` from formula-engine.ts.

  **In dashboard/index.tsx — Update to use evaluatedValuesAtom:**

  1. Replace all individual derived atom imports (monthlyBookingsAtom, monthlyRevenueAtom, etc.) with a single import of `evaluatedValuesAtom` from derived-atoms.ts.
  2. Replace `scenarioNameAtom` import — keep it (it's a management atom, not being removed).
  3. Read `businessVariablesAtom` from business-atoms.ts.
  4. Read `evaluated = useAtomValue(evaluatedValuesAtom)` — this is the Record<string, number> of all values.

  5. **KPI Cards:** Instead of hardcoded KPI cards, dynamically render from computed variables:
     - If definitions are null, show loading state.
     - Filter to computed variables with `type === 'computed'`.
     - Pick "primary" KPIs (first 4 computed variables) for the top row, "secondary" (next 4) for the second row.
     - For each: label from `variable.label`, value from `evaluated[variable.id]`, format based on `variable.unit`.
     - Apply color heuristics: "revenue" → green, "profit" → profit color, "margin" → margin color, "cost"/"spend" → amber.

  6. **Revenue Projection Chart:** Same approach as scenario-dashboard (Plan 07-03):
     - Find "monthly_revenue" and "monthly_costs" variables in evaluated values.
     - Use flat 12-month projection with calendar months.
     - If no revenue variable found, skip the chart.

  7. **Section Links Grid:** Keep as-is — this is not scenario-related.

  8. Remove: All individual derived atom imports, `FLAT_SEASON_COEFFICIENTS` constant (projection no longer uses it), and the `dashboardFinancialsDefault` object (no longer needed since projection is flat).

  9. Keep: `scenarioNameAtom` import for the scenario badge in the header, `useSection` import for financial projections section (it's used for the section links grid area — actually check if it's still needed; if the only use was for seasonCoefficients, remove it).
  </action>
  <verify>Grep for `evaluatedValuesAtom` and `businessVariablesAtom` in dashboard/index.tsx. Grep for `evaluateVariables` in scenario-comparison.tsx. Verify no imports of old individual derived atoms (monthlyBookingsAtom, etc.) or computeDerivedMetrics remain in either file.</verify>
  <done>ScenarioComparison evaluates any variable set for side-by-side comparison. Dashboard renders KPIs from evaluatedValuesAtom. No hardcoded metric names in either component.</done>
</task>

<task type="auto">
  <name>Task 2: Remove legacy hardcoded atoms, types, and constants</name>
  <files>src/store/scenario-atoms.ts, src/store/derived-atoms.ts, src/lib/constants.ts, src/types/scenario.ts, src/types/index.ts</files>
  <action>
  **This task removes all dead code from the legacy hardcoded scenario system.** After Plans 07-02 and 07-03, nothing imports the old atoms/types anymore. Verify each removal by checking no file imports the symbol before deleting it.

  **In scenario-atoms.ts — Remove:**
  - `DEFAULT_SCENARIO_VARIABLES` import from constants.ts
  - Old `ScenarioVariables` and `Scenario` type imports
  - All 10 primitive atoms: priceTier1Atom, priceTier2Atom, priceTier3Atom, monthlyLeadsAtom, conversionRateAtom, cacPerLeadAtom, monthlyAdBudgetMetaAtom, monthlyAdBudgetGoogleAtom, staffCountAtom, costPerUnitAtom
  - Old `snapshotScenarioAtom` (replaced by snapshotInputValuesAtom)
  - Old `loadScenarioAtom` (replaced by loadDynamicScenarioAtom)
  - Old `resetToDefaultsAtom` (replaced by resetDynamicToDefaultsAtom)
  - **Keep:** scenarioNameAtom, scenarioSyncReadyAtom, currentScenarioIdAtom, scenarioListAtom, scenarioValuesAtom, snapshotInputValuesAtom, loadDynamicScenarioAtom, resetDynamicToDefaultsAtom

  **In derived-atoms.ts — Remove:**
  - ALL old individual derived atom imports from scenario-atoms.ts
  - `MONTHLY_FIXED_COSTS` import from constants.ts
  - `ComputedMetrics` interface
  - `computeDerivedMetrics` function
  - All 10 old derived atoms: monthlyBookingsAtom, avgCheckAtom, monthlyRevenueAtom, totalMonthlyAdSpendAtom, cacPerBookingAtom, monthlyCostsAtom, monthlyProfitAtom, annualRevenueAtom, annualProfitAtom, profitMarginAtom
  - **Keep:** evaluatedValuesAtom (and its imports)

  **In constants.ts — Remove:**
  - `DEFAULT_SCENARIO_VARIABLES` constant (entire object)
  - `MONTHLY_FIXED_COSTS` constant
  - **Keep:** SECTION_SLUGS, SECTION_LABELS (still used by other features)

  **In types/scenario.ts — Remove:**
  - `ScenarioVariables` interface (11 hardcoded fields)
  - `Scenario` interface (metadata + variables: ScenarioVariables)
  - `DerivedMetrics` interface
  - **Keep:** `ScenarioMetadata` interface (still used by DynamicScenario and scenarioListAtom)
  - **Keep:** `DynamicScenario` interface (added in Plan 07-01)

  **In types/index.ts — Update exports:**
  - Remove: `ScenarioVariables`, `Scenario`, `DerivedMetrics` from the scenario.ts export line
  - Keep: `ScenarioMetadata`, `DynamicScenario`

  **Also update business-firestore.ts** if it still imports `Scenario` type — it should only import `DynamicScenario` after Plan 07-02 (verify and fix if needed).

  **Before removing each symbol, verify no file imports it** using grep. If any file still references a symbol, investigate and fix the reference rather than keeping dead code.
  </action>
  <verify>Run `npx tsc --noEmit` to verify the full project compiles without errors. Grep for removed symbols (priceTier1Atom, monthlyBookingsAtom, ScenarioVariables, DEFAULT_SCENARIO_VARIABLES, MONTHLY_FIXED_COSTS, computeDerivedMetrics, ComputedMetrics) to confirm they appear NOWHERE in the codebase.</verify>
  <done>All legacy hardcoded scenario code removed. Full TypeScript build passes. No references to removed symbols anywhere in the codebase. Only dynamic atoms, types, and evaluation remain.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] No references to old atoms (priceTier1Atom, monthlyBookingsAtom, etc.) anywhere in codebase
- [ ] No references to old types (ScenarioVariables, Scenario, ComputedMetrics, DerivedMetrics) anywhere
- [ ] No references to old constants (DEFAULT_SCENARIO_VARIABLES, MONTHLY_FIXED_COSTS) anywhere
- [ ] ScenarioComparison evaluates scenarios using evaluateVariables
- [ ] Dashboard KPIs render from evaluatedValuesAtom
</verification>

<success_criteria>

- All legacy scenario code removed (10 primitive atoms, 10 derived atoms, computeDerivedMetrics, ComputedMetrics, ScenarioVariables, Scenario, DEFAULT_SCENARIO_VARIABLES, MONTHLY_FIXED_COSTS)
- ScenarioComparison works with any variable set
- Dashboard renders dynamic KPIs
- Full TypeScript compilation passes
- Full build succeeds
- Phase 7 complete: entire scenario engine is now dynamic and variable-driven
</success_criteria>

<output>
After completion, create `.planning/phases/07-generic-scenario-engine/07-04-SUMMARY.md`
</output>
