---
phase: 04-ai-and-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/ai/gemini-client.ts, src/lib/ai/system-prompt.ts, src/lib/ai/context-builder.ts, src/lib/ai/section-prompts.ts, src/hooks/use-ai-suggestion.ts, src/components/ai-action-bar.tsx, src/components/ai-suggestion-preview.tsx, src/features/sections/executive-summary/index.tsx, src/features/sections/market-analysis/index.tsx, src/features/sections/product-service/index.tsx, src/features/sections/marketing-strategy/index.tsx, src/features/sections/operations/index.tsx, src/features/sections/financial-projections/index.tsx, src/features/sections/risks-due-diligence/index.tsx, src/features/sections/kpis-metrics/index.tsx, src/features/sections/launch-plan/index.tsx]
autonomous: true
---

<objective>
Integrate Gemini 2.5 Pro AI assistance into all 9 business plan sections with per-section "Ask AI" functionality.

Purpose: Let the user generate, improve, or expand any section's content using AI that is aware of the full business context. This is one of the core features — when users don't have answers, they can ask AI.
Output: AI client infrastructure, contextual prompts per section, suggestion preview UI with accept/reject, "Ask AI" button on all 9 section pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-and-export/04-RESEARCH.md

Key source files:
@src/types/plan.ts
@src/hooks/use-section.ts
@src/lib/firestore.ts
@src/lib/constants.ts
@src/store/scenario-atoms.ts
@src/store/derived-atoms.ts
@src/features/sections/executive-summary/index.tsx
@src/features/sections/market-analysis/index.tsx
@src/features/sections/product-service/index.tsx
@src/features/sections/marketing-strategy/index.tsx
@src/features/sections/operations/index.tsx
@src/features/sections/financial-projections/index.tsx
@src/features/sections/risks-due-diligence/index.tsx
@src/features/sections/kpis-metrics/index.tsx
@src/features/sections/launch-plan/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gemini AI client infrastructure and per-section prompts</name>
  <files>src/lib/ai/gemini-client.ts, src/lib/ai/system-prompt.ts, src/lib/ai/context-builder.ts, src/lib/ai/section-prompts.ts</files>
  <action>
  1. Install required packages:
     ```
     npm install @google/genai zod-to-json-schema
     ```
     Note: `zod` should already be installed as a dependency of shadcn/ui. Verify with `npm ls zod`. If not installed, add it.

  2. Create `src/lib/ai/gemini-client.ts` — Gemini API client:
     - Import `GoogleGenAI` from `@google/genai`
     - Initialize with `import.meta.env.VITE_GEMINI_API_KEY`
     - Export a `generateSectionContent` function:
       ```typescript
       export async function generateSectionContent(
         prompt: string,
         systemInstruction: string,
       ): Promise<string>
       ```
       - Uses `ai.models.generateContent()` with model `gemini-2.5-flash` (cheaper, higher free-tier quota — good for MVP)
       - Config: `temperature: 1.0`, `maxOutputTokens: 8192`
       - Returns `response.text`
     - Export a `generateStructuredContent` function:
       ```typescript
       export async function generateStructuredContent<T>(
         prompt: string,
         systemInstruction: string,
         jsonSchema: object,
       ): Promise<T>
       ```
       - Uses `responseMimeType: 'application/json'` and `responseJsonSchema: jsonSchema`
       - Parses response with `JSON.parse(response.text)`
       - Returns typed result
     - **Error handling:** Wrap in try/catch. On 429 (rate limit), throw a user-friendly error "Rate limit reached, please wait a moment". On other errors, throw with the error message.
     - **If no API key:** Export a boolean `const isAiAvailable = !!import.meta.env.VITE_GEMINI_API_KEY` so the UI can conditionally show/hide AI features.

  3. Create `src/lib/ai/system-prompt.ts` — constant system instruction:
     ```typescript
     export const SYSTEM_INSTRUCTION = `You are a business plan writing assistant for "Fun Box," a premium mobile kids birthday party service in Miami.

     ROLE: Expert business plan writer with knowledge of Miami's entertainment and events market.

     TONE:
     - Professional but approachable
     - Data-driven: reference specific numbers when available
     - Concise: use bullet points and short paragraphs
     - Actionable: every recommendation should be implementable

     CONSTRAINTS:
     - Never invent financial numbers. Use only the data provided in the business context.
     - When data is missing, explicitly say "Data needed:" followed by what is required.
     - All monetary values in USD.
     - Target market: Miami metro, parents 28-50, 15-25 mile radius.
     - Three packages: Ocean Starter ($800), Ocean Explorer ($980), Ocean VIP ($1,200).

     OUTPUT FORMAT:
     - Return structured JSON matching the provided schema when a schema is specified.
     - Use markdown formatting within text fields (bold, bullets, headers).
     - Keep individual text fields under 500 words unless specifically asked to expand.`;
     ```

  4. Create `src/lib/ai/context-builder.ts` — builds contextual prompts:
     - `buildBusinessOverview()`: Returns a compressed 200-token summary of the business:
       ```
       BUSINESS: Fun Box — premium mobile kids birthday party service, Miami FL
       PACKAGES: Ocean Starter $800, Ocean Explorer $980, Ocean VIP $1,200 (15 pax each)
       TARGETS: 100-150 leads/month, 15-25% conversion, $10-30 CAC/lead
       LAUNCH: March 2026
       MARKET: Miami-Dade, 15-25 mile radius, parents 28-50
       ```
     - `buildScenarioContext(metrics: ComputedMetrics)`: Returns current scenario derived metrics formatted as text:
       ```
       SCENARIO METRICS: Monthly Revenue: $X, Monthly Profit: $X, Profit Margin: X%, Monthly Bookings: X, CAC/Booking: $X, Annual Revenue: $X
       ```
     - `buildSectionContext(sectionSlug: SectionSlug, sectionData: unknown)`: Returns the target section's data as JSON string.
     - `buildPrompt(config: { sectionSlug: SectionSlug; action: 'generate' | 'improve' | 'expand'; userInstruction?: string }, sectionData: unknown, scenarioMetrics: ComputedMetrics)`: Assembles the full prompt with XML-style tags:
       ```
       <business_context>
       [businessOverview]
       [scenarioContext]
       </business_context>

       <current_section>
       [sectionContext or "Empty — no data entered yet"]
       </current_section>

       <task>
       [action-specific instruction from section-prompts.ts]
       [optional user instruction]
       </task>
       ```

  5. Create `src/lib/ai/section-prompts.ts` — per-section prompt templates:
     - Export a `getSectionPrompt(slug: SectionSlug, action: 'generate' | 'improve' | 'expand'): string` function
     - For each section slug, return action-specific instructions. Key examples:
       - **executive-summary/generate**: "Generate an executive summary synthesizing the business context. Include: summary (2-3 paragraphs), mission (one sentence), vision (one sentence), keyHighlights (4-6 bullet points). Reflect ACTUAL numbers from context."
       - **market-analysis/generate**: "Generate market analysis for Fun Box. Include target demographic, market size estimate (TAM/SAM/SOM for Miami mobile kids entertainment), competitor analysis, and demographics. Use Miami-Dade data: population ~2.7M, 75.3% non-English speakers."
       - **financial-projections/generate**: "CRITICAL: Use ONLY the numbers from SCENARIO METRICS. Do not invent revenue or cost figures. Generate narrative around the provided financial data."
       - **risks-due-diligence/generate**: "Generate risk assessment using deep research findings: Miami-Dade parking regulations for large trailers, Jellyfish Museum contract dependency, FTSA compliance, slime/chemical activity risks, insurance requirements."
       - For **improve** actions: "Improve the existing content. Keep all current data, enhance descriptions, strengthen analysis, add specificity."
       - For **expand** actions: "Expand the existing content with more detail. Keep all current data, add depth to each area."
     - Also export `getSectionSchema(slug: SectionSlug): object | null` that returns a JSON schema (from `zod-to-json-schema`) matching the TypeScript interface for each section. Import the existing types from `@/types/plan.ts` and create Zod schemas that mirror them. Return `null` for sections where free-text generation is preferred over structured.
       - Use structured output (JSON schema) for: executive-summary, market-analysis, product-service, marketing-strategy, operations, risks-due-diligence, kpis-metrics, launch-plan
       - Use free-text for: financial-projections (narrative enhancement only — numbers come from scenario engine)

  **Do NOT** use Firebase AI Logic SDK — use direct `@google/genai` for MVP. Can migrate later.
  **Do NOT** add streaming — use non-streaming `generateContent` for structured JSON output. Simpler and sufficient.
  </action>
  <verify>npm run build succeeds. All 4 files compile without TypeScript errors. `isAiAvailable` export works.</verify>
  <done>AI client with generateSectionContent and generateStructuredContent functions, system prompt, context builder, and per-section prompt templates with Zod schemas for structured output</done>
</task>

<task type="auto">
  <name>Task 2: Create AI suggestion hook, UI components, and integrate into all 9 sections</name>
  <files>src/hooks/use-ai-suggestion.ts, src/components/ai-action-bar.tsx, src/components/ai-suggestion-preview.tsx, src/features/sections/executive-summary/index.tsx, src/features/sections/market-analysis/index.tsx, src/features/sections/product-service/index.tsx, src/features/sections/marketing-strategy/index.tsx, src/features/sections/operations/index.tsx, src/features/sections/financial-projections/index.tsx, src/features/sections/risks-due-diligence/index.tsx, src/features/sections/kpis-metrics/index.tsx, src/features/sections/launch-plan/index.tsx</files>
  <action>
  1. Create `src/hooks/use-ai-suggestion.ts` — React hook for AI request lifecycle:
     ```typescript
     interface AiSuggestionState {
       status: 'idle' | 'loading' | 'preview' | 'error';
       suggested: unknown | null;
       error: string | null;
     }

     function useAiSuggestion<T>(sectionSlug: SectionSlug) {
       // Returns: { state, generate, accept, reject }
     }
     ```
     - `generate(action, sectionData, userInstruction?)`:
       1. Set status to 'loading'
       2. Read scenario metrics from Jotai atoms using `useAtomValue(snapshotScenarioAtom)` + `computeDerivedMetrics()`
       3. Build prompt via `buildPrompt()`
       4. Get section schema via `getSectionSchema(slug)`
       5. If schema exists: call `generateStructuredContent()` with the schema
       6. If no schema: call `generateSectionContent()` for free text
       7. On success: set status to 'preview', store result in `suggested`
       8. On error: set status to 'error', store error message
     - `accept()`: Returns the suggested data (caller is responsible for saving via updateData)
     - `reject()`: Reset state to idle, clear suggested
     - Import `isAiAvailable` from gemini-client — if false, `generate` immediately sets error "Gemini API key not configured"

  2. Create `src/components/ai-action-bar.tsx` — "Ask AI" dropdown button:
     - Props: `{ onGenerate, onImprove, onExpand, isLoading, disabled }`
     - Renders a Button with Sparkles icon + "Ask AI" label
     - On click, shows a dropdown (use shadcn/ui DropdownMenu — may need to install: `npx shadcn@latest add dropdown-menu`):
       - "Generate" — fill from scratch using AI
       - "Improve" — enhance existing content
       - "Expand" — add more detail
     - When `isLoading` is true, show a spinner and disable the button
     - When `disabled` is true (no API key), show tooltip "Configure VITE_GEMINI_API_KEY to enable AI"
     - Compact design: fits in the section header next to the title

  3. Create `src/components/ai-suggestion-preview.tsx` — suggestion display with accept/reject:
     - Props: `{ onAccept, onReject, isLoading, children }`
     - Wraps the section's content area when AI has generated a suggestion
     - Shows a banner at the top: Sparkles icon + "AI Suggestion" label
     - Shows Accept (green) and Reject (outline) buttons
     - The `children` prop contains the section's form UI pre-filled with AI-suggested values
     - When `isLoading`: shows a loading skeleton with "Generating..." text and a Loader2 spinner

  4. Integrate into all 9 section pages. For EACH section component (ExecutiveSummary, MarketAnalysis, ProductService, MarketingStrategy, Operations, FinancialProjections, RisksDueDiligence, KpisMetrics, LaunchPlan):
     - Import `useAiSuggestion`, `AiActionBar`, `AiSuggestionPreview`
     - Add `useAiSuggestion<SectionType>(sectionSlug)` hook call
     - Add `AiActionBar` next to the section title (in the existing heading area):
       ```tsx
       <div className="flex items-center justify-between">
         <h1 className="text-3xl font-bold tracking-tight">Section Name</h1>
         <AiActionBar
           onGenerate={() => aiSuggestion.generate('generate', data)}
           onImprove={() => aiSuggestion.generate('improve', data)}
           onExpand={() => aiSuggestion.generate('expand', data)}
           isLoading={aiSuggestion.state.status === 'loading'}
           disabled={!isAiAvailable}
         />
       </div>
       ```
     - When `aiSuggestion.state.status === 'preview'`:
       - Show `AiSuggestionPreview` wrapper with accept/reject buttons
       - On accept: call `updateData(() => aiSuggestion.accept())` to save AI data to state + Firestore
       - On reject: call `aiSuggestion.reject()` to discard
       - Display the AI-suggested data using the SAME form UI but with `suggested` values
     - When `aiSuggestion.state.status === 'error'`:
       - Show a small error alert below the title with the error message and a "Dismiss" button
     - **Financial Projections special case:** AI cannot generate numbers (comes from scenario engine). The generate action should only produce narrative/descriptive text. Use the free-text prompt, and display the AI response as a suggestion card below the P&L table (not replacing it).

  **Pattern for section integration (same for all 9 sections):**
  The modification is minimal per section — add ~15 lines of hook usage + AiActionBar in header + conditional AiSuggestionPreview wrapper. The existing form UI stays exactly the same.

  **Do NOT** auto-save AI suggestions — user must explicitly click Accept.
  **Do NOT** add streaming/typewriter — just show loading state then full result.
  **Do NOT** modify the existing form inputs or data flow — AI operates as a suggestion layer.
  </action>
  <verify>npm run build succeeds. All 9 section pages show "Ask AI" button. Clicking "Generate" with a valid API key triggers Gemini and shows suggestion preview. Accept saves to state. Reject clears suggestion.</verify>
  <done>AI suggestion hook and UI components work. All 9 sections have "Ask AI" dropdown. Generated suggestions show in preview with accept/reject. AI is context-aware (sees business data + scenario metrics).</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `@google/genai` and `zod-to-json-schema` installed
- [ ] AI client functions compile and export correctly
- [ ] System prompt covers all constraints
- [ ] All 9 sections have "Ask AI" button in header
- [ ] AI generates structured content matching section TypeScript interfaces
- [ ] Accept saves AI data via updateData
- [ ] Reject clears suggestion preview
- [ ] Error state shows user-friendly message
- [ ] `isAiAvailable` correctly detects missing API key
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- AI integration works end-to-end (click Ask AI → generate → preview → accept)
- No TypeScript errors
- Existing section functionality unchanged (AI is additive only)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-and-export/04-01-SUMMARY.md`
</output>
