---
phase: 04-ai-and-export
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/features/export/index.tsx, src/features/export/business-plan-view.tsx, src/features/export/pdf/BusinessPlanDocument.tsx, src/features/export/pdf/CoverPage.tsx, src/features/export/pdf/SectionPage.tsx, src/features/export/pdf/PageFooter.tsx, src/features/export/pdf/pdfStyles.ts, src/features/export/pdf/useChartCapture.ts, src/features/export/pdf/generatePdf.ts]
autonomous: true
---

<objective>
Build a polished read-only business plan view and PDF export with professional formatting.

Purpose: Let the user see their complete business plan as a polished document and export it as a professional PDF. This is the final deliverable — all the section data, scenario metrics, and AI-enhanced content come together here.
Output: In-app read-only business plan view pulling from all sections + selected scenario, PDF export with cover page, table of contents, all sections, and financial charts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-and-export/04-RESEARCH.md

Key source files:
@src/types/plan.ts
@src/hooks/use-section.ts
@src/lib/firestore.ts
@src/lib/constants.ts
@src/store/scenario-atoms.ts
@src/store/derived-atoms.ts
@src/features/export/index.tsx
@src/features/sections/financial-projections/index.tsx
@src/app/router.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build polished read-only business plan view</name>
  <files>src/features/export/index.tsx, src/features/export/business-plan-view.tsx</files>
  <action>
  1. Create `src/features/export/business-plan-view.tsx` — read-only business plan display:
     - Load ALL 9 sections from Firestore using `useSection` hook for each (or a batch load approach)
     - Load scenario metrics from Jotai derived atoms
     - Display as a polished, scroll-through document with clear visual hierarchy:

     **Layout structure (vertical scroll):**
     - **Header section:** "Fun Box — Business Plan" title, current date, active scenario name badge
     - **Table of Contents:** Numbered list of all 9 sections as anchor links (click to scroll)
     - **Section 1: Executive Summary** — summary text, mission, vision, key highlights as bullet points
     - **Section 2: Market Analysis** — target demographic, market size, competitor table, demographics
     - **Section 3: Product & Service** — package cards (3), add-ons list
     - **Section 4: Marketing Strategy** — channel cards with budgets, offers list, landing page info
     - **Section 5: Operations** — crew table, capacity stats, equipment list, safety protocols
     - **Section 6: Financial Projections** — KPI summary (from scenario metrics), unit economics table, 12-month P&L table (read-only), revenue vs costs chart (Recharts AreaChart, same as the section page but non-editable)
     - **Section 7: Risks & Due Diligence** — risk cards by severity, compliance checklist
     - **Section 8: KPIs & Metrics** — target metrics grid
     - **Section 9: Launch Plan** — stage timeline with task statuses

     **Styling:**
     - Use a clean, print-friendly layout with a max-width container (~800px centered)
     - Each section separated by a horizontal rule or subtle border
     - Section numbers and headers styled as h2 with section numbering
     - Tables use clean borders, alternating row backgrounds
     - Stat cards for KPIs (from scenario derived atoms): Monthly Revenue, Monthly Profit, Profit Margin, Monthly Bookings — displayed at the top of Financial Projections section
     - Color-coded severity badges for risks (same pattern as the section page)
     - Use `prose` Tailwind class for text readability

     **Scenario integration:**
     - Read `scenarioNameAtom` for active scenario name display
     - Read derived atoms (monthlyRevenueAtom, monthlyProfitAtom, profitMarginAtom, etc.) for KPI stats in the financial section
     - Read `snapshotScenarioAtom` for scenario variable values to display in a "Scenario Parameters" card at the top

     **Data handling:**
     - Each section loads with `useSection` hook — reuse existing default data as fallback
     - If a section is empty/loading, show a subtle "No data entered" placeholder
     - All data is read-only — no edit controls, no inputs

  2. Replace `src/features/export/index.tsx` — the export page:
     - Show a tabbed interface (shadcn/ui Tabs):
       - Tab 1: "Business Plan" — shows the `BusinessPlanView` component
       - Tab 2: "Export" — shows export controls:
         - "Download PDF" button (disabled initially with "Coming soon" — Task 2 will enable it)
         - Scenario selector: which scenario's metrics to include in the export
         - Date display: "Generated on [date]"
     - The BusinessPlanView is the primary content — this IS the polished business plan

  **Do NOT** add edit controls on this page — editing happens on individual section pages.
  **Use the same Recharts chart** from financial-projections section but with `isAnimationActive={false}` for PDF capture readiness.
  </action>
  <verify>npm run build succeeds. Export page shows tabbed interface. Business Plan tab displays all 9 sections as a polished read-only document with scenario metrics.</verify>
  <done>Polished business plan view displays all sections with scenario integration, KPI stats, financial chart, and print-friendly layout</done>
</task>

<task type="auto">
  <name>Task 2: Implement PDF export with @react-pdf/renderer</name>
  <files>src/features/export/pdf/BusinessPlanDocument.tsx, src/features/export/pdf/CoverPage.tsx, src/features/export/pdf/SectionPage.tsx, src/features/export/pdf/PageFooter.tsx, src/features/export/pdf/pdfStyles.ts, src/features/export/pdf/useChartCapture.ts, src/features/export/pdf/generatePdf.ts, src/features/export/index.tsx</files>
  <action>
  1. Install required packages:
     ```
     npm install @react-pdf/renderer recharts-to-png@3 file-saver
     npm install -D @types/file-saver
     ```

  2. Create `src/features/export/pdf/pdfStyles.ts` — shared PDF stylesheet:
     - Use `StyleSheet.create()` from @react-pdf/renderer
     - Define styles for: page (margins, font), heading (section titles), body text, tables (rows, cells, headers), stat cards, cover page, footer
     - Use professional fonts (Helvetica — built-in, no registration needed)
     - Page size: A4, margins: 40pt top/bottom, 50pt left/right

  3. Create `src/features/export/pdf/PageFooter.tsx` — fixed footer component:
     - Uses `<Text fixed>` with `render` prop for page numbers: "Page X of Y"
     - Positioned at bottom of each page with absolute positioning
     - Includes "Fun Box Business Plan" text on left, page number on right

  4. Create `src/features/export/pdf/CoverPage.tsx` — cover page:
     - Centered layout with:
       - "Fun Box" title (large, bold)
       - "Business Plan" subtitle
       - Date line: "Generated [current date]"
       - Scenario badge: "Based on: [scenario name]"
       - Key metrics summary: Monthly Revenue, Annual Revenue, Profit Margin, Monthly Bookings
     - Professional look with a blue accent line/border

  5. Create `src/features/export/pdf/SectionPage.tsx` — reusable section page component:
     - Props: `{ number: number; title: string; children: ReactNode }`
     - Renders section number + title as a header
     - Wraps children in a styled container
     - Adds bookmark for PDF navigation: `<Page bookmark={title}>`
     - Forces page break before each section

  6. Create `src/features/export/pdf/BusinessPlanDocument.tsx` — main PDF document:
     - Props: all 9 section data objects + scenario metrics + scenario name + chart images (PNG base64 strings)
     - Structure:
       ```
       <Document>
         <CoverPage ... />
         <SectionPage number={1} title="Executive Summary">
           [summary text, mission, vision, highlights as bullet list]
         </SectionPage>
         <SectionPage number={2} title="Market Analysis">
           [demographic info, market size, competitors table, demographics]
         </SectionPage>
         ... (all 9 sections)
       </Document>
       ```
     - **Tables:** Build with flexbox Views — `<View style={{flexDirection: 'row'}}>` for rows, fixed-width `<View>` for cells. Use for:
       - Competitors table (Market Analysis)
       - Crew table (Operations)
       - Monthly P&L table (Financial Projections) — condensed to key columns: Month, Revenue, Costs, Profit
       - KPI targets table
     - **Charts:** Render financial charts as `<Image src={chartImageBase64} />` — the PNG is captured in useChartCapture
     - **Stat cards:** Simple bordered Views with label + value for KPI metrics
     - **Risk badges:** Text with colored backgrounds for severity
     - **If section data is null/empty:** Show "[Section Name] — No data entered" placeholder

  7. Create `src/features/export/pdf/useChartCapture.ts` — hook to capture Recharts as PNG:
     - Uses `recharts-to-png`'s `useGenerateImage` hook pattern
     - Returns `{ captureChart: () => Promise<string>, ref: RefObject }`
     - The ref attaches to a hidden `<div>` containing the Recharts chart with `isAnimationActive={false}`
     - `captureChart()` returns base64 data URI

  8. Create `src/features/export/pdf/generatePdf.ts` — orchestrates PDF generation:
     - Export `async function generateBusinessPlanPdf(params: { sections, scenarioMetrics, scenarioName, chartImages }): Promise<Blob>`
     - Uses `pdf(<BusinessPlanDocument ... />).toBlob()` from @react-pdf/renderer
     - Returns the blob for download

  9. Update `src/features/export/index.tsx` — wire up PDF export:
     - Import `generatePdf` via `React.lazy` to avoid loading the ~533kB @react-pdf/renderer bundle on initial page load
     - Add a hidden `<div>` with the financial chart (Recharts AreaChart, `isAnimationActive={false}`) for chart capture
     - "Download PDF" button in the Export tab:
       1. Captures chart as PNG via useChartCapture
       2. Collects all section data (already loaded for BusinessPlanView)
       3. Calls generateBusinessPlanPdf()
       4. Uses `saveAs(blob, 'fun-box-business-plan.pdf')` from file-saver
     - Show loading state on button while PDF generates ("Generating PDF...")
     - On error, show toast/alert with error message

  **Do NOT** use streaming PDF generation — `pdf().toBlob()` is synchronous-ish and fast enough for this document size.
  **Lazy-load** the PDF components — use dynamic import so @react-pdf/renderer only loads when user clicks export.
  **Charts must have** `isAnimationActive={false}` on ALL Recharts components used for PDF capture — otherwise captures mid-animation blank.
  </action>
  <verify>npm run build succeeds. "Download PDF" button generates and downloads a multi-page PDF with cover page, all 9 sections, financial chart, and page numbers.</verify>
  <done>PDF export generates a professional multi-page business plan PDF with cover page, all sections, tables, financial chart, KPI stats, and page numbers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] @react-pdf/renderer and recharts-to-png installed
- [ ] Business plan view shows all 9 sections as polished read-only document
- [ ] Scenario metrics displayed in financial section KPI cards
- [ ] Financial chart renders in business plan view
- [ ] PDF download generates multi-page document
- [ ] Cover page shows business name, date, scenario name, key metrics
- [ ] All 9 sections appear in PDF with correct data
- [ ] Financial chart embedded as image in PDF
- [ ] Page numbers appear on every page
- [ ] PDF lazy-loads (doesn't affect initial bundle)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Business plan view is polished and readable
- PDF export works end-to-end
- No TypeScript errors
- Bundle size increase is minimized via lazy loading
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-and-export/04-02-SUMMARY.md`
</output>
