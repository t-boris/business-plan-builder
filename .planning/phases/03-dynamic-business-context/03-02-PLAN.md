---
phase: 03-dynamic-business-context
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [src/app/router.tsx, src/app/layout.tsx, src/components/app-sidebar.tsx, src/hooks/use-businesses.ts, src/app/providers.tsx]
autonomous: true
---

<objective>
Replace the flat route structure (`/market-analysis`, `/scenarios`, etc.) with business-scoped URLs (`/business/:businessId/market-analysis`). The URL becomes the single source of truth for which business is active. Sidebar navigation becomes dynamic — only showing sections enabled for the current business.

Purpose: After this plan, every page in the app is URL-addressable under a specific business. Bookmarkable, shareable, and browser back/forward works naturally across business switches.
Output: Business-scoped routing, dynamic sidebar, error handling for invalid business IDs, and URL-driven business context.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dynamic-business-context/03-CONTEXT.md
@.planning/phases/03-dynamic-business-context/03-01-SUMMARY.md

@src/app/router.tsx
@src/app/layout.tsx
@src/app/providers.tsx
@src/components/app-sidebar.tsx
@src/hooks/use-businesses.ts
@src/store/business-atoms.ts
@src/types/business.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor router for /business/:businessId/ URL structure with BusinessContext</name>
  <files>src/app/router.tsx, src/hooks/use-businesses.ts, src/app/providers.tsx</files>
  <action>
  **Step 1: Create `BusinessContextLayout` component in `router.tsx`.**

  This is the key component that makes the URL the single source of truth for business context. It wraps all business-scoped routes:

  ```
  function BusinessContextLayout() {
    const { businessId } = useParams<{ businessId: string }>();
    const businesses = useAtomValue(businessListAtom);
    const businessesLoaded = useAtomValue(businessesLoadedAtom);
    const setActiveBusinessId = useSetAtom(activeBusinessIdAtom);

    // Sync URL param → atom + localStorage (URL is source of truth)
    useEffect(() => {
      if (businessId) {
        setActiveBusinessId(businessId);
        localStorage.setItem('active-business-id', businessId);
      }
    }, [businessId, setActiveBusinessId]);

    // Loading state: businesses not yet loaded from Firestore
    if (!businessesLoaded) return <LoadingScreen />;

    // Validate business exists in user's list
    const businessExists = businesses.some(b => b.id === businessId);
    if (!businessExists) return <BusinessNotFoundPage />;

    return <DashboardLayout />;
  }
  ```

  **Step 2: Create `BusinessNotFoundPage` component in `router.tsx`.**

  Simple error page with "Business not found" message and a link back to `/businesses`. Style it similarly to `LoadingScreen` — centered, minimal, with a button/link to go back.

  **Step 3: Create `RootRedirect` component in `router.tsx`.**

  Handles the root `/` route — redirects to the last-used business or the business list:

  ```
  function RootRedirect() {
    const businesses = useAtomValue(businessListAtom);
    const businessesLoaded = useAtomValue(businessesLoadedAtom);

    if (!businessesLoaded) return <LoadingScreen />;

    // Try localStorage first, then first business in list
    const storedId = localStorage.getItem('active-business-id');
    const targetId = (storedId && businesses.some(b => b.id === storedId))
      ? storedId
      : businesses[0]?.id;

    if (targetId) return <Navigate to={`/business/${targetId}`} replace />;
    return <Navigate to="/businesses" replace />;
  }
  ```

  **Step 4: Restructure route tree.**

  Replace the entire route structure with:

  ```
  <Routes>
    {/* Root redirect */}
    <Route index element={<RootRedirect />} />

    {/* Business management routes (no sidebar layout) */}
    <Route path="/businesses" element={<BusinessListLayout />}>
      <Route index element={<BusinessList />} />
      <Route path="new" element={<CreateBusiness />} />
    </Route>

    {/* Business-scoped routes (with sidebar layout) */}
    <Route path="/business/:businessId" element={<BusinessContextLayout />}>
      <Route index element={<Dashboard />} />
      <Route path="executive-summary" element={<ExecutiveSummary />} />
      <Route path="market-analysis" element={<MarketAnalysis />} />
      <Route path="product-service" element={<ProductService />} />
      <Route path="marketing-strategy" element={<MarketingStrategy />} />
      <Route path="operations" element={<Operations />} />
      <Route path="financial-projections" element={<FinancialProjections />} />
      <Route path="risks-due-diligence" element={<RisksDueDiligence />} />
      <Route path="kpis-metrics" element={<KpisMetrics />} />
      <Route path="launch-plan" element={<LaunchPlan />} />
      <Route path="scenarios" element={<Scenarios />} />
      <Route path="export" element={<Export />} />
    </Route>

    {/* Catch-all: redirect to root */}
    <Route path="*" element={<Navigate to="/" replace />} />
  </Routes>
  ```

  Remove the old conditional `element` on the parent route that checked `businessesLoaded` and `activeBusinessId` — that logic now lives in `BusinessContextLayout` and `RootRedirect`.

  **Step 5: Update `loadBusinesses` in `use-businesses.ts`.**

  Remove the active business ID selection logic from `loadBusinesses`. Currently it reads localStorage and sets `activeBusinessIdAtom` — this is now handled by `BusinessContextLayout`. The function should ONLY:
  1. Fetch businesses from Firestore
  2. Set `businessListAtom`
  3. Set `businessesLoadedAtom(true)`

  Remove the localStorage read and `setActiveBusinessId` call. The `switchBusiness` function should also be simplified — it should ONLY update localStorage (the URL change + `BusinessContextLayout` handles the atom sync). Components that call `switchBusiness` will also navigate to the new URL.

  **Step 6: Update `createNewBusiness` in `use-businesses.ts`.**

  After creating a business and refreshing the list, do NOT call `switchBusiness`. Instead, just return the new business ID. The caller (`CreateBusiness` page) will navigate to `/business/${newId}`.

  Also update `removeBusiness` — after deleting, navigate to `/businesses` (or first remaining business). Since the hook doesn't have access to `navigate`, it should only handle data operations. The caller handles navigation. To support this, `removeBusiness` should:
  1. Delete from Firestore
  2. Remove from local list
  3. Return the remaining businesses (or nothing — let the caller check)

  The `CreateBusiness` component (`src/features/businesses/create-business.tsx`) likely calls `createNewBusiness` and then navigates. Update its navigation target from `/` to `/business/${newId}`.

  **Step 7: Update `BusinessLoader` in `providers.tsx`.**

  The `BusinessLoader` component should remain as-is (it loads the business list on auth). But verify it does NOT set `activeBusinessIdAtom` — that's now the router's job. If `loadBusinesses` was updated in Step 5 to not set the atom, this should work automatically.
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors. Manually verify in browser: navigating to `/business/{validId}/market-analysis` loads the correct business and section. Navigating to `/business/nonexistent` shows error page. `/` redirects to last-used business.</verify>
  <done>
  - URL structure: `/business/:businessId/section-name` for all business-scoped routes
  - `BusinessContextLayout` syncs URL param → `activeBusinessIdAtom` + localStorage
  - `BusinessNotFoundPage` shows for invalid business IDs with link back to `/businesses`
  - Root `/` redirects to last-used business or `/businesses`
  - Old flat routes (`/market-analysis`, `/scenarios`, etc.) completely removed
  - Catch-all route redirects to `/`
  - `loadBusinesses` no longer sets `activeBusinessIdAtom` directly
  - `npx tsc --noEmit` passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sidebar and layout for URL-driven navigation and dynamic section filtering</name>
  <files>src/components/app-sidebar.tsx, src/app/layout.tsx</files>
  <action>
  **Step 1: Update sidebar navigation links.**

  In `src/components/app-sidebar.tsx`:
  - Import `useParams` from `react-router`
  - Get `businessId` from `useParams<{ businessId: string }>()`
  - Change all nav item URLs to include business prefix:
    - `overviewItems`: Dashboard URL becomes `/business/${businessId}`
    - `businessPlanItems`: Each URL becomes `/business/${businessId}/section-slug` (e.g., `/business/${businessId}/executive-summary`)
    - `toolsItems`: Each URL becomes `/business/${businessId}/scenarios`, `/business/${businessId}/export`
  - Convert the hardcoded item arrays to be computed inside the component (or use a function that takes businessId), since URLs are now dynamic.
  - Update the `isActive` helper to match against the dynamic URLs or use `location.pathname.endsWith(slug)` pattern for simpler matching.

  **Step 2: Make sidebar section list dynamic.**

  Filter `businessPlanItems` by the current business's `enabledSections` array:
  - Read `activeBusiness` from `useBusinesses()` (already available in the component)
  - Map the hardcoded `businessPlanItems` array, filtering to only include items whose slug (extracted from URL) is in `activeBusiness.enabledSections`
  - If `activeBusiness` is null (shouldn't happen inside business routes, but guard), show all items as fallback
  - The slug-to-enabledSections mapping: the URL path segment (e.g., `executive-summary`) matches the `enabledSections` values stored on the Business document. Verify these match by checking `business-templates.ts` `defaultSections` arrays.

  **Step 3: Update sidebar business switcher.**

  The business dropdown currently calls `switchBusiness(business.id)`. Since the URL is now the source of truth:
  - Import `useNavigate` from `react-router`
  - Change the dropdown handler from `onClick={() => switchBusiness(business.id)}` to:
    ```
    onClick={() => {
      navigate(`/business/${business.id}`);
    }}
    ```
  - This navigates to the new business's dashboard, which triggers `BusinessContextLayout` to sync the new ID to the atom.
  - The "New Business" link should stay as `/businesses/new`
  - The "All Businesses" link should stay as `/businesses`

  **Step 4: Update layout breadcrumbs.**

  In `src/app/layout.tsx`:
  - Import `useParams` from `react-router`
  - Get `businessId` from `useParams()`
  - The `routeTitles` record needs updating: remove the leading `/` and business prefix from keys. Instead, extract the section slug from the URL (the part after `/business/:id/`) and map it to a title.
  - Approach: compute section slug from `location.pathname` by stripping the `/business/${businessId}/` prefix. If the remaining path is empty (dashboard), title = "Dashboard". Otherwise, look up in a slug→title map.
  - Remove the old flat route entries from `routeTitles` (like `/businesses`, `/businesses/new`) — those pages don't use `DashboardLayout`.
  - Keep the breadcrumb structure: Business Name > Section Title.
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors. Verify sidebar links include business ID in URLs. Verify sidebar only shows sections from `enabledSections`. Verify business switcher navigates to `/business/{newId}`.</verify>
  <done>
  - All sidebar nav links use `/business/${businessId}/section-slug` format
  - Sidebar filters business plan sections by `activeBusiness.enabledSections`
  - Business switcher dropdown navigates to `/business/${newId}` (dashboard)
  - `isActive` correctly highlights the current section in the sidebar
  - Breadcrumbs show "Business Name > Section Title" using URL-derived context
  - Browser back/forward preserves full navigation history across business switches
  - `npx tsc --noEmit` passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] URL structure is `/business/:businessId/section-name` for all business-scoped routes
- [ ] Old flat routes (`/market-analysis` etc.) are completely removed
- [ ] Root `/` redirects to last-used business or `/businesses`
- [ ] Invalid business ID shows error page with link to `/businesses`
- [ ] Sidebar shows only sections from `enabledSections`
- [ ] Business switcher navigates to `/business/:newId`
- [ ] Breadcrumbs display business name and section title
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Every page lives under `/business/:businessId/` URL
- URL is the single source of truth for active business (synced to atom by BusinessContextLayout)
- Dynamic sidebar shows only enabled sections per business
- Browser back/forward works naturally across business switches
- Bookmarkable, shareable URLs for any business section
  </success_criteria>

<output>
After completion, create `.planning/phases/03-dynamic-business-context/03-02-SUMMARY.md`
</output>
