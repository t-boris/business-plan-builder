---
phase: 03-what-if-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [src/features/scenarios/scenario-comparison.tsx, src/features/scenarios/index.tsx, src/features/dashboard/index.tsx, src/store/scenario-atoms.ts, src/store/derived-atoms.ts]
autonomous: true
---

<objective>
Build side-by-side scenario comparison UI and enhance the dashboard overview with live scenario metrics integration.

Purpose: Let users compare different saved scenarios visually — see which scenario produces better revenue, lower costs, higher margins. Also bring scenario awareness to the main dashboard.
Output: Comparison view with visual diffs, dashboard overview with live metrics from active scenario.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-what-if-engine/03-01-SUMMARY.md

Key source files:
@src/store/scenario-atoms.ts
@src/store/derived-atoms.ts
@src/features/scenarios/index.tsx
@src/features/dashboard/index.tsx
@src/lib/firestore.ts
@src/lib/constants.ts
@src/types/scenario.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build side-by-side scenario comparison UI</name>
  <files>src/features/scenarios/scenario-comparison.tsx, src/features/scenarios/index.tsx, src/store/scenario-atoms.ts</files>
  <action>
  1. Create `src/features/scenarios/scenario-comparison.tsx` — comparison view:
     - Allow selecting 2 scenarios to compare (from saved scenario list)
     - Use two Select dropdowns: "Scenario A" and "Scenario B"
     - Load both scenarios' variables from Firestore using `getScenario()`
     - Compute derived metrics for EACH scenario independently:
       - Create a pure function `computeDerivedMetrics(variables: ScenarioVariables): DerivedMetrics` that performs the same calculations as the Jotai derived atoms but without atoms — just pure math
       - This avoids needing to load/swap atom state for comparison
     - Display comparison as a table:
       **Input Variables comparison:**
       | Variable | Scenario A | Scenario B | Diff |
       | Starter Price | $800 | $900 | +$100 |
       | Monthly Leads | 125 | 150 | +25 |
       ... (all ScenarioVariables fields)

       **Derived Metrics comparison:**
       | Metric | Scenario A | Scenario B | Diff | Winner |
       | Monthly Revenue | $24,825 | $29,790 | +$4,965 | B |
       | Monthly Costs | $12,500 | $14,200 | +$1,700 | A |
       | Monthly Profit | $12,325 | $15,590 | +$3,265 | B |
       | Profit Margin | 49.6% | 52.3% | +2.7% | B |
       ... (all DerivedMetrics fields)

     - **Visual diff highlighting:**
       - Diff column: green if improvement (higher revenue/profit, lower costs), red if worse
       - Winner column: badge showing which scenario is better for each metric (A or B)
       - Use bg-green-50/bg-red-50 row highlighting for significant differences (>10%)

     - **Comparison chart:** Recharts BarChart with grouped bars:
       - Categories: Revenue, Costs, Profit, Ad Spend
       - Two bars per category (Scenario A and Scenario B)
       - Different colors per scenario

  2. Add a Tabs component on the Scenarios page to switch between "Editor" (current controls + dashboard) and "Compare" (comparison view):
     - Update `src/features/scenarios/index.tsx` to wrap content in shadcn/ui Tabs
     - Tab 1: "Editor" — the existing scenario controls + dashboard from 03-01
     - Tab 2: "Compare" — the new comparison component
     - Tabs should be at the top, below the scenario manager bar

  3. Add the pure `computeDerivedMetrics()` function:
     - Place in `src/store/derived-atoms.ts` or a new utility file
     - Must produce the EXACT same results as the Jotai derived atoms
     - Takes ScenarioVariables as input, returns DerivedMetrics
     - Uses the same constants (CREW_HOURLY_RATE, AVG_HOURS_PER_EVENT)

  **Do NOT** modify existing Jotai atom values when loading scenarios for comparison — comparison is read-only, uses the pure function.
  **Use Recharts** `BarChart` with `Bar` components for the comparison chart.
  </action>
  <verify>npm run build succeeds. Compare tab shows two scenario selectors, comparison table with diffs, and grouped bar chart.</verify>
  <done>Side-by-side comparison works — select two scenarios, see variable diffs with color coding, derived metric comparison with winner indicators, and bar chart visualization</done>
</task>

<task type="auto">
  <name>Task 2: Enhance dashboard overview with live scenario metrics</name>
  <files>src/features/dashboard/index.tsx, src/store/derived-atoms.ts</files>
  <action>
  1. Replace the placeholder `src/features/dashboard/index.tsx` with a live dashboard overview:
     - Read derived atoms using `useAtomValue()` to show key metrics from the active scenario
     - **KPI Summary Cards** (top row, 4 cards):
       - Monthly Revenue: large number, formatted as currency, green
       - Monthly Profit: large number, formatted as currency, green if positive / red if negative
       - Monthly Bookings: large number
       - Profit Margin: percentage, color-coded (green >20%, amber 10-20%, red <10%)

     - **Secondary Metrics** (second row, 4 smaller cards):
       - Annual Revenue
       - Annual Profit
       - Total Ad Spend
       - CAC per Booking

     - **Active Scenario indicator:** Show current scenario name from `scenarioNameAtom` as a badge/tag in the header, with a link to "/scenarios" for editing

     - **Quick Chart:** Small AreaChart (Recharts, ~200px height) showing revenue projection:
       - 12 months of projected monthly revenue (using current monthlyRevenue value)
       - Simple flat projection line (all months same value based on current scenario)

     - **Section Links:** Grid of 9 cards linking to each business plan section, showing section name + a brief status/summary. Use the existing router paths.

  2. Layout:
     - Heading: "Fun Box Planning Dashboard" with active scenario badge
     - KPI row (4 stat cards, responsive grid)
     - Secondary metrics row
     - Revenue chart
     - Section links grid (3 columns on desktop, 1 on mobile)

  **All metric values come from Jotai derived atoms** — changing scenario variables on the Scenarios page instantly reflects on the dashboard when user navigates back.

  **Do NOT** add edit controls on the dashboard — it's read-only. Editing happens on the Scenarios page.
  </action>
  <verify>npm run build succeeds. Dashboard shows live KPI cards with values from current scenario atoms. Navigating to Scenarios, changing a variable, then back to Dashboard shows updated values.</verify>
  <done>Dashboard overview shows live metrics from active scenario, KPI cards with color coding, revenue chart, and section navigation grid</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Compare tab allows selecting two saved scenarios
- [ ] Comparison table shows variable diffs with color highlighting
- [ ] Comparison bar chart renders grouped bars correctly
- [ ] `computeDerivedMetrics()` produces same results as Jotai atoms
- [ ] Dashboard shows live KPI metrics from active scenario
- [ ] Dashboard updates when scenario variables change
- [ ] Active scenario name displayed on dashboard
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Side-by-side comparison works with visual diffs
- Dashboard overview shows live scenario metrics
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-what-if-engine/03-02-SUMMARY.md`
</output>
