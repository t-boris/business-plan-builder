---
phase: 10-dashboard-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/features/dashboard/index.tsx]
autonomous: true
---

<objective>
Rewrite the dashboard to be genuinely useful for any business type.

Purpose: The dashboard is the landing page for each business. It should show smart KPI cards from computed variables, a dynamic chart that adapts to whatever variables exist, and section links filtered to the business's enabled sections with correct URLs.
Output: A polished, generic dashboard that works for SaaS, restaurant, retail, event, or any business type.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-dashboard-navigation/10-CONTEXT.md

@src/features/dashboard/index.tsx
@src/store/derived-atoms.ts
@src/store/business-atoms.ts
@src/store/scenario-atoms.ts
@src/types/business.ts
@src/components/app-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Smart KPI cards and dynamic chart</name>
  <files>src/features/dashboard/index.tsx</files>
  <action>
  Rewrite the KPI card selection and chart data logic in the Dashboard component:

  **Smart KPI ordering:**

  Replace the naive `computedVariables.slice(0, 4)` approach with priority-based sorting:

  1. Get all computed variables from `businessVariablesAtom`
  2. Sort by relevance:
     - **Priority 1 (currency):** Variables with `unit: 'currency'` — these are the core financials (revenue, costs, profit)
     - **Priority 2 (percent):** Variables with `unit: 'percent'` — margins, ratios
     - **Priority 3 (count/other):** Everything else
  3. Within each priority group, preserve the original definition order (which reflects template design intent)
  4. Take top 4 as primary KPIs (large cards), next 4 as secondary KPIs (small cards)

  Implementation:
  ```typescript
  const unitPriority: Record<VariableUnit, number> = {
    currency: 0,
    percent: 1,
    ratio: 2,
    count: 3,
    months: 4,
    days: 5,
    hours: 6,
  };

  const sortedComputed = [...computedVariables].sort(
    (a, b) => (unitPriority[a.unit] ?? 99) - (unitPriority[b.unit] ?? 99)
  );

  const primaryKpis = sortedComputed.slice(0, 4);
  const secondaryKpis = sortedComputed.slice(4, 8);
  ```

  **Dynamic chart series:**

  Replace the hardcoded `monthly_revenue`/`monthly_costs` lookup with dynamic selection:

  1. From ALL variables (input + computed), find those with `unit: 'currency'` — these are the financials worth charting
  2. Take up to 3 currency-type variables for chart series (too many makes the chart unreadable)
  3. Assign colors from a predefined palette based on semantic label matching:
     - Revenue-like (label contains "revenue" or "income" or "sales"): green `#22c55e`
     - Cost-like (label contains "cost" or "expense" or "spend"): orange `#f97316`
     - Profit-like (label contains "profit" or "net" or "margin"): blue `#3b82f6`
     - Default: slate `#64748b`
  4. Build 12-month flat projection from evaluated values (same approach as current, but for dynamic series)
  5. Update chart title dynamically: "12-Month Financial Projection" (generic, not "Revenue Projection")

  If no currency variables exist, hide the chart section entirely.

  **Empty state:**

  If `businessVariablesAtom` is null or has no computed variables, show a helpful empty state instead of blank space:
  ```tsx
  <Card>
    <CardContent className="py-8 text-center">
      <p className="text-muted-foreground">
        No scenario variables configured yet.
      </p>
      <Button variant="link" asChild>
        <Link to={`/business/${businessId}/scenarios`}>
          Configure Scenarios
        </Link>
      </Button>
    </CardContent>
  </Card>
  ```

  Need to read `businessId` from `useParams` or from `activeBusinessIdAtom` for the link.

  **Currency formatting:**

  Update `formatCurrency` to use the business profile's currency if available. Read from `activeBusinessAtom`:
  ```typescript
  const business = useAtomValue(activeBusinessAtom);
  const currencyCode = business?.profile.currency ?? 'USD';
  ```

  Pass `currencyCode` to `formatCurrency` and the chart tooltip formatter.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify KPI cards appear sorted by unit priority. Verify chart dynamically shows currency variables. Verify empty state shows when no variables exist.</verify>
  <done>KPIs sorted by relevance (currency first, then percent, then count). Chart dynamically picks currency variables with semantic colors. Empty state when no variables. Currency from business profile.</done>
</task>

<task type="auto">
  <name>Task 2: Filter section links by enabled sections with business-scoped URLs</name>
  <files>src/features/dashboard/index.tsx</files>
  <action>
  Fix the "Business Plan Sections" grid at the bottom of the dashboard:

  **Filter by enabled sections:**

  1. Import `activeBusinessAtom` from `@/store/business-atoms` (may already be imported from Task 1)
  2. Read `const business = useAtomValue(activeBusinessAtom);`
  3. Filter `SECTION_LINKS` by `business.enabledSections`:
     ```typescript
     const enabledLinks = useMemo(() => {
       if (!business) return SECTION_LINKS;
       return SECTION_LINKS.filter((s) =>
         business.enabledSections.includes(s.url.replace('/', ''))
       );
     }, [business]);
     ```

  Note: `SECTION_LINKS[i].url` is like `/executive-summary`. Strip the leading `/` to get the slug, then check against `enabledSections`.

  **Business-scoped URLs:**

  The current links use relative paths like `/executive-summary`. These need to be prefixed with `/business/${businessId}/`:

  1. Read `businessId` from `activeBusinessIdAtom` (or derive from `business.id`)
  2. Update the Link `to` prop:
     ```tsx
     <Link to={`/business/${businessId}${section.url}`}>
     ```

  Also update the scenario badge link at the top from `to="/scenarios"` to `to={`/business/${businessId}/scenarios`}`.

  **Hide section links for empty state:**

  If no sections are enabled (unlikely but possible), hide the section links grid entirely. Only show it when `enabledLinks.length > 0`.

  Run `npm run build` after changes to verify production build succeeds.
  </action>
  <verify>Run `npx tsc --noEmit` and `npm run build`. Verify section links are filtered by enabledSections. Verify all links include `/business/${businessId}/` prefix. Verify scenario badge link is business-scoped.</verify>
  <done>Section links filtered by enabled sections. All URLs business-scoped. Scenario badge link scoped. Build passes.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] KPI cards sorted by unit priority (currency → percent → other)
- [ ] Chart dynamically shows currency-type variables with semantic colors
- [ ] Chart hidden when no currency variables exist
- [ ] Empty state shown when no computed variables exist
- [ ] Section links filtered by `enabledSections`
- [ ] All dashboard links include `/business/${businessId}/` prefix
- [ ] Currency formatting uses business profile currency
</verification>

<success_criteria>

- Dashboard KPIs are smart and relevant for any business type
- Chart adapts to whatever variables the business has
- Section links respect enabled sections configuration
- All navigation within dashboard uses business-scoped URLs
- Empty states handled gracefully
- Full TypeScript compilation and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-dashboard-navigation/10-01-SUMMARY.md`
</output>
