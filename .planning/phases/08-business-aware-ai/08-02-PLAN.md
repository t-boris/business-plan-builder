---
phase: 08-business-aware-ai
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified: [src/lib/ai/section-prompts.ts, src/hooks/use-ai-suggestion.ts, src/lib/ai/system-prompt.ts]
autonomous: true
---

<objective>
Add industry-specific section prompt overlays and wire the AI consumer to use the dynamic system prompt and business context.

Purpose: Complete the business-aware AI integration. After this plan, different business types get fundamentally different AI guidance — a SaaS market analysis focuses on TAM/SAM while a restaurant analysis focuses on foot traffic. The AI uses real numbers from the active scenario and knows the business profile.
Output: Industry overlays for 4 key sections, `use-ai-suggestion.ts` wired with dynamic system prompt and BusinessProfile.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-business-aware-ai/08-RESEARCH.md
@.planning/phases/08-business-aware-ai/08-CONTEXT.md
@.planning/phases/08-business-aware-ai/08-01-SUMMARY.md

@src/lib/ai/section-prompts.ts
@src/lib/ai/context-builder.ts
@src/lib/ai/system-prompt.ts
@src/lib/ai/industry-config.ts
@src/hooks/use-ai-suggestion.ts
@src/store/business-atoms.ts
@src/types/business.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add industry overlays to section-prompts.ts</name>
  <files>src/lib/ai/section-prompts.ts</files>
  <action>
  **Add `INDUSTRY_OVERLAYS` map** after the existing `SECTION_PROMPTS` constant.

  Import `BusinessType` from `@/types/business`.

  Define overlays for 4 key sections where business type fundamentally changes the AI's focus. Only the `generate` action needs overlays — `improve` and `expand` work on existing data and don't need business-type-specific guidance.

  ```typescript
  const INDUSTRY_OVERLAYS: Partial<Record<BusinessType, Partial<Record<SectionSlug, string>>>> = {
    saas: {
      'market-analysis': 'Focus on: TAM/SAM/SOM with bottom-up and top-down estimates. Competitor analysis should include pricing tiers, feature comparison matrix, funding status, and market positioning. Include technology adoption lifecycle stage. Address switching costs and lock-in factors. Demographics should focus on company size segments, industry verticals, and buying committee roles.',
      'financial-projections': 'Emphasize SaaS-specific metrics: MRR/ARR growth trajectory, churn rate (logo and revenue), LTV:CAC ratio, months to payback, net revenue retention, expansion revenue. Model cohort-based revenue patterns rather than simple linear growth.',
      operations: 'Focus on: engineering team structure, sprint velocity, cloud infrastructure costs by tier, customer support staffing ratios, deployment pipeline. Cost breakdown should emphasize cloud infrastructure, third-party APIs, developer tooling, and customer success headcount.',
      'marketing-strategy': 'Focus on: content marketing and SEO, product-led acquisition funnels, free trial/freemium conversion rates, developer relations if applicable. Consider inbound vs outbound mix. CAC should be broken down by channel.',
    },
    restaurant: {
      'market-analysis': 'Focus on: location-specific foot traffic data, nearby anchor tenants, parking availability, delivery radius and third-party delivery platform presence (DoorDash, UberEats). Competitor analysis should include seating capacity, average ticket, Yelp/Google ratings, cuisine overlap, and peak hour patterns. Demographics should focus on daytime vs evening population, household income, dining-out frequency.',
      'financial-projections': 'Emphasize restaurant-specific metrics: food cost percentage (target 28-32%), labor cost percentage (target 25-30%), prime cost, revenue per available seat hour (RevPASH), average covers per day. Model seasonal variations in covers if the location has tourism patterns.',
      operations: 'Focus on: kitchen layout and stations, FOH/BOH staffing by shift, food cost percentage targets, inventory turnover, prep schedules, health code compliance, and vendor relationships. Cost breakdown should emphasize food cost, labor, rent, utilities, POS system, and waste reduction.',
      'marketing-strategy': 'Focus on: local SEO and Google Business Profile optimization, delivery platform presence and commission impact, review management strategy (Yelp/Google), loyalty programs, community events. Emphasize cost-per-cover acquisition.',
    },
    retail: {
      'market-analysis': 'Focus on: trade area analysis, foot traffic patterns and peak hours, anchor tenant proximity, online-to-offline conversion potential, seasonal demand curves. Competitor analysis should include price positioning, product assortment overlap, store formats, and loyalty programs. Demographics should focus on household income, spending patterns by category.',
      'financial-projections': 'Emphasize retail-specific metrics: inventory turnover rate, gross margin return on investment (GMROI), sell-through rate, average transaction value (ATV), markdown strategy impact. Model seasonal revenue patterns by quarter.',
      operations: 'Focus on: store layout and merchandising zones, staffing by shift and season, inventory management and reorder points, POS systems, loss prevention, seasonal staffing plans. Cost breakdown should emphasize COGS, labor, rent, shrinkage, and logistics.',
      'marketing-strategy': 'Focus on: foot traffic driving tactics, seasonal promotions calendar, loyalty program design, omnichannel attribution (online-to-store, store-to-online), local advertising. Emphasize cost-per-transaction acquisition.',
    },
    service: {
      'market-analysis': 'Focus on: serviceable market by geography/specialty, client acquisition channels, referral network potential, competitive landscape by specialization. Demographics should focus on target client profiles (B2B: company size and industry; B2C: income and life stage).',
      'financial-projections': 'Emphasize service-specific metrics: utilization rate, average billable rate, revenue per employee, client lifetime value, project profitability. Model capacity constraints and growth scenarios.',
      operations: 'Focus on: team structure and specializations, capacity planning and utilization targets, service delivery workflow, quality assurance processes, client communication cadence. Cost breakdown should emphasize labor (largest cost), professional development, tools/software, and insurance.',
      'marketing-strategy': 'Focus on: referral programs, professional networking, thought leadership content, case studies and testimonials, partnership channels. Emphasize cost-per-client acquisition and client retention rates.',
    },
    event: {
      'market-analysis': 'Focus on: event market by type and season, venue availability and pricing, local competition for similar events, seasonal demand patterns. Demographics should focus on target attendee profiles, corporate vs consumer segments, willingness to pay.',
      'financial-projections': 'Emphasize event-specific metrics: per-event revenue and cost, capacity utilization, booking lead time, seasonal revenue distribution, break-even number of events per month. Model seasonal curves explicitly.',
      operations: 'Focus on: event logistics and setup/teardown, staffing per event type, equipment inventory and maintenance, venue partnerships, safety protocols and insurance. Cost breakdown should emphasize per-event variable costs vs monthly fixed overhead.',
      'marketing-strategy': 'Focus on: social media and visual marketing, event listing platforms, partnership and cross-promotion, early-bird and group pricing strategies, email marketing for repeat clients. Emphasize booking conversion rate from inquiries.',
    },
    manufacturing: {
      'market-analysis': 'Focus on: supply chain geography, raw material sourcing and pricing trends, trade regulations and tariffs, capacity utilization benchmarks in the industry. Competitor analysis should include production capabilities, quality certifications, and pricing models (cost-plus vs market-based).',
      'financial-projections': 'Emphasize manufacturing-specific metrics: unit COGS breakdown (materials, labor, overhead), yield rate, capacity utilization impact on unit cost, raw material cost sensitivity analysis. Model production ramp-up scenarios.',
      operations: 'Focus on: production line layout, shift scheduling and labor planning, quality control checkpoints, equipment maintenance schedules, supplier management and lead times. Cost breakdown should emphasize raw materials, direct labor, manufacturing overhead, and logistics.',
      'marketing-strategy': 'Focus on: trade shows and industry events, B2B sales cycle and pipeline management, distributor/channel partner relationships, technical documentation and specs, certifications as marketing leverage. Emphasize customer acquisition cost for B2B sales.',
    },
  };
  ```

  Note: `custom` type has no overlays — base prompts are used as-is.

  **Update `getSectionPrompt()` to accept optional `businessType`:**

  Change signature from:
  ```typescript
  export function getSectionPrompt(slug: SectionSlug, action: AiAction): string
  ```

  To:
  ```typescript
  export function getSectionPrompt(slug: SectionSlug, action: AiAction, businessType?: BusinessType): string
  ```

  Implementation:
  ```typescript
  const base = SECTION_PROMPTS[slug][action];
  if (!businessType || businessType === 'custom' || action !== 'generate') return base;
  const overlay = INDUSTRY_OVERLAYS[businessType]?.[slug];
  if (!overlay) return base;
  return `${base}\n\nINDUSTRY-SPECIFIC FOCUS (${businessType}):\n${overlay}`;
  ```

  Only `generate` action gets overlays. `improve` and `expand` work on existing data.
  </action>
  <verify>Grep for `INDUSTRY_OVERLAYS` in section-prompts.ts. Grep for `businessType` in getSectionPrompt. Verify the function signature includes the optional third parameter. Run `npx tsc --noEmit`.</verify>
  <done>6 business types have overlays for 4 sections each. getSectionPrompt accepts optional businessType. Generate action appends industry-specific overlay. Improve/expand actions unchanged. TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Wire use-ai-suggestion.ts with dynamic system prompt and business context</name>
  <files>src/hooks/use-ai-suggestion.ts, src/lib/ai/system-prompt.ts, src/lib/ai/context-builder.ts</files>
  <action>
  **Update `src/hooks/use-ai-suggestion.ts`:**

  This is the SINGLE consumer of all AI functions. It currently:
  - Imports `SYSTEM_INSTRUCTION` from system-prompt.ts
  - Calls `buildPrompt({ sectionSlug, action, userInstruction }, sectionData, evaluated)`
  - Passes `SYSTEM_INSTRUCTION` to generate functions

  Change to:

  1. **Replace imports:**
     - Remove: `import { SYSTEM_INSTRUCTION } from '@/lib/ai/system-prompt'`
     - Add: `import { buildSystemPrompt } from '@/lib/ai/system-prompt'`
     - Add: `import { activeBusinessAtom, businessVariablesAtom } from '@/store/business-atoms'`

  2. **Read business context in the hook:**
     ```typescript
     const business = useAtomValue(activeBusinessAtom);
     const variableDefinitions = useAtomValue(businessVariablesAtom);
     ```

  3. **Update the `generate` callback:**

     Build dynamic system prompt:
     ```typescript
     const profile = business?.profile ?? null;
     const systemInstruction = buildSystemPrompt(profile ?? {
       name: '', type: 'custom', industry: '', location: '', description: '', currency: 'USD'
     });
     ```

     Update `buildPrompt` call to pass profile, variable definitions, and businessType:
     ```typescript
     const prompt = buildPrompt(
       { sectionSlug, action, userInstruction },
       profile,
       sectionData,
       evaluated,
       variableDefinitions ?? undefined,
     );
     ```

     Replace `SYSTEM_INSTRUCTION` with `systemInstruction` in both generate calls:
     ```typescript
     result = await generateStructuredContent<T>(prompt, systemInstruction, schema);
     // and
     const text = await generateSectionContent(prompt, systemInstruction);
     ```

  4. **Update `useCallback` dependencies:**
     Add `business` and `variableDefinitions` to the dependency array of `generate`.

  **Update `src/lib/ai/context-builder.ts`** — pass `businessType` to `getSectionPrompt()`:

  In `buildPrompt()`, extract `businessType` from the profile parameter and pass it to `getSectionPrompt`:

  ```typescript
  const taskInstruction = getSectionPrompt(config.sectionSlug, config.action, profile?.type);
  ```

  Update the `getSectionPrompt` import to include `BusinessType` type if needed by the call.

  **Update `src/lib/ai/system-prompt.ts`** — remove the backwards-compatible `SYSTEM_INSTRUCTION` export:

  Now that the consumer is wired, delete the temporary `export const SYSTEM_INSTRUCTION = ...` fallback added in Plan 08-01. Only `buildSystemPrompt` should be exported.

  Verify no other file imports `SYSTEM_INSTRUCTION` by grepping. If any do, update them too.
  </action>
  <verify>Run `npx tsc --noEmit` — must compile cleanly. Run `npm run build` — must succeed. Grep for `SYSTEM_INSTRUCTION` across entire codebase — should appear NOWHERE except possibly in comments. Grep for `buildSystemPrompt` in use-ai-suggestion.ts. Grep for `activeBusinessAtom` in use-ai-suggestion.ts. Grep for `profile?.type` in context-builder.ts.</verify>
  <done>use-ai-suggestion.ts reads active business profile and variable definitions from Jotai atoms. Dynamic system prompt generated per-request from business profile. buildPrompt receives profile and variable definitions. context-builder passes businessType to getSectionPrompt for industry overlays. No references to old SYSTEM_INSTRUCTION constant. Full build passes.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] No references to `SYSTEM_INSTRUCTION` constant anywhere in codebase
- [ ] `getSectionPrompt` accepts businessType parameter
- [ ] Industry overlays exist for saas, restaurant, retail, service, event, manufacturing (6 types × 4 sections)
- [ ] `use-ai-suggestion.ts` imports `buildSystemPrompt` and `activeBusinessAtom`
- [ ] `context-builder.ts` passes `profile?.type` to `getSectionPrompt`
- [ ] Changing business type produces different system prompts and section overlays
</verification>

<success_criteria>

- 6 business types have industry-specific overlays for 4 key sections
- use-ai-suggestion.ts wired with dynamic system prompt from business profile
- Business profile, variable definitions, and evaluated metrics flow through to prompts
- No static SYSTEM_INSTRUCTION constant remains
- Full TypeScript compilation and build pass
- Phase 8 complete: AI is business-aware
</success_criteria>

<output>
After completion, create `.planning/phases/08-business-aware-ai/08-02-SUMMARY.md`
</output>
