---
phase: 08-business-aware-ai
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/ai/industry-config.ts, src/lib/ai/system-prompt.ts, src/lib/ai/context-builder.ts, src/lib/ai/gemini-client.ts]
autonomous: true
---

<objective>
Create the dynamic AI infrastructure: industry configuration, business-aware system prompt builder, context-aware prompt assembly, and Gemini 3 model upgrade.

Purpose: Replace the static, generic AI prompt system with one that dynamically adapts to the active business's type, profile, and scenario data. This is the foundation for business-aware AI — after this plan, the AI knows what kind of business it's advising and uses real numbers.
Output: Dynamic `buildSystemPrompt(profile)`, updated `buildPrompt()` with BusinessProfile parameter, industry configs for all 7 business types, Gemini 3 model upgrade.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-business-aware-ai/08-RESEARCH.md
@.planning/phases/08-business-aware-ai/08-CONTEXT.md

@src/lib/ai/system-prompt.ts
@src/lib/ai/context-builder.ts
@src/lib/ai/gemini-client.ts
@src/lib/ai/section-prompts.ts
@src/types/business.ts
@src/store/business-atoms.ts
@src/store/derived-atoms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create industry-config.ts and rewrite system-prompt.ts</name>
  <files>src/lib/ai/industry-config.ts, src/lib/ai/system-prompt.ts</files>
  <action>
  **Create `src/lib/ai/industry-config.ts`:**

  Define an `IndustryConfig` interface and a `INDUSTRY_CONFIGS` record covering all 7 `BusinessType` values:

  ```typescript
  interface IndustryConfig {
    role: string;           // Expert persona description
    vocabulary: string[];   // Industry-standard terms the AI should use
  }
  ```

  Populate configs for each BusinessType. Use the role descriptions and vocabulary from RESEARCH.md Section 4:

  | BusinessType | Role essence | Key vocabulary |
  |-------------|-------------|----------------|
  | saas | SaaS business strategist — recurring revenue, churn, PLG | MRR, ARR, churn, NRR, LTV:CAC, expansion revenue, PLG, seats |
  | restaurant | Restaurant industry consultant — food service, location, hospitality | covers, ticket average, food cost %, labor cost %, table turns, RevPASH, prime cost |
  | retail | Retail business advisor — inventory, foot traffic, omnichannel | SKU, sell-through rate, GMROI, shrinkage, planogram, basket size, ATV |
  | service | Service business consultant — capacity, acquisition, delivery | utilization rate, billable hours, client retention, service delivery SLA |
  | event | Event business strategist — seasonal demand, venue logistics, experiential | per-event cost, capacity utilization, seasonal demand curve, booking lead time |
  | manufacturing | Manufacturing consultant — supply chain, production, quality | BOM, COGS, yield rate, OEE, lead time, WIP, safety stock |
  | custom | General business plan writer and strategic advisor | (empty array) |

  Export: `IndustryConfig` type and `INDUSTRY_CONFIGS` record.

  **Rewrite `src/lib/ai/system-prompt.ts`:**

  Replace the static `SYSTEM_INSTRUCTION` string export with a `buildSystemPrompt(profile: BusinessProfile)` function.

  Import `BusinessProfile` from `@/types/business` and `INDUSTRY_CONFIGS` from `./industry-config`.

  The function builds a system prompt string with this structure:

  ```
  ROLE: {config.role}

  BUSINESS CONTEXT:
  Name: {profile.name}
  Type: {profile.type}
  Industry: {profile.industry}
  Location: {profile.location}
  Description: {profile.description}

  [If vocabulary.length > 0:]
  DOMAIN EXPERTISE:
  Use industry-standard terminology where appropriate: {vocabulary.join(', ')}

  TONE:
  - Professional but approachable
  - Data-driven: reference specific numbers from the provided metrics
  - Concise: use bullet points and short paragraphs
  - Actionable: every recommendation should be implementable

  CONSTRAINTS:
  - Never invent financial numbers. Use ONLY the data provided in scenario metrics.
  - When data is missing, explicitly say "Data needed:" followed by what is required.
  - All monetary values in {profile.currency}.
  - Reference actual values (e.g., "$50k/mo" not "your revenue").

  OUTPUT FORMAT:
  - Return structured JSON matching the provided schema when a schema is specified.
  - Use markdown formatting within text fields (bold, bullets, headers).
  - Keep individual text fields under 500 words unless specifically asked to expand.
  ```

  **Do NOT** keep the old `SYSTEM_INSTRUCTION` export — it will be replaced by `buildSystemPrompt()` in the consumer (Plan 08-02). For now, also export a backwards-compatible `SYSTEM_INSTRUCTION` as a placeholder so TypeScript doesn't break before 08-02 wires the consumer. Use: `export const SYSTEM_INSTRUCTION = buildSystemPrompt({ name: '', type: 'custom', industry: '', location: '', description: '', currency: 'USD' })`.

  This temporary fallback ensures no build break between plans.
  </action>
  <verify>Grep for `INDUSTRY_CONFIGS` in industry-config.ts — should have all 7 BusinessType keys. Grep for `buildSystemPrompt` in system-prompt.ts. Run `npx tsc --noEmit` to verify no type errors.</verify>
  <done>industry-config.ts exports IndustryConfig type and INDUSTRY_CONFIGS with 7 business types. system-prompt.ts exports buildSystemPrompt(profile) function. Backwards-compatible SYSTEM_INSTRUCTION still exported. TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite context-builder.ts and update gemini-client.ts model</name>
  <files>src/lib/ai/context-builder.ts, src/lib/ai/gemini-client.ts</files>
  <action>
  **Rewrite `src/lib/ai/context-builder.ts`:**

  Update `buildPrompt()` signature to accept `BusinessProfile` and `VariableDefinition[]` (for metric formatting):

  ```typescript
  export function buildPrompt(
    config: {
      sectionSlug: SectionSlug;
      action: 'generate' | 'improve' | 'expand';
      userInstruction?: string;
    },
    profile: BusinessProfile | null,
    sectionData: unknown,
    scenarioMetrics: Record<string, number>,
    variableDefinitions?: Record<string, VariableDefinition>,
  ): string
  ```

  **Replace `buildBusinessOverview()`** with `buildBusinessProfile(profile: BusinessProfile | null)`:
  - If profile is null: return `"Business profile not configured."` (graceful fallback)
  - Otherwise:
    ```
    Name: {profile.name}
    Type: {profile.type}
    Industry: {profile.industry}
    Location: {profile.location}
    Description: {profile.description}
    ```

  **Update `buildScenarioContext()`** to accept optional `variableDefinitions` and format values with units:
  ```typescript
  export function buildScenarioContext(
    metrics: Record<string, number>,
    variableDefinitions?: Record<string, VariableDefinition>,
  ): string
  ```
  For each metric key:
  - Look up the variable definition to get `unit` and `label`
  - Format: currency → `$${value.toLocaleString()}`, percent → `${(value * 100).toFixed(1)}%`, count → `${Math.round(value).toLocaleString()}`
  - Use `label` if found, otherwise derive from key (existing `replace(/_/g, ' ')` pattern)
  - Prefix the block with: `"These are ACTUAL calculated scenario values. Use these exact numbers, do not estimate or round:"`

  **Update XML structure** in `buildPrompt()`:
  ```xml
  <business_profile>
  {buildBusinessProfile(profile)}
  </business_profile>

  <scenario_metrics>
  {buildScenarioContext(scenarioMetrics, variableDefinitions)}
  </scenario_metrics>

  <current_section slug="{config.sectionSlug}">
  {buildSectionContext(config.sectionSlug, sectionData)}
  </current_section>

  <task>
  {taskInstruction}
  [if userInstruction: Additional instruction: {userInstruction}]
  </task>
  ```

  Note the `slug` attribute on `<current_section>` — helps the model identify what it's working on.

  **Keep `getSectionPrompt()` call as-is** — Plan 08-02 will update section-prompts.ts and the call site.

  **Update `src/lib/ai/gemini-client.ts`:**

  Change `const MODEL = 'gemini-2.5-flash'` to `const MODEL = 'gemini-3-flash-preview'`.

  No other changes to gemini-client.ts.
  </action>
  <verify>Run `npx tsc --noEmit` — must compile cleanly. Grep for `buildBusinessProfile` in context-builder.ts. Grep for `gemini-3-flash-preview` in gemini-client.ts. Verify `buildPrompt` signature includes `profile: BusinessProfile | null`.</verify>
  <done>context-builder.ts accepts BusinessProfile and variable definitions, formats metrics with units, uses XML structure with business_profile tag. gemini-client.ts uses gemini-3-flash-preview. TypeScript compiles. No build break because SYSTEM_INSTRUCTION fallback still exported.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] industry-config.ts has all 7 BusinessType configs
- [ ] buildSystemPrompt(profile) generates business-type-specific system prompts
- [ ] buildPrompt() accepts BusinessProfile parameter
- [ ] Scenario metrics are formatted with units (currency, percent, count)
- [ ] MODEL is 'gemini-3-flash-preview'
- [ ] Backwards-compatible SYSTEM_INSTRUCTION export exists (prevents consumer break)
</verification>

<success_criteria>

- Dynamic system prompt builder creates business-type-specific prompts
- Context builder injects real business profile data into prompts
- Scenario metrics formatted with units (not raw numbers)
- Gemini 3 Flash Preview model configured
- Full TypeScript compilation passes
- No breaking changes to existing consumers (SYSTEM_INSTRUCTION fallback)
</success_criteria>

<output>
After completion, create `.planning/phases/08-business-aware-ai/08-01-SUMMARY.md`
</output>
