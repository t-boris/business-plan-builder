rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Templates: read-only for authenticated users ---
    match /templates/{templateId} {
      allow read: if request.auth != null;
      allow write: if false;  // Admin-only via Firebase Admin SDK
    }

    // --- Businesses: role-based access via roles map ---
    match /businesses/{businessId} {

      // Helper: check if user has one of the specified roles
      function hasRole(roles) {
        return request.auth != null
          && request.auth.uid in resource.data.roles
          && resource.data.roles[request.auth.uid] in roles;
      }

      // Any authenticated user can create a business (they become owner)
      allow create: if request.auth != null
        && request.resource.data.roles[request.auth.uid] == 'owner';

      // Owner and editor can read
      allow read: if hasRole(['owner', 'editor']);

      // Owner and editor can update
      allow update: if hasRole(['owner', 'editor']);

      // Only owner can delete
      allow delete: if hasRole(['owner']);

      // --- Sections: inherit access from parent business ---
      match /sections/{sectionKey} {
        allow read: if get(/databases/$(database)/documents/businesses/$(businessId))
                       .data.roles[request.auth.uid] in ['owner', 'editor'];
        allow write: if get(/databases/$(database)/documents/businesses/$(businessId))
                        .data.roles[request.auth.uid] in ['owner', 'editor'];
      }

      // --- Scenarios: inherit access from parent business ---
      match /scenarios/{scenarioId} {
        allow read: if get(/databases/$(database)/documents/businesses/$(businessId))
                       .data.roles[request.auth.uid] in ['owner', 'editor'];
        allow write: if get(/databases/$(database)/documents/businesses/$(businessId))
                        .data.roles[request.auth.uid] in ['owner', 'editor'];
      }

      // --- Business state/preferences ---
      match /state/{stateDoc} {
        allow read: if get(/databases/$(database)/documents/businesses/$(businessId))
                       .data.roles[request.auth.uid] in ['owner', 'editor'];
        allow write: if get(/databases/$(database)/documents/businesses/$(businessId))
                        .data.roles[request.auth.uid] in ['owner', 'editor'];
      }
    }

    // --- Users: own profile only ---
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Invites: owner creates, invited user reads/accepts ---
    match /invites/{inviteId} {
      // Anyone authenticated can read an invite (they need the token/ID to find it)
      allow read: if request.auth != null;

      // Only business owner can create invites
      // (validated by checking the business document's roles)
      allow create: if request.auth != null;

      // Update for acceptance (by the invited user)
      allow update: if request.auth != null;

      // Only creator can delete/revoke
      allow delete: if request.auth != null
        && resource.data.createdBy == request.auth.uid;
    }

    // --- Legacy: keep existing plans path working until Phase 3 migration ---
    match /plans/{planId}/{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
